import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import apiClient from '../config/api';
import toast from 'react-hot-toast';
import { loadDraftProject, deleteDraftProject } from '../utils/draftStorage';
import { getErrorMessage, handleError } from '../utils/errorHandler';
import { sanitizeObject } from '../utils/security';
import { CheckCircle, XCircle, Edit, ArrowLeft, Send, Menu, LogOut, X, Loader } from 'lucide-react';
import { useAuth } from '../context/AuthContext';
import Sidebar from '../components/Sidebar';
import useSidebarWidth from '../hooks/useSidebarWidth';
import '../styles/ProjectConfirmation.css';
import '../styles/Sidebar.css';

const ProjectConfirmation = () => {
  const navigate = useNavigate();
  const { user, hasPermission, logout } = useAuth();
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const sidebarWidth = useSidebarWidth(sidebarOpen);
  const [projectData, setProjectData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [showPublishResultsModal, setShowPublishResultsModal] = useState(false);
  const [publishResults, setPublishResults] = useState(null);

  useEffect(() => {
    const loadData = async () => {
      try {
        const data = await loadDraftProject();
        if (data) {
          setProjectData(data);
        } else {
          toast.error('No project data found. Please start over.');
          navigate('/setup');
        }
      } catch (error) {
        const errorMessage = handleError(error, 'ProjectConfirmation - loadProjectData');
        toast.error(errorMessage);
        navigate('/setup');
      }
    };
    loadData();
  }, [navigate]);

  const handleEdit = () => {
    navigate('/setup');
  };

  const handlePublish = async () => {
    if (!hasPermission('create_project')) {
      toast.error('You do not have permission to publish projects');
      return;
    }

    setSubmitting(true);
    try {
      // Convert all inputs to JSON format
      // Include ALL fields from projectData - only skip undefined and internal metadata fields
      const cleanedProjectData = {};
      
      // Copy ALL fields from projectData (don't filter out empty strings or null values)
      Object.keys(projectData).forEach(key => {
        const value = projectData[key];
        // Only skip undefined values - include everything else (null, empty strings, etc.)
        if (value !== undefined) {
          // For strings, trim whitespace but keep even empty strings
          if (typeof value === 'string') {
            cleanedProjectData[key] = value.trim();
          }
          // For all other types, keep as is
          else {
            cleanedProjectData[key] = value;
          }
        }
      });

      // Ensure all required fields are present (set defaults if missing)
      // But don't overwrite existing values with empty strings
      const requiredFields = {
        projectName: cleanedProjectData.projectName || 'New Project',
        shortProjectName: cleanedProjectData.shortProjectName || '',
        contributorProjectName: cleanedProjectData.contributorProjectName || cleanedProjectData.projectName || 'New Project',
        appenPartner: cleanedProjectData.appenPartner || '',
        projectType: cleanedProjectData.projectType || '',
        projectPriority: cleanedProjectData.projectPriority || 50.0,
        account: cleanedProjectData.account || '',
        hireStartDate: cleanedProjectData.hireStartDate || '',
        predictedCloseDate: cleanedProjectData.predictedCloseDate || '',
        projectStatus: cleanedProjectData.projectStatus || null,
        // Only set projectManager to empty string if it doesn't exist, don't overwrite existing value
        projectManager: cleanedProjectData.projectManager !== undefined ? cleanedProjectData.projectManager : '',
        projectPaymentMethod: cleanedProjectData.projectPaymentMethod || ''
      };

      // Merge required fields with cleaned data
      // cleanedProjectData takes precedence to preserve actual values
      const finalProjectData = {
        ...requiredFields,
        ...cleanedProjectData  // This ensures actual values override defaults
      };

      // Remove ONLY internal metadata fields that shouldn't be sent to Salesforce
      // Keep ALL form data fields (including empty strings, null, etc.)
      const internalFields = [
        'id', 'createdAt', 'createdBy', 'updatedAt', 'updatedBy',
        'salesforceId', 'salesforceSyncStatus', 'salesforceObjectType',
        'salesforceSyncedAt', 'salesforceSyncError'
      ];
      
      internalFields.forEach(field => {
        delete finalProjectData[field];
      });

      // Explicitly ensure projectManager ID and name are included
      // (they should already be included, but this ensures they're there)
      if (projectData.projectManager !== undefined) {
        finalProjectData.projectManager = projectData.projectManager;
      }
      if (projectData.projectManagerName !== undefined) {
        finalProjectData.projectManagerName = projectData.projectManagerName;
      }
      
      // Explicitly ensure teamMembers are included with both name and ID
      if (projectData.teamMembers !== undefined && Array.isArray(projectData.teamMembers)) {
        finalProjectData.teamMembers = projectData.teamMembers.map(tm => ({
          member: tm.member || '', // Name
          memberId: tm.memberId || '', // ID
          role: tm.role || '--None--'
        }));
      }
      
      // Include all People section fields explicitly
      const peopleFields = [
        'programManager', 'qualityLead', 'productivityLead', 'reportingLead',
        'invoicingLead', 'projectSupportLead', 'recruitmentLead', 
        'qualificationLead', 'onboardingLead'
      ];
      
      peopleFields.forEach(field => {
        if (projectData[field] !== undefined) {
          finalProjectData[field] = projectData[field];
        }
      });

      // Log the data being sent (for debugging)
      console.log('Publishing project to Salesforce with data:', {
        totalFields: Object.keys(finalProjectData).length,
        fields: Object.keys(finalProjectData),
        sampleData: {
          projectName: finalProjectData.projectName,
          contributorProjectName: finalProjectData.contributorProjectName,
          projectType: finalProjectData.projectType,
          projectStatus: finalProjectData.projectStatus,
          projectManager: finalProjectData.projectManager,
          teamMembers: finalProjectData.teamMembers,
          teamMembersCount: finalProjectData.teamMembers ? finalProjectData.teamMembers.length : 0
        },
        projectManagerValue: finalProjectData.projectManager,
        teamMembersValue: finalProjectData.teamMembers,
        jsonData: JSON.stringify(finalProjectData, null, 2)
      });

      // Sanitize data before sending to server
      const sanitizedData = sanitizeObject(finalProjectData);
      
      // Call Salesforce project creation API directly
      const response = await apiClient.post('/salesforce/create-project', sanitizedData, {
        timeout: 300000 // 5 minutes timeout for long-running requests
      });

      // Check if Salesforce creation was successful
      if (response.data.success) {
        const projectName = response.data.objectName || projectData?.projectName || projectData?.name || 'Project';
        setPublishResults({
          published: [{
            type: 'Project',
            name: projectName,
            id: response.data.salesforceId
          }],
          failed: []
        });
        setShowPublishResultsModal(true);
        console.log('Salesforce project created:', {
          salesforceId: response.data.salesforceId,
          objectType: response.data.objectType,
          objectName: response.data.objectName
        });
        await deleteDraftProject();
      } else {
        setPublishResults({
          published: [],
          failed: [{
            type: 'Project',
            name: projectData?.projectName || projectData?.name || 'Project',
            error: getErrorMessage(response.data)
          }]
        });
        setShowPublishResultsModal(true);
      }
    } catch (error) {
      const errorMessage = handleError(error, 'ProjectConfirmation - publishProject');
      toast.error(errorMessage);
    } finally {
      setSubmitting(false);
    }
  };

  if (!projectData) {
    return (
      <div className="dashboard-layout">
        <Sidebar isOpen={sidebarOpen} toggleSidebar={() => setSidebarOpen(!sidebarOpen)} />
        <div className="confirmation-container" style={{ marginLeft: `${sidebarWidth}px`, width: `calc(100% - ${sidebarWidth}px)`, transition: 'margin-left 0.2s ease, width 0.2s ease', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', minHeight: '400px', gap: '16px' }}>
          <Loader className="spinner" size={24} style={{ color: '#0176d3' }} />
          <p style={{ color: '#706e6b', fontSize: '14px' }}>Loading...</p>
        </div>
      </div>
    );
  }

  const formatValue = (value) => {
    if (value === null || value === undefined || value === '') {
      return <span className="empty">Not provided</span>;
    }
    if (typeof value === 'boolean') {
      return value ? <CheckCircle size={16} className="check-icon" /> : <XCircle size={16} className="x-icon" />;
    }
    if (typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    }
    return String(value);
  };

  const sections = [
    {
      title: 'Project Information',
      fields: [
        { key: 'projectName', label: 'Project Name' },
        { key: 'shortProjectName', label: 'Short Project Name' },
        { key: 'workdayProjectId', label: 'Workday Project ID' },
        { key: 'appenPartner', label: 'Appen Partner' },
        { key: 'jobCategory', label: 'Job Category' },
        { key: 'projectType', label: 'Project Type' },
        { key: 'projectPriority', label: 'Project Priority' },
        { key: 'projectShortDescription', label: 'Project Short Description' },
        { key: 'projectLongDescription', label: 'Project Long Description' }
      ]
    },
    {
      title: 'Project Details',
      fields: [
        { key: 'account', label: 'Account' },
        { key: 'programName', label: 'Program Name' },
        { key: 'hireStartDate', label: 'Hire Start Date' },
        { key: 'predictedCloseDate', label: 'Predicted Close Date' },
        { key: 'deliveryToolOrg', label: 'Delivery Tool Org' },
        { key: 'deliveryToolName', label: 'Delivery Tool Name' },
        { key: 'projectStatus', label: 'Project Status' }
      ]
    },
    {
      title: 'Payment Configurations',
      fields: [
        { key: 'projectPaymentMethod', label: 'Project Payment Method' },
        { key: 'requirePMApprovalForProductivity', label: 'Require PM Approval for Productivity' },
        { key: 'paymentSetupRequired', label: 'Payment Setup Required' }
      ]
    },
    {
      title: 'Requirements',
      fields: [
        { key: 'manualActivationRequired', label: 'Manual Activation Required' },
        { key: 'clientToolAccountRequired', label: 'Client Tool Account Required' }
      ]
    },
    {
      title: 'People',
      fields: [
        { key: 'projectManager', label: 'Project Manager' },
        { key: 'projectSupportLead', label: 'Project Support Lead' },
        { key: 'casesDCSupportTeam', label: 'Cases DC Support Team' }
      ]
    },
    {
      title: 'Additional Information',
      fields: [
        { key: 'languages', label: 'Languages' },
        { key: 'budget', label: 'Budget' },
        { key: 'sowURL', label: 'SOW URL' },
        { key: 'jiraTicketURL', label: 'Jira Ticket URL' },
        { key: 'casablancaHomeURL', label: 'Casablanca Home URL' },
        { key: 'projectServerLocation', label: 'Project Server Location' },
        { key: 'locationOfAudio', label: 'Location of Audio' },
        { key: 'locationOfDeliverables', label: 'Location of Deliverables' },
        { key: 'dataHoursPerLanguage', label: 'Data Hours Per Language' },
        { key: 'setupProductionWeeks', label: 'Setup & Production Weeks' },
        { key: 'milestones', label: 'Milestones' },
        { key: 'teamMembers', label: 'Team Members' },
        { key: 'communication', label: 'Communication' }
      ]
    }
  ];

  return (
    <div className="dashboard-layout">
      <Sidebar isOpen={sidebarOpen} toggleSidebar={() => setSidebarOpen(!sidebarOpen)} />
      
      <div className="confirmation-container" style={{ marginLeft: `${sidebarWidth}px`, width: `calc(100% - ${sidebarWidth}px)`, transition: 'margin-left 0.2s ease, width 0.2s ease' }}>
        <div className="confirmation-header">
          <div className="header-content">
            <div className="header-left">
              <button 
                className="header-menu-toggle"
                onClick={() => setSidebarOpen(!sidebarOpen)}
                aria-label="Toggle sidebar"
              >
                <Menu size={20} />
              </button>
              <div>
                <h1 className="page-title">Confirm Project Details</h1>
                <p className="page-subtitle">Please review all the information below before submitting</p>
              </div>
            </div>
            <div className="header-user-profile">
              <div className="user-profile">
                <div className="user-avatar">
                  {user?.email?.charAt(0).toUpperCase() || 'U'}
                </div>
                <div className="user-info">
                  <div className="user-name">{user?.email || 'User'}</div>
                  <div className="user-role">{user?.role || 'Guest'}</div>
                </div>
                <button 
                  className="logout-button"
                  onClick={logout}
                  title="Logout"
                  style={{
                    marginLeft: '12px',
                    padding: '8px',
                    border: 'none',
                    background: 'transparent',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'var(--text-secondary)'
                  }}
                >
                  <LogOut size={18} />
                </button>
              </div>
            </div>
          </div>
        </div>

      <div className="confirmation-content">
        {sections.map((section, sectionIndex) => (
          <div key={sectionIndex} className="confirmation-section neumorphic fade-in">
            <h2>{section.title}</h2>
            <div className="confirmation-grid">
              {section.fields.map((field) => (
                <div key={field.key} className="confirmation-field">
                  <label>{field.label}</label>
                  <div className="field-value">
                    {formatValue(projectData[field.key])}
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div className="confirmation-actions">
        <button
          onClick={() => navigate('/setup')}
          className="btn-secondary"
          disabled={submitting}
        >
          <ArrowLeft size={20} />
          Back to Edit
        </button>
        <button
          onClick={handleEdit}
          className="btn-secondary"
          disabled={submitting}
        >
          <Edit size={20} />
          Edit
        </button>
        <button
          onClick={handlePublish}
          className="btn-primary"
          disabled={submitting || !hasPermission('create_project')}
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            justifyContent: 'center'
          }}
        >
          {submitting ? (
            <>
              <div className="spinner-small"></div>
              <span>Publishing...</span>
            </>
          ) : (
            <>
              <Send size={16} />
              <span>Publish</span>
            </>
          )}
        </button>
      </div>

      {!hasPermission('create_project') && (
        <div className="permission-warning">
          <p>You do not have permission to publish projects. Please contact an administrator.</p>
        </div>
      )}
      </div>

      {/* Publish Results Modal */}
      {showPublishResultsModal && publishResults && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '20px',
            boxSizing: 'border-box'
          }}
          onClick={() => setShowPublishResultsModal(false)}
        >
          <div 
            style={{
              backgroundColor: '#ffffff',
              borderRadius: '8px',
              width: '90%',
              maxWidth: '700px',
              maxHeight: '90vh',
              display: 'flex',
              flexDirection: 'column',
              boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
              boxSizing: 'border-box',
              color: '#002329',
              fontFamily: 'Poppins',
              fontSize: '14px'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              padding: '20px 24px',
              borderBottom: '1px solid #e2e8f0',
              flexShrink: 0
            }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px'
              }}>
                {publishResults.failed.length > 0 ? (
                  <XCircle size={24} color="#ef4444" />
                ) : (
                  <CheckCircle size={24} color="#10b981" />
                )}
                <h2 style={{
                  margin: 0,
                  fontSize: '20px',
                  fontWeight: 600,
                  color: '#002329',
                  fontFamily: 'Poppins'
                }}>
                  Publish Results
                </h2>
              </div>
              <button
                onClick={() => setShowPublishResultsModal(false)}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '4px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '4px',
                  transition: 'background-color 0.2s'
                }}
                onMouseEnter={(e) => e.target.style.backgroundColor = '#f1f5f9'}
                onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
              >
                <X size={20} color="#64748b" />
              </button>
            </div>

            {/* Modal Content */}
            <div style={{
              padding: '24px',
              overflowY: 'auto',
              flex: 1
            }}>
              {/* Published Objects */}
              {publishResults.published.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{
                    margin: '0 0 16px 0',
                    fontSize: '16px',
                    fontWeight: 600,
                    color: '#10b981',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <CheckCircle size={18} />
                    Published Successfully ({publishResults.published.length})
                  </h3>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {publishResults.published.map((obj, index) => (
                      <div key={index} style={{
                        padding: '16px',
                        backgroundColor: '#f0fdf4',
                        border: '1px solid #bbf7d0',
                        borderRadius: '8px'
                      }}>
                        <div style={{
                          fontWeight: 600,
                          color: '#002329',
                          marginBottom: '8px'
                        }}>
                          {obj.type}: "{obj.name}"
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Failed Objects */}
              {publishResults.failed.length > 0 && (
                <div>
                  <h3 style={{
                    margin: '0 0 16px 0',
                    fontSize: '16px',
                    fontWeight: 600,
                    color: '#ef4444',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <XCircle size={18} />
                    Failed to Publish ({publishResults.failed.length})
                  </h3>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '12px'
                  }}>
                    {publishResults.failed.map((obj, index) => (
                      <div key={index} style={{
                        padding: '16px',
                        backgroundColor: '#fef2f2',
                        border: '1px solid #fecaca',
                        borderRadius: '8px'
                      }}>
                        <div style={{
                          fontWeight: 600,
                          color: '#002329',
                          marginBottom: '8px'
                        }}>
                          {obj.type}: "{obj.name}"
                        </div>
                        <div style={{
                          fontSize: '13px',
                          color: '#ef4444',
                          marginTop: '8px'
                        }}>
                          Error: {obj.error}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div style={{
              padding: '16px 24px',
              borderTop: '1px solid #e2e8f0',
              display: 'flex',
              justifyContent: 'flex-end',
              gap: '12px',
              flexShrink: 0
            }}>
              <button
                onClick={() => {
                  setShowPublishResultsModal(false);
                  if (publishResults.failed.length === 0) {
                    setTimeout(() => {
                      navigate('/dashboard');
                    }, 500);
                  }
                }}
                style={{
                  padding: '10px 20px',
                  backgroundColor: '#08979C',
                  color: '#ffffff',
                  border: 'none',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  fontFamily: 'Poppins',
                  transition: 'background-color 0.2s'
                }}
                onMouseEnter={(e) => e.target.style.backgroundColor = '#067a7f'}
                onMouseLeave={(e) => e.target.style.backgroundColor = '#08979C'}
              >
                {publishResults.failed.length === 0 ? 'Continue' : 'Close'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default ProjectConfirmation;

