import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { useAuth } from '../context/AuthContext';
import Sidebar from '../components/Sidebar';
import { Menu, LogOut, Send, RefreshCw, Search, Loader, Plus, X, Trash2, AlertTriangle, Eye, Save, ArrowLeft, ArrowRight, Download, Upload, History, Undo, Redo, Check, Copy, ChevronRight, HelpCircle, Info } from 'lucide-react';
import apiClient from '../config/api';
import toast from 'react-hot-toast';
import { transformationTemplates, saveTransformationSet as saveSetToStorage, loadTransformationSet as loadSetFromStorage, getAllTransformationSets, deleteTransformationSet as deleteSetFromStorage } from '../utils/transformationTemplates';
import '../styles/UpdateObjectFields.css';
import '../styles/Sidebar.css';
import '../styles/GlobalHeader.css';

const UpdateObjectFields = () => {
  const { user, logout } = useAuth();
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [selectedObject, setSelectedObject] = useState('');
  const [fields, setFields] = useState([]);
  const [selectedField, setSelectedField] = useState('');
  const [selectedFieldInfo, setSelectedFieldInfo] = useState(null);
  const [updateMode, setUpdateMode] = useState('all'); // 'all' or 'specific'
  const [currentValue, setCurrentValue] = useState('');
  const [newValue, setNewValue] = useState('');
  const [updateModeType, setUpdateModeType] = useState('single'); // 'single', 'multiple', or 'mapping'
  const [fieldMappingMode, setFieldMappingMode] = useState(false);
  const [sourceObject, setSourceObject] = useState('');
  const [sourceFields, setSourceFields] = useState([]);
  const [fieldMappings, setFieldMappings] = useState([{
    id: Date.now(),
    targetField: '',
    sourceField: '',
    transformation: 'copy', // 'copy', 'uppercase', 'lowercase', 'concatenate', 'formula', 'dateFormat', 'numberFormat', 'valueMap', 'conditional', 'textReplace', 'defaultValue', 'typeConversion', 'validateFormat', 'removeSpecialChars', 'switch'
    formula: '', // For formula transformation
    concatenateFields: [], // For concatenate transformation
    separator: ' ', // For concatenate transformation
    dateFormat: 'YYYY-MM-DD', // For date format transformation
    numberFormat: '0.00', // For number format transformation
    valueMappings: [{ from: '', to: '' }], // For value mapping transformation [{from: 'Yes', to: 'true'}, {from: 'No', to: 'false'}]
    conditionField: '', // For conditional transformation (legacy single condition)
    conditionValue: '', // For conditional transformation (legacy)
    conditionOperator: 'equals', // 'equals', 'notEquals', 'contains', 'greaterThan', 'lessThan' (legacy)
    thenValue: '', // For conditional transformation (legacy)
    elseValue: '', // For conditional transformation (optional) (legacy)
    // New: Multiple conditions support
    conditions: [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }], // For enhanced conditional transformation
    // New: Text replacement
    findText: '', // Text to find
    replaceText: '', // Text to replace with
    replaceMode: 'all', // 'all', 'first', 'last'
    caseSensitive: false, // true/false
    useRegex: false, // true/false (advanced)
    // New: Default value
    defaultValue: '', // Default value to use
    applyWhen: 'empty', // 'empty', 'null', 'emptyOrNull', 'invalid'
    // New: Type conversion
    targetType: 'string', // 'string', 'number', 'boolean', 'date'
    conversionFormat: '', // Optional format for date conversion
    // New: Format validation
    validationType: 'email', // 'email', 'phone', 'url', 'postalCode', 'custom'
    customPattern: '', // For custom regex
    onInvalid: 'default', // 'default', 'skip', 'error'
    // New: Remove special characters
    removeMode: 'removeAll', // 'removeAll', 'keepOnlyNumbers', 'keepOnlyLetters', 'keepOnlyAlphanumeric'
    // New: Switch/Case
    cases: [{ value: '', targetValue: '' }], // For switch transformation
    switchDefaultValue: '', // Default value for switch
    // New: Error handling
    errorHandling: 'default' // 'default', 'skip', 'original'
  }]);
  const [multipleFieldUpdates, setMultipleFieldUpdates] = useState([{
    id: Date.now(),
    fieldName: '',
    updateMode: 'all',
    currentValue: '',
    newValue: '',
    fieldInfo: null,
    picklistValues: [],
    referenceSearchTerm: '',
    referenceSearchResults: [],
    searchingReference: false,
    showReferenceDropdown: false,
    currentValueReferenceSearchTerm: '',
    currentValueReferenceSearchResults: [],
    searchingCurrentValueReference: false,
    showCurrentValueReferenceDropdown: false
  }]);
  const [loadingFields, setLoadingFields] = useState(false);
  const [updating, setUpdating] = useState(false);
  const [picklistValues, setPicklistValues] = useState([]);
  const [filterOptions, setFilterOptions] = useState({});
  const [loadingFilters, setLoadingFilters] = useState(false);
  const [filters, setFilters] = useState({
    projectId: '',
    projectName: '',
    projectObjectiveId: '',
    projectObjectiveName: '',
    status: '',
    type: ''
  });
  const [projectSearchTerm, setProjectSearchTerm] = useState('');
  const [projectObjectiveSearchTerm, setProjectObjectiveSearchTerm] = useState('');
  const [allProjects, setAllProjects] = useState([]); // All projects for dropdown
  const [filteredProjects, setFilteredProjects] = useState([]); // Filtered projects based on search
  const [conditionPicklistValues, setConditionPicklistValues] = useState({}); // Map of mappingId -> picklist values
  const [conditionReferenceSearch, setConditionReferenceSearch] = useState({}); // Map of mappingId -> { term, results, loading, show }
  const [targetPicklistValues, setTargetPicklistValues] = useState({}); // Map of mappingId -> picklist values for target field
  const [allProjectObjectives, setAllProjectObjectives] = useState([]); // All project objectives for dropdown
  const [filteredProjectObjectives, setFilteredProjectObjectives] = useState([]); // Filtered project objectives based on search
  const [showProjectDropdown, setShowProjectDropdown] = useState(false);
  const [showProjectObjectiveDropdown, setShowProjectObjectiveDropdown] = useState(false);
  const [loadingAllProjects, setLoadingAllProjects] = useState(false);
  const [searchingProjects, setSearchingProjects] = useState(false);
  const [searchingProjectObjectives, setSearchingProjectObjectives] = useState(false);
  const [matchingRecordsCount, setMatchingRecordsCount] = useState(null);
  const [loadingCount, setLoadingCount] = useState(false);
  const [referenceSearchTerm, setReferenceSearchTerm] = useState('');
  const [referenceSearchResults, setReferenceSearchResults] = useState([]);
  const [searchingReference, setSearchingReference] = useState(false);
  const [showReferenceDropdown, setShowReferenceDropdown] = useState(false);
  const [currentValueReferenceSearchTerm, setCurrentValueReferenceSearchTerm] = useState('');
  const [currentValueReferenceSearchResults, setCurrentValueReferenceSearchResults] = useState([]);
  const [searchingCurrentValueReference, setSearchingCurrentValueReference] = useState(false);
  const [showCurrentValueReferenceDropdown, setShowCurrentValueReferenceDropdown] = useState(false);
  const referenceSearchRef = useRef(null);
  const currentValueReferenceSearchRef = useRef(null);
  const projectSearchRef = useRef(null);
  const projectObjectiveSearchRef = useRef(null);
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmModalData, setConfirmModalData] = useState({ message: '', onConfirm: null, onCancel: null });
  const [showPreviewModal, setShowPreviewModal] = useState(false);
  const [previewData, setPreviewData] = useState(null);
  const [loadingPreview, setLoadingPreview] = useState(false);
  
  // Phase 4 & 5: Enhanced features state
  const [transformationHistory, setTransformationHistory] = useState([]); // For undo/redo
  const [historyIndex, setHistoryIndex] = useState(-1); // Current position in history
  const [savedTransformationSets, setSavedTransformationSets] = useState([]); // Saved transformation sets
  const [transformationTemplates, setTransformationTemplates] = useState([]); // Predefined templates
  const [enhancedPreviewData, setEnhancedPreviewData] = useState(null); // Step-by-step preview data
  const [batchSize, setBatchSize] = useState(200); // Batch processing size
  const [errorHandlingMode, setErrorHandlingMode] = useState('default'); // 'default', 'skip', 'continue', 'stop'
  const [showTemplateModal, setShowTemplateModal] = useState(false);
  const [showSaveSetModal, setShowSaveSetModal] = useState(false);
  const [showLoadSetModal, setShowLoadSetModal] = useState(false);
  const [showTransformationHelpModal, setShowTransformationHelpModal] = useState(false);
  const [savedSetName, setSavedSetName] = useState('');
  const [selectedMappingId, setSelectedMappingId] = useState(null);
  const [useHybridView, setUseHybridView] = useState(false);
  const [showMappingModeHelp, setShowMappingModeHelp] = useState(false);
  const [showFieldMappingHelp, setShowFieldMappingHelp] = useState(false);
  const [showFieldMappingHelpModal, setShowFieldMappingHelpModal] = useState(false);

  const objectOptions = [
    { value: 'project', label: 'Project' },
    { value: 'project objective', label: 'Project Objective' },
    { value: 'contributor project', label: 'Contributor Project' }
  ];

  // History tracking for undo/redo
  useEffect(() => {
    if (fieldMappings.length > 0) {
      const currentState = JSON.parse(JSON.stringify(fieldMappings));
      setTransformationHistory(prev => {
        // Remove any future states if we're not at the end
        const newHistory = prev.slice(0, historyIndex + 1);
        // Add current state
        newHistory.push(currentState);
        // Limit history to last 50 states
        if (newHistory.length > 50) {
          newHistory.shift();
        }
        return newHistory;
      });
      setHistoryIndex(prev => {
        const newIndex = Math.min(prev + 1, 49);
        return newIndex;
      });
    }
  }, [fieldMappings.length]); // Track when mappings are added/removed

  useEffect(() => {
    if (selectedObject) {
      fetchFields();
      fetchFilterOptions();
      // Reset filters when object changes
      setFilters({
        projectId: '',
        projectName: '',
        projectObjectiveId: '',
        projectObjectiveName: '',
        status: '',
        type: ''
      });
      setProjectSearchTerm('');
      setProjectObjectiveSearchTerm('');
      setAllProjects([]);
      setFilteredProjects([]);
      setAllProjectObjectives([]);
      setFilteredProjectObjectives([]);
      setShowProjectDropdown(false);
      setShowProjectObjectiveDropdown(false);
      setMatchingRecordsCount(null);
    } else {
      setFields([]);
      setSelectedField('');
      setSelectedFieldInfo(null);
      setPicklistValues([]);
      setFilterOptions({});
      setFilters({
        projectId: '',
        projectName: '',
        projectObjectiveId: '',
        projectObjectiveName: '',
        status: '',
        type: ''
      });
      setProjectSearchTerm('');
      setProjectObjectiveSearchTerm('');
      setAllProjects([]);
      setFilteredProjects([]);
      setAllProjectObjectives([]);
      setFilteredProjectObjectives([]);
      setShowProjectDropdown(false);
      setShowProjectObjectiveDropdown(false);
      setMatchingRecordsCount(null);
    }
  }, [selectedObject]);

  useEffect(() => {
    if (selectedField && selectedObject) {
      const fieldInfo = fields.find(f => f.name === selectedField);
      setSelectedFieldInfo(fieldInfo);
      
      if (fieldInfo && (fieldInfo.type === 'picklist' || fieldInfo.type === 'multipicklist')) {
        if (fieldInfo.picklistValues && fieldInfo.picklistValues.length > 0) {
          setPicklistValues(fieldInfo.picklistValues);
        } else {
          fetchPicklistValues();
        }
      } else {
        setPicklistValues([]);
      }
      
      // Reset reference search when field changes
      if (fieldInfo && fieldInfo.type === 'reference') {
        setReferenceSearchTerm('');
        setReferenceSearchResults([]);
        setShowReferenceDropdown(false);
        setCurrentValueReferenceSearchTerm('');
        setCurrentValueReferenceSearchResults([]);
        setShowCurrentValueReferenceDropdown(false);
        // If newValue is already set (might be an ID), clear it so user can search
        if (newValue && newValue.trim() !== '') {
          setNewValue('');
        }
        // If currentValue is already set (might be an ID), clear it so user can search
        if (currentValue && currentValue.trim() !== '') {
          setCurrentValue('');
        }
      }
    } else {
      setSelectedFieldInfo(null);
      setPicklistValues([]);
      setReferenceSearchTerm('');
      setReferenceSearchResults([]);
      setShowReferenceDropdown(false);
      setCurrentValueReferenceSearchTerm('');
      setCurrentValueReferenceSearchResults([]);
      setShowCurrentValueReferenceDropdown(false);
    }
  }, [selectedField, selectedObject, fields]);

  const fetchFields = async (objectType = null, isSourceObject = false) => {
    const objType = objectType || selectedObject;
    if (!objType) return;
    
    setLoadingFields(true);
    try {
      const response = await apiClient.get(`/update-object-fields/fields/${objType}`);
      if (response.data.success) {
        if (isSourceObject || (objectType && objectType === sourceObject)) {
          setSourceFields(response.data.fields || []);
        } else {
          setFields(response.data.fields || []);
        }
      } else {
        toast.error(response.data.error || 'Failed to fetch fields');
      }
    } catch (error) {
      console.error('Error fetching fields:', error);
      // Check if it's a connection error
      if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK' || error.isBackendDown) {
        toast.error(error.userMessage || 'Unable to connect to server. Please ensure the backend server is running on port 5000.');
      } else {
        toast.error(error.response?.data?.error || error.message || 'Failed to fetch fields from Salesforce');
      }
    } finally {
      setLoadingFields(false);
    }
  };

  const fetchPicklistValues = async () => {
    try {
      const response = await apiClient.get(`/update-object-fields/picklist-values/${selectedObject}/${selectedField}`);
      if (response.data.success) {
        setPicklistValues(response.data.values || []);
      }
    } catch (error) {
      console.error('Error fetching picklist values:', error);
      // Don't show error toast, just use empty array
      setPicklistValues([]);
    }
  };

  const fetchConditionPicklistValues = async (mappingId, fieldName) => {
    if (!sourceObject || !fieldName) return;
    try {
      const response = await apiClient.get(`/update-object-fields/picklist-values/${sourceObject}/${fieldName}`);
      if (response.data.success) {
        setConditionPicklistValues(prev => ({
          ...prev,
          [mappingId]: response.data.values || []
        }));
      }
    } catch (error) {
      console.error('Error fetching condition picklist values:', error);
      setConditionPicklistValues(prev => ({
        ...prev,
        [mappingId]: []
      }));
    }
  };

  const fetchTargetPicklistValues = async (mappingId, fieldName) => {
    if (!selectedObject || !fieldName) return;
    try {
      const response = await apiClient.get(`/update-object-fields/picklist-values/${selectedObject}/${fieldName}`);
      if (response.data.success) {
        setTargetPicklistValues(prev => ({
          ...prev,
          [mappingId]: response.data.values || []
        }));
      }
    } catch (error) {
      console.error('Error fetching target picklist values:', error);
      setTargetPicklistValues(prev => ({
        ...prev,
        [mappingId]: []
      }));
    }
  };

  const searchConditionReference = async (mappingId, fieldName, searchTerm) => {
    if (!sourceObject || !fieldName || !searchTerm || searchTerm.trim() === '') {
      setConditionReferenceSearch(prev => ({
        ...prev,
        [mappingId]: { term: '', results: [], loading: false, show: false }
      }));
      return;
    }

    setConditionReferenceSearch(prev => ({
      ...prev,
      [mappingId]: { ...(prev[mappingId] || {}), loading: true, show: true }
    }));

    try {
      // Get the field info to find the reference object
      const field = sourceFields.find(f => f.name === fieldName);
      if (!field || !field.referenceTo) {
        setConditionReferenceSearch(prev => ({
          ...prev,
          [mappingId]: { term: searchTerm, results: [], loading: false, show: false }
        }));
        return;
      }

      // Search the referenced object using the search-reference endpoint
      const response = await apiClient.get(`/update-object-fields/search-reference/${encodeURIComponent(field.referenceTo)}?search=${encodeURIComponent(searchTerm)}`);
      if (response.data.success) {
        setConditionReferenceSearch(prev => ({
          ...prev,
          [mappingId]: {
            term: searchTerm,
            results: (response.data.records || []).map(r => ({ Id: r.id, Name: r.name })),
            loading: false,
            show: true
          }
        }));
      }
    } catch (error) {
      console.error('Error searching condition reference:', error);
      setConditionReferenceSearch(prev => ({
        ...prev,
        [mappingId]: { term: searchTerm, results: [], loading: false, show: false }
      }));
    }
  };

  // Debounced search for condition reference fields
  const conditionReferenceSearchTimeouts = useRef({});
  const handleConditionReferenceSearch = (mappingId, fieldName, value) => {
    // Clear existing timeout for this mapping
    if (conditionReferenceSearchTimeouts.current[mappingId]) {
      clearTimeout(conditionReferenceSearchTimeouts.current[mappingId]);
    }

    if (!value || value.trim() === '') {
      setConditionReferenceSearch(prev => ({
        ...prev,
        [mappingId]: { term: '', results: [], loading: false, show: false }
      }));
      return;
    }

    // Set new timeout
    conditionReferenceSearchTimeouts.current[mappingId] = setTimeout(() => {
      searchConditionReference(mappingId, fieldName, value);
    }, 300);
  };

  const fetchFilterOptions = async () => {
    setLoadingFilters(true);
    try {
      const response = await apiClient.get(`/update-object-fields/filter-options/${selectedObject}`);
      if (response.data.success) {
        const filterOpts = response.data.filterOptions || {};
        setFilterOptions(filterOpts);
        
        // If projects are available, load them for dropdown
        if (filterOpts.projects && filterOpts.projects.length > 0) {
          setAllProjects(filterOpts.projects);
          setFilteredProjects(filterOpts.projects);
        } else {
          // If not in filter options, fetch all projects separately
          // Only fetch if this object type needs project filter
          const needsProjectFilter = selectedObject.toLowerCase() === 'project' ||
                                     selectedObject.toLowerCase() === 'project objective' || 
                                     selectedObject.toLowerCase() === 'contributor project';
          if (needsProjectFilter) {
            fetchAllProjects();
          }
        }

        // If project objectives are available, load them for dropdown
        if (filterOpts.projectObjectives && filterOpts.projectObjectives.length > 0) {
          setAllProjectObjectives(filterOpts.projectObjectives);
          setFilteredProjectObjectives(filterOpts.projectObjectives);
        } else {
          // If not in filter options, fetch all project objectives separately
          // Only fetch if this object type needs project objective filter
          const needsProjectObjectiveFilter = selectedObject.toLowerCase() === 'project objective' ||
                                             selectedObject.toLowerCase() === 'contributor project';
          if (needsProjectObjectiveFilter) {
            // If a project is already selected, fetch project objectives for that project
            const projectId = filters.projectId || null;
            fetchAllProjectObjectives(projectId);
          }
        }
      }
    } catch (error) {
      console.error('Error fetching filter options:', error);
      setFilterOptions({});
      // Try to fetch projects anyway if needed
      const needsProjectFilter = selectedObject.toLowerCase() === 'project' ||
                                 selectedObject.toLowerCase() === 'project objective' || 
                                 selectedObject.toLowerCase() === 'contributor project';
      if (needsProjectFilter) {
        fetchAllProjects();
      }
      // Try to fetch project objectives if needed
      const needsProjectObjectiveFilter = selectedObject.toLowerCase() === 'project objective' ||
                                         selectedObject.toLowerCase() === 'contributor project';
      if (needsProjectObjectiveFilter) {
        // If a project is already selected, fetch project objectives for that project
        const projectId = filters.projectId || null;
        fetchAllProjectObjectives(projectId);
      }
    } finally {
      setLoadingFilters(false);
    }
  };

  // Fetch all projects for dropdown
  const fetchAllProjects = async () => {
    setLoadingAllProjects(true);
    try {
      const response = await apiClient.get('/salesforce/search-projects?search=');
      if (response.data.success) {
        const projects = response.data.projects || [];
        setAllProjects(projects);
        setFilteredProjects(projects);
      }
    } catch (error) {
      console.error('Error fetching all projects:', error);
      // Try alternative: get from filter options if available
      const currentFilterOptions = filterOptions;
      if (currentFilterOptions.projects && currentFilterOptions.projects.length > 0) {
        setAllProjects(currentFilterOptions.projects);
        setFilteredProjects(currentFilterOptions.projects);
      }
    } finally {
      setLoadingAllProjects(false);
    }
  };

  // Fetch all project objectives for dropdown
  const fetchAllProjectObjectives = async (projectId = null) => {
    try {
      let url = '/salesforce/search-project-objectives?search=';
      if (projectId) {
        url += `&project=${encodeURIComponent(projectId)}`;
      }
      const response = await apiClient.get(url);
      if (response.data.success) {
        const projectObjectives = response.data.projectObjectives || [];
        setAllProjectObjectives(projectObjectives);
        setFilteredProjectObjectives(projectObjectives);
      }
    } catch (error) {
      console.error('Error fetching all project objectives:', error);
      // Try alternative: get from filter options if available
      const currentFilterOptions = filterOptions;
      if (currentFilterOptions.projectObjectives && currentFilterOptions.projectObjectives.length > 0) {
        // Filter by project if projectId is provided
        let filtered = currentFilterOptions.projectObjectives;
        if (projectId) {
          // Note: filterOptions may not have projectId, so we'll use the API result
          filtered = currentFilterOptions.projectObjectives;
        }
        setAllProjectObjectives(filtered);
        setFilteredProjectObjectives(filtered);
      }
    }
  };

  // Search projects in Salesforce when search term changes
  useEffect(() => {
    if (!projectSearchTerm || projectSearchTerm.trim() === '') {
      // Show all projects when search is empty
      setFilteredProjects(allProjects);
      setSearchingProjects(false);
      return;
    }

    // Debounce search - wait 300ms after user stops typing
    setSearchingProjects(true);
    const timeoutId = setTimeout(async () => {
      try {
        const response = await apiClient.get(`/salesforce/search-projects?search=${encodeURIComponent(projectSearchTerm)}`);
        if (response.data.success) {
          const projects = response.data.projects || [];
          setFilteredProjects(projects);
        }
      } catch (error) {
        console.error('Error searching projects:', error);
        // Fallback to local filtering if API fails
        const searchLower = projectSearchTerm.toLowerCase().trim();
        const filtered = allProjects.filter(project => 
          project.name.toLowerCase().includes(searchLower)
        );
        setFilteredProjects(filtered);
      } finally {
        setSearchingProjects(false);
      }
    }, 300);

    return () => {
      clearTimeout(timeoutId);
      setSearchingProjects(false);
    };
  }, [projectSearchTerm, allProjects]);

  // Search project objectives in Salesforce when search term changes
  useEffect(() => {
    if (!projectObjectiveSearchTerm || projectObjectiveSearchTerm.trim() === '') {
      // Show all project objectives when search is empty (filtered by project if selected)
      setFilteredProjectObjectives(allProjectObjectives);
      setSearchingProjectObjectives(false);
      return;
    }

    // Debounce search - wait 300ms after user stops typing
    setSearchingProjectObjectives(true);
    const timeoutId = setTimeout(async () => {
      try {
        let url = `/salesforce/search-project-objectives?search=${encodeURIComponent(projectObjectiveSearchTerm)}`;
        // If a project is selected, filter project objectives by that project
        if (filters.projectId) {
          url += `&project=${encodeURIComponent(filters.projectId)}`;
        }
        const response = await apiClient.get(url);
        if (response.data.success) {
          const projectObjectives = response.data.projectObjectives || [];
          setFilteredProjectObjectives(projectObjectives);
        }
      } catch (error) {
        console.error('Error searching project objectives:', error);
        // Fallback to local filtering if API fails
        const searchLower = projectObjectiveSearchTerm.toLowerCase().trim();
        let filtered = allProjectObjectives.filter(po => 
          po.name.toLowerCase().includes(searchLower)
        );
        // Also filter by project if selected
        if (filters.projectId) {
          // Note: allProjectObjectives may not have projectId info, so we'll rely on API
          // But if we have it, filter locally
          filtered = filtered.filter(po => po.projectId === filters.projectId);
        }
        setFilteredProjectObjectives(filtered);
      } finally {
        setSearchingProjectObjectives(false);
      }
    }, 300);

    return () => {
      clearTimeout(timeoutId);
      setSearchingProjectObjectives(false);
    };
  }, [projectObjectiveSearchTerm, allProjectObjectives, filters.projectId]);

  // Handle project selection
  const handleProjectSelect = (project) => {
    // Clear project objective selection when project changes
    const hadProjectObjective = filters.projectObjectiveId;
    setFilters(prev => ({
      ...prev,
      projectId: project.id,
      projectName: project.name,
      projectObjectiveId: '', // Clear project objective when project changes
      projectObjectiveName: ''
    }));
    setProjectSearchTerm(project.name);
    setShowProjectDropdown(false);
    if (hadProjectObjective) {
      setProjectObjectiveSearchTerm('');
    }
    // Fetch project objectives for the selected project
    fetchAllProjectObjectives(project.id);
  };

  // Handle project objective selection
  const handleProjectObjectiveSelect = (projectObjective) => {
    setFilters(prev => ({
      ...prev,
      projectObjectiveId: projectObjective.id,
      projectObjectiveName: projectObjective.name
    }));
    setProjectObjectiveSearchTerm(projectObjective.name);
    setShowProjectObjectiveDropdown(false);
  };

  // Refresh project objectives when project filter changes
  useEffect(() => {
    if (!selectedObject) return;
    
    const needsProjectObjectiveFilter = selectedObject.toLowerCase() === 'project objective' ||
                                       selectedObject.toLowerCase() === 'contributor project';
    
    if (needsProjectObjectiveFilter) {
      // If project is selected, fetch project objectives for that project
      // If project is cleared, fetch all project objectives
      const projectId = filters.projectId || null;
      fetchAllProjectObjectives(projectId);
      
      // If project is cleared and a project objective was selected, clear it
      if (!filters.projectId && filters.projectObjectiveId) {
        setFilters(prev => ({
          ...prev,
          projectObjectiveId: '',
          projectObjectiveName: ''
        }));
        setProjectObjectiveSearchTerm('');
      }
    }
  }, [filters.projectId, selectedObject]);

  // Phase 4 & 5: Helper functions for enhanced features
  
  // History management (Undo/Redo)
  const saveToHistory = useCallback((mappings) => {
    const newHistory = transformationHistory.slice(0, historyIndex + 1);
    newHistory.push(JSON.parse(JSON.stringify(mappings))); // Deep clone
    setTransformationHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
  }, [transformationHistory, historyIndex]);

  const undo = useCallback(() => {
    if (historyIndex > 0) {
      const newIndex = historyIndex - 1;
      setHistoryIndex(newIndex);
      setFieldMappings(JSON.parse(JSON.stringify(transformationHistory[newIndex])));
    }
  }, [historyIndex, transformationHistory]);

  const redo = useCallback(() => {
    if (historyIndex < transformationHistory.length - 1) {
      const newIndex = historyIndex + 1;
      setHistoryIndex(newIndex);
      setFieldMappings(JSON.parse(JSON.stringify(transformationHistory[newIndex])));
    }
  }, [historyIndex, transformationHistory]);

  // Save transformation set
  const saveTransformationSet = useCallback(() => {
    if (!savedSetName.trim()) {
      toast.error('Please enter a name for the transformation set');
      return;
    }
    if (fieldMappings.length === 0 || fieldMappings.every(m => !m.targetField)) {
      toast.error('Please add at least one field mapping before saving');
      return;
    }
    
    // Use the utility function to save (uses 'transformationSets' key)
    const result = saveSetToStorage(savedSetName.trim(), JSON.parse(JSON.stringify(fieldMappings)), {
      sourceObject,
      targetObject: selectedObject,
      createdBy: user?.email || 'unknown'
    });
    if (result.success) {
      // Update state
      setSavedTransformationSets(getAllTransformationSets());
      setShowSaveSetModal(false);
      setSavedSetName('');
      toast.success('Transformation set saved successfully');
    } else {
      toast.error(result.error || 'Failed to save transformation set');
    }
  }, [savedSetName, sourceObject, selectedObject, fieldMappings, user]);

  // Load transformation set
  const loadTransformationSet = useCallback(async (setDataOrId) => {
    let setData;
    if (typeof setDataOrId === 'string') {
      // It's an ID, load from storage
      const result = loadSetFromStorage(setDataOrId);
      if (!result.success) {
        toast.error(result.error || 'Failed to load transformation set');
        return;
      }
      setData = result.set;
    } else {
      // It's a setData object
      setData = setDataOrId;
    }
    
    // Set source and target objects
    if (setData.sourceObject) {
      setSourceObject(setData.sourceObject);
      // Clear existing source fields and fetch new ones
      setSourceFields([]);
      await fetchFields(setData.sourceObject, true);
    }
    
    if (setData.targetObject) {
      setSelectedObject(setData.targetObject);
    }
    
    const loadedMappings = JSON.parse(JSON.stringify(setData.mappings || []));
    setFieldMappings(loadedMappings);
    
    // After setting mappings and source object, fetch picklist values for conditional fields
    // Wait a bit for sourceFields to be loaded, then fetch picklist values
    setTimeout(() => {
      loadedMappings.forEach(mapping => {
        if (mapping.transformation === 'conditional') {
          // Handle enhanced multiple conditions
          if (mapping.conditions && Array.isArray(mapping.conditions)) {
            mapping.conditions.forEach((condition, condIndex) => {
              if (condition.field) {
                // Fetch picklist values directly if it's a picklist field
                fetchConditionPicklistValues(`${mapping.id}-${condIndex}`, condition.field);
              }
            });
          }
          // Handle legacy single condition
          if (mapping.conditionField) {
            // Fetch picklist values directly if it's a picklist field
            fetchConditionPicklistValues(mapping.id, mapping.conditionField);
          }
        }
      });
    }, 800); // Wait for fields to load
    
    saveToHistory(loadedMappings);
    toast.success(`Loaded transformation set: ${setData.name || 'Untitled Set'}`);
  }, [saveToHistory, fetchFields, fetchConditionPicklistValues]);

  // Delete transformation set
  const deleteTransformationSet = useCallback((setId) => {
    const result = deleteSetFromStorage(setId);
    if (result.success) {
      setSavedTransformationSets(getAllTransformationSets());
      toast.success('Transformation set deleted');
    } else {
      toast.error(result.error || 'Failed to delete transformation set');
    }
  }, []);

  // Helper function to get mapping status (for hybrid view)
  const getMappingStatus = useCallback((mapping) => {
    if (!mapping.targetField) return 'incomplete';
    
    if (mapping.transformation === 'formula') {
      return mapping.formula ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'concatenate') {
      return (mapping.concatenateFields && mapping.concatenateFields.length > 0) ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'valueMap') {
      return (mapping.valueMappings && mapping.valueMappings.length > 0 && mapping.valueMappings.some(vm => vm.from && vm.to)) ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'conditional') {
      if (mapping.conditions && Array.isArray(mapping.conditions) && mapping.conditions.length > 0) {
        const hasInvalidCondition = mapping.conditions.some(cond => {
          if (!cond.field) return true;
          const noValueOperators = ['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'];
          if (!noValueOperators.includes(cond.operator) && (!cond.value || cond.value === '')) return true;
          return false;
        });
        if (hasInvalidCondition || !mapping.thenValue || !mapping.elseValue) return 'incomplete';
        return 'valid';
      }
      return (!mapping.conditionField || !mapping.conditionValue || !mapping.thenValue) ? 'incomplete' : 'valid';
    }
    if (mapping.transformation === 'switch') {
      return (mapping.cases && mapping.cases.length > 0 && mapping.cases.some(c => c.value && c.targetValue)) ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'textReplace') {
      return mapping.findText ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'defaultValue') {
      return mapping.defaultValue ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'typeConversion') {
      return mapping.targetType ? 'valid' : 'incomplete';
    }
    if (mapping.transformation === 'validateFormat') {
      return mapping.validationType ? 'valid' : 'incomplete';
    }
    if (['formula', 'defaultValue', 'removeSpecialChars'].includes(mapping.transformation)) {
      return 'valid';
    }
    return mapping.sourceField ? 'valid' : 'incomplete';
  }, []);

  // Helper function to get mapping summary text (for hybrid view)
  const getMappingSummary = useCallback((mapping) => {
    const targetField = fields.find(f => f.name === mapping.targetField);
    const targetLabel = targetField ? targetField.label : mapping.targetField || 'Not selected';
    const transformName = mapping.transformation || 'Not selected';
    
    let sourceInfo = '';
    if (mapping.transformation === 'formula') {
      sourceInfo = mapping.formula ? `Formula: ${mapping.formula.substring(0, 30)}${mapping.formula.length > 30 ? '...' : ''}` : 'No formula';
    } else if (mapping.transformation === 'concatenate') {
      sourceInfo = mapping.concatenateFields && mapping.concatenateFields.length > 0 
        ? `${mapping.concatenateFields.length} field(s)` 
        : 'No fields';
    } else if (mapping.transformation === 'conditional') {
      if (mapping.conditions && Array.isArray(mapping.conditions) && mapping.conditions.length > 0) {
        sourceInfo = `${mapping.conditions.length} condition(s)`;
      } else {
        sourceInfo = mapping.conditionField ? `IF ${mapping.conditionField}` : 'No condition';
      }
    } else if (mapping.transformation === 'valueMap') {
      sourceInfo = mapping.valueMappings && mapping.valueMappings.length > 0 
        ? `${mapping.valueMappings.length} mapping(s)` 
        : 'No mappings';
    } else if (mapping.transformation === 'switch') {
      sourceInfo = mapping.cases && mapping.cases.length > 0 
        ? `${mapping.cases.length} case(s)` 
        : 'No cases';
    } else {
      const sourceField = sourceFields.find(f => f.name === mapping.sourceField);
      sourceInfo = sourceField ? sourceField.label : (mapping.sourceField || 'Not selected');
    }
    
    return `${targetLabel} → ${transformName} → ${sourceInfo}`;
  }, [fields, sourceFields]);

  // Duplicate mapping
  const duplicateMapping = useCallback((mappingId) => {
    const mapping = fieldMappings.find(m => m.id === mappingId);
    if (mapping) {
      const newMapping = {
        ...JSON.parse(JSON.stringify(mapping)),
        id: Date.now()
      };
      setFieldMappings([...fieldMappings, newMapping]);
      setSelectedMappingId(newMapping.id);
      toast.success('Mapping duplicated');
    }
  }, [fieldMappings]);

  // Initialize selected mapping when mappings change
  useEffect(() => {
    if (updateModeType === 'mapping' && fieldMappings.length > 0 && useHybridView) {
      if (!selectedMappingId || !fieldMappings.find(m => m.id === selectedMappingId)) {
        setSelectedMappingId(fieldMappings[0].id);
      }
    }
  }, [fieldMappings, updateModeType, useHybridView, selectedMappingId]);

  // Load saved sets from localStorage on mount and when updateModeType changes
  useEffect(() => {
    if (updateModeType === 'mapping') {
      const saved = getAllTransformationSets();
      setSavedTransformationSets(saved);
    }
  }, [updateModeType]);
  
  // Legacy: Load saved sets from localStorage on mount (for migration from old key)
  useEffect(() => {
    // Check old key for backward compatibility
    const savedFromOldKey = localStorage.getItem('savedTransformationSets');
    if (savedFromOldKey) {
      try {
        const oldSets = JSON.parse(savedFromOldKey);
        // Migrate old sets to new key if they don't exist there
        const newSets = getAllTransformationSets();
        oldSets.forEach(oldSet => {
          if (!newSets.find(s => s.id === oldSet.id)) {
            // Migrate this set to the new key
            const migratedSet = {
              ...oldSet,
              id: oldSet.id || Date.now().toString()
            };
            newSets.push(migratedSet);
          }
        });
        if (oldSets.length > 0) {
          localStorage.setItem('transformationSets', JSON.stringify(newSets));
        }
        setSavedTransformationSets(newSets);
      } catch (e) {
        console.error('Error migrating saved transformation sets:', e);
        // Fallback to new key
        setSavedTransformationSets(getAllTransformationSets());
      }
    } else {
      // No old sets, just load from new key
      setSavedTransformationSets(getAllTransformationSets());
    }
    
    // Initialize templates
    const templates = [
      {
        id: 1,
        name: 'Copy Field',
        description: 'Simple copy transformation',
        mapping: {
          targetField: '',
          sourceField: '',
          transformation: 'copy'
        }
      },
      {
        id: 2,
        name: 'Uppercase Text',
        description: 'Convert text to uppercase',
        mapping: {
          targetField: '',
          sourceField: '',
          transformation: 'uppercase'
        }
      },
      {
        id: 3,
        name: 'Default Value',
        description: 'Use default value if empty',
        mapping: {
          targetField: '',
          sourceField: '',
          transformation: 'defaultValue',
          defaultValue: '',
          applyWhen: 'empty'
        }
      },
      {
        id: 4,
        name: 'Conditional Mapping',
        description: 'If-then-else logic',
        mapping: {
          targetField: '',
          sourceField: '',
          transformation: 'conditional',
          conditions: [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }],
          thenValue: '',
          elseValue: ''
        }
      }
    ];
    setTransformationTemplates(templates);
  }, []);

  // Apply template
  const applyTemplate = useCallback((template) => {
    const newMapping = {
      ...JSON.parse(JSON.stringify(template.mapping)),
      id: Date.now()
    };
    setFieldMappings([...fieldMappings, newMapping]);
    setShowTemplateModal(false);
    toast.success(`Applied template: ${template.name}`);
  }, [fieldMappings]);

  // Save to history when mappings change (debounced)
  const saveHistoryTimeoutRef = useRef(null);
  useEffect(() => {
    if (saveHistoryTimeoutRef.current) {
      clearTimeout(saveHistoryTimeoutRef.current);
    }
    
    // Only save if we're not currently undoing/redoing
    if (fieldMappings.length > 0) {
      saveHistoryTimeoutRef.current = setTimeout(() => {
        // Check if mappings actually changed
        const currentMappingsStr = JSON.stringify(fieldMappings);
        const lastHistoryStr = historyIndex >= 0 && transformationHistory[historyIndex] 
          ? JSON.stringify(transformationHistory[historyIndex]) 
          : '';
        
        if (currentMappingsStr !== lastHistoryStr) {
          saveToHistory(fieldMappings);
        }
      }, 500); // Debounce 500ms
    }
    
    return () => {
      if (saveHistoryTimeoutRef.current) {
        clearTimeout(saveHistoryTimeoutRef.current);
      }
    };
  }, [fieldMappings]); // Save when mappings change

  // Fetch count of records matching current filters
  const fetchMatchingRecordsCount = useCallback(async () => {
    if (!selectedObject) {
      setMatchingRecordsCount(null);
      return;
    }

    // Build active filters object (only include non-empty values)
    const activeFilters = {};
    if (filters.projectId) activeFilters.projectId = filters.projectId;
    if (filters.projectObjectiveId) activeFilters.projectObjectiveId = filters.projectObjectiveId;
    if (filters.status) activeFilters.status = filters.status;
    if (filters.type) activeFilters.type = filters.type;

    // Only fetch count if there are active filters
    if (Object.keys(activeFilters).length === 0) {
      setMatchingRecordsCount(null);
      return;
    }

    setLoadingCount(true);
    try {
      const response = await apiClient.post('/update-object-fields/count', {
        objectType: selectedObject,
        filters: activeFilters
      });

      if (response.data.success) {
        setMatchingRecordsCount(response.data.count);
      } else {
        setMatchingRecordsCount(null);
      }
    } catch (error) {
      console.error('Error fetching record count:', error);
      setMatchingRecordsCount(null);
    } finally {
      setLoadingCount(false);
    }
  }, [selectedObject, filters]);

  // Fetch count when filters or object changes
  useEffect(() => {
    // Debounce count fetch to avoid too many API calls
    const timeoutId = setTimeout(() => {
      fetchMatchingRecordsCount();
    }, 500);

    return () => clearTimeout(timeoutId);
  }, [fetchMatchingRecordsCount]);

  // Search reference records when search term changes (for New Value)
  useEffect(() => {
    if (!selectedFieldInfo || selectedFieldInfo.type !== 'reference' || !selectedFieldInfo.referenceTo) {
      setReferenceSearchResults([]);
      setSearchingReference(false);
      return;
    }

    if (!referenceSearchTerm || referenceSearchTerm.trim() === '') {
      setReferenceSearchResults([]);
      setSearchingReference(false);
      return;
    }

    // Debounce search - wait 300ms after user stops typing
    setSearchingReference(true);
    const timeoutId = setTimeout(async () => {
      try {
        const response = await apiClient.get(`/update-object-fields/search-reference/${selectedFieldInfo.referenceTo}?search=${encodeURIComponent(referenceSearchTerm)}`);
        if (response.data.success) {
          setReferenceSearchResults(response.data.records || []);
          setShowReferenceDropdown(true);
        }
      } catch (error) {
        console.error('Error searching reference records:', error);
        setReferenceSearchResults([]);
      } finally {
        setSearchingReference(false);
      }
    }, 300);

    return () => {
      clearTimeout(timeoutId);
      setSearchingReference(false);
    };
  }, [referenceSearchTerm, selectedFieldInfo]);

  // Search reference records when search term changes (for Current Value)
  useEffect(() => {
    if (!selectedFieldInfo || selectedFieldInfo.type !== 'reference' || !selectedFieldInfo.referenceTo) {
      setCurrentValueReferenceSearchResults([]);
      setSearchingCurrentValueReference(false);
      return;
    }

    if (!currentValueReferenceSearchTerm || currentValueReferenceSearchTerm.trim() === '') {
      setCurrentValueReferenceSearchResults([]);
      setSearchingCurrentValueReference(false);
      return;
    }

    // Debounce search - wait 300ms after user stops typing
    setSearchingCurrentValueReference(true);
    const timeoutId = setTimeout(async () => {
      try {
        const response = await apiClient.get(`/update-object-fields/search-reference/${selectedFieldInfo.referenceTo}?search=${encodeURIComponent(currentValueReferenceSearchTerm)}`);
        if (response.data.success) {
          setCurrentValueReferenceSearchResults(response.data.records || []);
          setShowCurrentValueReferenceDropdown(true);
        }
      } catch (error) {
        console.error('Error searching reference records:', error);
        setCurrentValueReferenceSearchResults([]);
      } finally {
        setSearchingCurrentValueReference(false);
      }
    }, 300);

    return () => {
      clearTimeout(timeoutId);
      setSearchingCurrentValueReference(false);
    };
  }, [currentValueReferenceSearchTerm, selectedFieldInfo]);

  // Search reference records for multiple field updates (New Value)
  useEffect(() => {
    const timeouts = [];
    
    multipleFieldUpdates.forEach(fieldUpdate => {
      if (!fieldUpdate.fieldInfo || 
          fieldUpdate.fieldInfo.type !== 'reference' || 
          !fieldUpdate.fieldInfo.referenceTo) {
        return;
      }

      // Don't search if a value is already selected (user has chosen from dropdown)
      if (fieldUpdate.newValue && fieldUpdate.newValue.trim() !== '') {
        // If newValue is set, don't trigger new searches unless search term changed
        return;
      }

      if (!fieldUpdate.referenceSearchTerm || fieldUpdate.referenceSearchTerm.trim() === '') {
        // Clear results if search term is empty
        if (fieldUpdate.referenceSearchResults && fieldUpdate.referenceSearchResults.length > 0) {
          updateFieldUpdate(fieldUpdate.id, {
            referenceSearchResults: [],
            searchingReference: false,
            showReferenceDropdown: false
          });
        }
        return;
      }

      // Debounce search - wait 300ms after user stops typing
      const timeoutId = setTimeout(async () => {
        // Double-check that value isn't set and search term hasn't changed
        const currentField = multipleFieldUpdates.find(f => f.id === fieldUpdate.id);
        if (!currentField || currentField.newValue || currentField.referenceSearchTerm !== fieldUpdate.referenceSearchTerm) {
          return;
        }

        try {
          updateFieldUpdate(fieldUpdate.id, { searchingReference: true });
          const response = await apiClient.get(`/update-object-fields/search-reference/${fieldUpdate.fieldInfo.referenceTo}?search=${encodeURIComponent(fieldUpdate.referenceSearchTerm)}`);
          if (response.data.success) {
            // Check again before updating results - value might have been selected
            const updatedField = multipleFieldUpdates.find(f => f.id === fieldUpdate.id);
            if (updatedField && !updatedField.newValue && updatedField.referenceSearchTerm === fieldUpdate.referenceSearchTerm) {
              updateFieldUpdate(fieldUpdate.id, {
                referenceSearchResults: response.data.records || [],
                searchingReference: false,
                showReferenceDropdown: true
              });
            } else {
              updateFieldUpdate(fieldUpdate.id, {
                searchingReference: false
              });
            }
          } else {
            updateFieldUpdate(fieldUpdate.id, {
              referenceSearchResults: [],
              searchingReference: false
            });
          }
        } catch (error) {
          console.error('Error searching reference records:', error);
          updateFieldUpdate(fieldUpdate.id, {
            referenceSearchResults: [],
            searchingReference: false
          });
        }
      }, 300);
      
      timeouts.push(timeoutId);
    });

    return () => {
      timeouts.forEach(timeoutId => clearTimeout(timeoutId));
    };
  }, [multipleFieldUpdates.map(f => `${f.id}-${f.referenceSearchTerm || ''}-${f.fieldInfo?.referenceTo || ''}`).join(',')]);


  // Search reference records for multiple field updates (Current Value)
  useEffect(() => {
    const timeouts = [];
    
    multipleFieldUpdates.forEach(fieldUpdate => {
      if (!fieldUpdate.fieldInfo || 
          fieldUpdate.fieldInfo.type !== 'reference' || 
          !fieldUpdate.fieldInfo.referenceTo) {
        return;
      }

      // Don't search if a value is already selected (user has chosen from dropdown)
      if (fieldUpdate.currentValue && fieldUpdate.currentValue.trim() !== '' && fieldUpdate.currentValueReferenceSearchResults && fieldUpdate.currentValueReferenceSearchResults.length > 0) {
        // If currentValue is set and we have results, don't trigger new searches
        return;
      }

      if (!fieldUpdate.currentValueReferenceSearchTerm || fieldUpdate.currentValueReferenceSearchTerm.trim() === '') {
        // Clear results if search term is empty
        if (fieldUpdate.currentValueReferenceSearchResults && fieldUpdate.currentValueReferenceSearchResults.length > 0) {
          updateFieldUpdate(fieldUpdate.id, {
            currentValueReferenceSearchResults: [],
            searchingCurrentValueReference: false,
            showCurrentValueReferenceDropdown: false
          });
        }
        return;
      }

      // Debounce search - wait 300ms after user stops typing
      const timeoutId = setTimeout(async () => {
        // Double-check that value isn't set and search term hasn't changed
        const currentField = multipleFieldUpdates.find(f => f.id === fieldUpdate.id);
        if (!currentField || currentField.currentValue || currentField.currentValueReferenceSearchTerm !== fieldUpdate.currentValueReferenceSearchTerm) {
          return;
        }

        try {
          updateFieldUpdate(fieldUpdate.id, { searchingCurrentValueReference: true });
          const response = await apiClient.get(`/update-object-fields/search-reference/${fieldUpdate.fieldInfo.referenceTo}?search=${encodeURIComponent(fieldUpdate.currentValueReferenceSearchTerm)}`);
          if (response.data.success) {
            // Check again before updating results - value might have been selected
            const updatedField = multipleFieldUpdates.find(f => f.id === fieldUpdate.id);
            if (updatedField && !updatedField.currentValue && updatedField.currentValueReferenceSearchTerm === fieldUpdate.currentValueReferenceSearchTerm) {
              updateFieldUpdate(fieldUpdate.id, {
                currentValueReferenceSearchResults: response.data.records || [],
                searchingCurrentValueReference: false,
                showCurrentValueReferenceDropdown: true
              });
            } else {
              updateFieldUpdate(fieldUpdate.id, {
                searchingCurrentValueReference: false
              });
            }
          } else {
            updateFieldUpdate(fieldUpdate.id, {
              currentValueReferenceSearchResults: [],
              searchingCurrentValueReference: false
            });
          }
        } catch (error) {
          console.error('Error searching reference records:', error);
          updateFieldUpdate(fieldUpdate.id, {
            currentValueReferenceSearchResults: [],
            searchingCurrentValueReference: false
          });
        }
      }, 300);
      
      timeouts.push(timeoutId);
    });

    return () => {
      timeouts.forEach(timeoutId => clearTimeout(timeoutId));
    };
  }, [multipleFieldUpdates.map(f => `${f.id}-${f.currentValueReferenceSearchTerm || ''}-${f.fieldInfo?.referenceTo || ''}`).join(',')]);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (projectSearchRef.current && !projectSearchRef.current.contains(event.target)) {
        setShowProjectDropdown(false);
      }
      if (projectObjectiveSearchRef.current && !projectObjectiveSearchRef.current.contains(event.target)) {
        setShowProjectObjectiveDropdown(false);
      }
      if (referenceSearchRef.current && !referenceSearchRef.current.contains(event.target)) {
        setShowReferenceDropdown(false);
      }
      if (currentValueReferenceSearchRef.current && !currentValueReferenceSearchRef.current.contains(event.target)) {
        setShowCurrentValueReferenceDropdown(false);
      }
      
      // Close reference dropdowns for multiple field updates
      multipleFieldUpdates.forEach(fieldUpdate => {
        if (fieldUpdate.fieldInfo && fieldUpdate.fieldInfo.type === 'reference') {
          // We'll handle this with refs if needed, but for now we'll use a simpler approach
        }
      });
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [multipleFieldUpdates]);

  const addFieldUpdate = () => {
    setMultipleFieldUpdates([...multipleFieldUpdates, {
      id: Date.now(),
      fieldName: '',
      updateMode: 'all',
      currentValue: '',
      newValue: '',
      fieldInfo: null,
      picklistValues: [],
      referenceSearchTerm: '',
      referenceSearchResults: [],
      searchingReference: false,
      showReferenceDropdown: false,
      currentValueReferenceSearchTerm: '',
      currentValueReferenceSearchResults: [],
      searchingCurrentValueReference: false,
      showCurrentValueReferenceDropdown: false
    }]);
  };

  const removeFieldUpdate = (id) => {
    if (multipleFieldUpdates.length > 1) {
      setMultipleFieldUpdates(multipleFieldUpdates.filter(field => field.id !== id));
    } else {
      toast.error('At least one field update is required');
    }
  };

  const updateFieldUpdate = (id, updates) => {
    setMultipleFieldUpdates(multipleFieldUpdates.map(field => 
      field.id === id ? { ...field, ...updates } : field
    ));
  };

  const handlePreview = async () => {
    // Build filters object (only include non-empty values)
    const activeFilters = {};
    if (filters.projectId) activeFilters.projectId = filters.projectId;
    if (filters.projectObjectiveId) activeFilters.projectObjectiveId = filters.projectObjectiveId;
    if (filters.status) activeFilters.status = filters.status;
    if (filters.type) activeFilters.type = filters.type;

    setLoadingPreview(true);
    try {
      if (updateModeType === 'single') {
        // Single field preview
        if (!selectedObject || !selectedField || !newValue) {
          toast.error('Please select an object, field, and enter a new value');
          setLoadingPreview(false);
          return;
        }

        if (updateMode === 'specific' && !currentValue) {
          toast.error('Please enter the current value to update');
          setLoadingPreview(false);
          return;
        }

        const response = await apiClient.post('/update-object-fields/preview', {
          objectType: selectedObject,
          fieldName: selectedField,
          updateMode: updateMode,
          currentValue: updateMode === 'specific' ? currentValue : null,
          newValue: newValue,
          filters: Object.keys(activeFilters).length > 0 ? activeFilters : null
        });

        if (response.data.success) {
          setPreviewData({
            type: 'single',
            objectType: selectedObject,
            fieldName: selectedField,
            fieldLabel: response.data.fieldLabel || selectedField,
            totalCount: response.data.totalCount,
            sampleCount: response.data.sampleCount,
            isApproximate: response.data.isApproximate || false,
            records: response.data.records
          });
          setShowPreviewModal(true);
        } else {
          toast.error(response.data.error || 'Failed to preview update');
        }
      } else if (updateModeType === 'multiple') {
        // Multiple field preview
        if (!selectedObject) {
          toast.error('Please select an object');
          setLoadingPreview(false);
          return;
        }

        // Validate all field updates
        const validUpdates = multipleFieldUpdates.filter(field => 
          field.fieldName && field.newValue && 
          (field.updateMode === 'all' || (field.updateMode === 'specific' && field.currentValue))
        );

        if (validUpdates.length === 0) {
          toast.error('Please add at least one valid field update (field name and new value required)');
          setLoadingPreview(false);
          return;
        }

        const fieldUpdates = validUpdates.map(field => ({
          fieldName: field.fieldName,
          updateMode: field.updateMode,
          currentValue: field.updateMode === 'specific' ? field.currentValue : null,
          newValue: field.newValue
        }));

        const response = await apiClient.post('/update-object-fields/preview-multiple', {
          objectType: selectedObject,
          fieldUpdates: fieldUpdates,
          filters: Object.keys(activeFilters).length > 0 ? activeFilters : null
        });

        if (response.data.success) {
          setPreviewData({
            type: 'multiple',
            objectType: selectedObject,
            fields: response.data.fields,
            totalCount: response.data.totalCount,
            sampleCount: response.data.sampleCount,
            isApproximate: response.data.isApproximate || false,
            records: response.data.records
          });
          setShowPreviewModal(true);
        } else {
          toast.error(response.data.error || 'Failed to preview update');
        }
      } else if (updateModeType === 'mapping') {
        // Field mapping preview
        if (!selectedObject || !sourceObject) {
          toast.error('Please select both source and target objects');
          setLoadingPreview(false);
          return;
        }

        // Validate all field mappings
        const validMappings = fieldMappings.filter(m => {
          if (!m.targetField) return false;
          if (m.transformation === 'formula') return !!m.formula;
          if (m.transformation === 'concatenate') return m.concatenateFields && m.concatenateFields.length > 0;
          if (m.transformation === 'valueMap') {
            return m.valueMappings && m.valueMappings.length > 0 && 
                   m.valueMappings.some(vm => vm.from && vm.to);
          }
          if (m.transformation === 'conditional') {
            // Support both legacy single condition and new multiple conditions
            if (m.conditions && Array.isArray(m.conditions) && m.conditions.length > 0) {
              // New multiple conditions format
              return m.conditions.every(cond => cond.field && cond.operator && 
                (['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(cond.operator) || cond.value !== undefined)) &&
                m.thenValue !== undefined && m.thenValue !== '';
            } else {
              // Legacy single condition format
              return m.conditionField && m.conditionValue !== undefined && m.conditionValue !== '' && m.thenValue !== undefined && m.thenValue !== '';
            }
          }
          if (m.transformation === 'textReplace') {
            return m.findText && m.findText.trim() !== '' && m.replaceText !== undefined;
          }
          if (m.transformation === 'defaultValue') {
            return m.sourceField && m.defaultValue !== undefined;
          }
          if (m.transformation === 'typeConversion') {
            return m.sourceField && m.targetType;
          }
          if (m.transformation === 'validateFormat') {
            return m.sourceField && m.validationType && (m.validationType !== 'custom' || m.customPattern);
          }
          if (m.transformation === 'removeSpecialChars') {
            return m.sourceField && m.removeMode;
          }
          if (m.transformation === 'switch') {
            return m.sourceField && m.cases && m.cases.length > 0 && m.cases.some(c => c.value && c.targetValue);
          }
          return !!m.sourceField;
        });

        if (validMappings.length === 0) {
          toast.error('Please add at least one valid field mapping');
          setLoadingPreview(false);
          return;
        }

        const mappings = validMappings.map(m => ({
          targetField: m.targetField,
          sourceField: m.sourceField,
          transformation: m.transformation,
          formula: m.formula,
          concatenateFields: m.concatenateFields,
          separator: m.separator,
          dateFormat: m.dateFormat,
          numberFormat: m.numberFormat,
          valueMappings: m.valueMappings,
          conditionField: m.conditionField,
          conditionValue: m.conditionValue,
          conditionOperator: m.conditionOperator,
          thenValue: m.thenValue,
          elseValue: m.elseValue,
          // Enhanced conditional
          conditions: m.conditions,
          // Text replacement
          findText: m.findText,
          replaceText: m.replaceText,
          replaceMode: m.replaceMode,
          caseSensitive: m.caseSensitive,
          useRegex: m.useRegex,
          // Default value
          defaultValue: m.defaultValue,
          applyWhen: m.applyWhen,
          // Type conversion
          targetType: m.targetType,
          conversionFormat: m.conversionFormat,
          // Format validation
          validationType: m.validationType,
          customPattern: m.customPattern,
          onInvalid: m.onInvalid,
          // Remove special chars
          removeMode: m.removeMode,
          // Switch/Case
          cases: m.cases,
          switchDefaultValue: m.switchDefaultValue,
          // Error handling
          errorHandling: m.errorHandling || errorHandlingMode
        }));

        const response = await apiClient.post('/update-object-fields/preview-mapping', {
          sourceObject: sourceObject,
          targetObject: selectedObject,
          mappings: mappings,
          filters: Object.keys(activeFilters).length > 0 ? activeFilters : null
        });

        if (response.data.success) {
          setPreviewData({
            type: 'mapping',
            sourceObject: sourceObject,
            targetObject: selectedObject,
            mappings: response.data.mappings,
            totalCount: response.data.totalCount,
            sampleCount: response.data.sampleCount,
            isApproximate: response.data.isApproximate || false,
            records: response.data.records
          });
          setShowPreviewModal(true);
        } else {
          toast.error(response.data.error || 'Failed to preview field mapping');
        }
      }
    } catch (error) {
      console.error('Error previewing update:', error);
      console.error('Error response:', error.response?.data);
      const errorMessage = error.response?.data?.error || error.message || 'Failed to preview update';
      toast.error(errorMessage);
      if (error.response?.data?.details && process.env.NODE_ENV === 'development') {
        console.error('Error details:', error.response.data.details);
      }
    } finally {
      setLoadingPreview(false);
    }
  };

  const handleUpdate = async () => {
    // Build filters object (only include non-empty values)
    const activeFilters = {};
    if (filters.projectId) activeFilters.projectId = filters.projectId;
    if (filters.projectObjectiveId) activeFilters.projectObjectiveId = filters.projectObjectiveId;
    if (filters.status) activeFilters.status = filters.status;
    if (filters.type) activeFilters.type = filters.type;

    if (updateModeType === 'single') {
      // Single field update (existing logic)
      if (!selectedObject || !selectedField || !newValue) {
        toast.error('Please select an object, field, and enter a new value');
        return;
      }

      if (updateMode === 'specific' && !currentValue) {
        toast.error('Please enter the current value to update');
        return;
      }

      // Warn user if no filters are applied (will update ALL records)
      const hasFilters = Object.keys(activeFilters).length > 0;
      let confirmMessage = '';
      if (!hasFilters) {
        confirmMessage = `Warning: No filters are applied. This will update ALL ${selectedObject} records.\n\nAre you sure you want to continue?`;
      } else {
        // Show confirmation with filter info
        const filterInfo = Object.entries(activeFilters)
          .map(([key, value]) => {
            if (key === 'projectId') return `Project: ${filters.projectName || value}`;
            if (key === 'projectObjectiveId') return `Project Objective: ${filters.projectObjectiveName || value}`;
            if (key === 'status') return `Status: ${value}`;
            if (key === 'type') return `Type: ${value}`;
            return `${key}: ${value}`;
          })
          .join(', ');
        
        confirmMessage = `This will update ${selectedObject} records matching the following filters:\n${filterInfo}\n\nContinue?`;
      }

      // Show confirmation modal
      setConfirmModalData({
        message: confirmMessage,
        onConfirm: async () => {
          setShowConfirmModal(false);
          setUpdating(true);
          try {
            const response = await apiClient.post('/update-object-fields/update', {
              objectType: selectedObject,
              fieldName: selectedField,
              updateMode: updateMode,
              currentValue: updateMode === 'specific' ? currentValue : null,
              newValue: newValue,
              filters: Object.keys(activeFilters).length > 0 ? activeFilters : null
            });

            if (response.data.success) {
              toast.success(response.data.message || `Successfully updated ${response.data.updatedCount} record(s)`);
              setNewValue('');
              setCurrentValue('');
              if (updateMode === 'specific') {
                setUpdateMode('all');
              }
            } else {
              toast.error(response.data.error || 'Failed to update records');
            }
          } catch (error) {
            console.error('Error updating records:', error);
            toast.error(error.response?.data?.error || 'Failed to update records in Salesforce');
          } finally {
            setUpdating(false);
          }
        },
        onCancel: () => {
          setShowConfirmModal(false);
        }
      });
      setShowConfirmModal(true);
      return;
    }
    
    if (updateModeType === 'multiple') {
      // Multiple field updates
      if (!selectedObject) {
        toast.error('Please select an object');
        return;
      }

      // Validate all field updates
      const validUpdates = multipleFieldUpdates.filter(field => 
        field.fieldName && field.newValue && 
        (field.updateMode === 'all' || (field.updateMode === 'specific' && field.currentValue))
      );

      if (validUpdates.length === 0) {
        toast.error('Please add at least one valid field update (field name and new value required)');
        return;
      }

      // Get field names for display
      const fieldNamesList = validUpdates.map(fieldUpdate => {
        const field = fields.find(f => f.name === fieldUpdate.fieldName);
        return field ? field.label : fieldUpdate.fieldName;
      }).join(', ');
      
      // Warn user if no filters are applied
      const hasFilters = Object.keys(activeFilters).length > 0;
      let confirmMessage = '';
      if (!hasFilters) {
        confirmMessage = `Warning: No filters are applied. This will update ALL ${selectedObject} records with ${validUpdates.length} field(s):\n${fieldNamesList}\n\nAre you sure you want to continue?`;
      } else {
        const filterInfo = Object.entries(activeFilters)
          .map(([key, value]) => {
            if (key === 'projectId') return `Project: ${filters.projectName || value}`;
            if (key === 'projectObjectiveId') return `Project Objective: ${filters.projectObjectiveName || value}`;
            if (key === 'status') return `Status: ${value}`;
            if (key === 'type') return `Type: ${value}`;
            return `${key}: ${value}`;
          })
          .join(', ');
        
        confirmMessage = `This will update ${selectedObject} records matching the following filters:\n${filterInfo}\n\nWith ${validUpdates.length} field update(s):\n${fieldNamesList}\n\nContinue?`;
      }

      // Show confirmation modal
      setConfirmModalData({
        message: confirmMessage,
        onConfirm: async () => {
          setShowConfirmModal(false);
          setUpdating(true);
          try {
            const fieldUpdates = validUpdates.map(field => ({
              fieldName: field.fieldName,
              updateMode: field.updateMode,
              currentValue: field.updateMode === 'specific' ? field.currentValue : null,
              newValue: field.newValue
            }));

            const response = await apiClient.post('/update-object-fields/update-multiple', {
              objectType: selectedObject,
              fieldUpdates: fieldUpdates,
              filters: Object.keys(activeFilters).length > 0 ? activeFilters : null
            });

            if (response.data.success) {
              toast.success(response.data.message || `Successfully updated ${response.data.updatedCount} record(s) with ${fieldUpdates.length} field(s)`);
              // Reset multiple field updates
              setMultipleFieldUpdates([{
                id: Date.now(),
                fieldName: '',
                updateMode: 'all',
                currentValue: '',
                newValue: '',
                fieldInfo: null,
                picklistValues: [],
                referenceSearchTerm: '',
                referenceSearchResults: [],
                searchingReference: false,
                showReferenceDropdown: false,
                currentValueReferenceSearchTerm: '',
                currentValueReferenceSearchResults: [],
                searchingCurrentValueReference: false,
                showCurrentValueReferenceDropdown: false
              }]);
            } else {
              toast.error(response.data.error || 'Failed to update records');
            }
          } catch (error) {
            console.error('Error updating records:', error);
            toast.error(error.response?.data?.error || 'Failed to update records in Salesforce');
          } finally {
            setUpdating(false);
          }
        },
        onCancel: () => {
          setShowConfirmModal(false);
        }
      });
      setShowConfirmModal(true);
      return;
    }

    if (updateModeType === 'mapping') {
      // Field mapping updates
      if (!selectedObject || !sourceObject) {
        toast.error('Please select both source and target objects');
        return;
      }

      // Validate all field mappings
      const validMappings = fieldMappings.filter(m => {
        if (!m.targetField) return false;
        if (m.transformation === 'formula') return !!m.formula;
        if (m.transformation === 'concatenate') return m.concatenateFields && m.concatenateFields.length > 0;
        if (m.transformation === 'valueMap') {
          return m.valueMappings && m.valueMappings.length > 0 && 
                 m.valueMappings.some(vm => vm.from && vm.to);
        }
        if (m.transformation === 'conditional') {
          return m.conditionField && m.conditionValue !== undefined && m.conditionValue !== '' && m.thenValue !== undefined && m.thenValue !== '';
        }
        return !!m.sourceField;
      });

      if (validMappings.length === 0) {
        toast.error('Please add at least one valid field mapping');
        return;
      }

      // Get mapping info for display
      const mappingInfo = validMappings.map(m => {
        const targetField = fields.find(f => f.name === m.targetField);
        const sourceField = sourceFields.find(f => f.name === m.sourceField);
        return `${targetField ? targetField.label : m.targetField} ← ${sourceField ? sourceField.label : m.sourceField} (${m.transformation})`;
      }).join('\n');

      // Warn user if no filters are applied
      const hasFilters = Object.keys(activeFilters).length > 0;
      let confirmMessage = '';
      if (!hasFilters) {
        confirmMessage = `Warning: No filters are applied. This will update ALL ${selectedObject} records by mapping fields from ${sourceObject}:\n\n${mappingInfo}\n\nAre you sure you want to continue?`;
      } else {
        const filterInfo = Object.entries(activeFilters)
          .map(([key, value]) => {
            if (key === 'projectId') return `Project: ${filters.projectName || value}`;
            if (key === 'projectObjectiveId') return `Project Objective: ${filters.projectObjectiveName || value}`;
            if (key === 'status') return `Status: ${value}`;
            if (key === 'type') return `Type: ${value}`;
            return `${key}: ${value}`;
          })
          .join(', ');
        
        confirmMessage = `This will update ${selectedObject} records matching the following filters:\n${filterInfo}\n\nBy mapping fields from ${sourceObject}:\n${mappingInfo}\n\nContinue?`;
      }

      // Show confirmation modal
      setConfirmModalData({
        message: confirmMessage,
        onConfirm: async () => {
          setShowConfirmModal(false);
          setUpdating(true);
          try {
            const mappings = validMappings.map(m => ({
              targetField: m.targetField,
              sourceField: m.sourceField,
              transformation: m.transformation,
              formula: m.formula,
              concatenateFields: m.concatenateFields,
              separator: m.separator,
              dateFormat: m.dateFormat,
              numberFormat: m.numberFormat,
              valueMappings: m.valueMappings,
              conditionField: m.conditionField,
              conditionValue: m.conditionValue,
              conditionOperator: m.conditionOperator,
              thenValue: m.thenValue,
              elseValue: m.elseValue,
              // Enhanced conditional
              conditions: m.conditions,
              // Text replacement
              findText: m.findText,
              replaceText: m.replaceText,
              replaceMode: m.replaceMode,
              caseSensitive: m.caseSensitive,
              useRegex: m.useRegex,
              // Default value
              defaultValue: m.defaultValue,
              applyWhen: m.applyWhen,
              // Type conversion
              targetType: m.targetType,
              conversionFormat: m.conversionFormat,
              // Format validation
              validationType: m.validationType,
              customPattern: m.customPattern,
              onInvalid: m.onInvalid,
              // Remove special chars
              removeMode: m.removeMode,
              // Switch/Case
              cases: m.cases,
              switchDefaultValue: m.switchDefaultValue,
              // Error handling
              errorHandling: m.errorHandling || errorHandlingMode
            }));

            const response = await apiClient.post('/update-object-fields/update-mapping', {
              sourceObject: sourceObject,
              targetObject: selectedObject,
              mappings: mappings,
              filters: Object.keys(activeFilters).length > 0 ? activeFilters : null,
              batchSize: batchSize,
              errorHandlingMode: errorHandlingMode
            });

            if (response.data.success) {
              if (response.data.errorCount > 0) {
                // Partial success
                toast.success(
                  response.data.message || 
                  `Updated ${response.data.updatedCount} record(s). ${response.data.errorCount} failed.`,
                  { duration: 5000 }
                );
                if (response.data.errors && response.data.errors.length > 0) {
                  console.warn('Update errors:', response.data.errors);
                }
              } else {
                toast.success(response.data.message || `Successfully updated ${response.data.updatedCount} record(s) with ${mappings.length} field mapping(s)`);
              }
              // Reset field mappings
              setFieldMappings([{
                id: Date.now(),
                targetField: '',
                sourceField: '',
                transformation: 'copy',
                formula: '',
                concatenateFields: [],
                separator: ' ',
                dateFormat: 'YYYY-MM-DD',
                numberFormat: '0.00'
              }]);
            } else {
              const errorDetails = response.data.errors ? 
                `Errors: ${response.data.errors.slice(0, 3).map(e => e.error || e).join('; ')}` : '';
              toast.error(errorDetails ? `${response.data.error}. ${errorDetails}` : response.data.error || 'Failed to update records');
            }
          } catch (error) {
            console.error('Error updating records:', error);
            console.error('Error response:', error.response?.data);
            const errorMessage = error.response?.data?.error || error.message || 'Failed to update records in Salesforce';
            const errorDetails = error.response?.data?.errors ? 
              `Errors: ${error.response.data.errors.slice(0, 3).map(e => e.error || e).join('; ')}` : '';
            toast.error(errorDetails ? `${errorMessage}. ${errorDetails}` : errorMessage);
            if (error.response?.data?.details && process.env.NODE_ENV === 'development') {
              console.error('Error details:', error.response.data.details);
            }
          } finally {
            setUpdating(false);
          }
        },
        onCancel: () => {
          setShowConfirmModal(false);
        }
      });
      setShowConfirmModal(true);
      return;
    }
  };

  const renderValueInput = () => {
    if (!selectedFieldInfo) return null;

    // If it's a picklist field, show dropdown
    if (selectedFieldInfo.type === 'picklist' || selectedFieldInfo.type === 'multipicklist') {
      return (
        <div className="form-group">
          <label>
            New Value *
            {selectedFieldInfo.required && <span style={{ color: 'red' }}> *</span>}
          </label>
          <select
            value={newValue}
            onChange={(e) => setNewValue(e.target.value)}
            style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
          >
            <option value="">--Select Value--</option>
            {picklistValues.map((value, index) => (
              <option key={index} value={value}>{value}</option>
            ))}
          </select>
        </div>
      );
    }

    // If it's a reference field, show searchable input
    if (selectedFieldInfo.type === 'reference' && selectedFieldInfo.referenceTo) {
      return (
        <div className="form-group" style={{ position: 'relative', zIndex: 10000 }} ref={referenceSearchRef}>
          <label>
            New Value *
            {selectedFieldInfo.required && <span style={{ color: 'red' }}> *</span>}
          </label>
          <div style={{ position: 'relative' }}>
            <input
              type="text"
              value={referenceSearchTerm}
              onChange={(e) => {
                const value = e.target.value;
                setReferenceSearchTerm(value);
                if (!value || value.trim() === '') {
                  setNewValue('');
                }
                setShowReferenceDropdown(true);
              }}
              onFocus={() => {
                if (referenceSearchTerm.trim() !== '') {
                  setShowReferenceDropdown(true);
                }
              }}
              placeholder={`Search ${selectedFieldInfo.referenceTo}...`}
              style={{ 
                fontSize: '12px', 
                padding: '6px 10px', 
                paddingRight: '36px',
                height: '32px', 
                width: '100%' 
              }}
            />
            <Search 
              size={14} 
              style={{ 
                position: 'absolute', 
                right: '10px', 
                top: '50%', 
                transform: 'translateY(-50%)', 
                color: '#666',
                pointerEvents: 'none'
              }} 
            />
            {searchingReference && (
              <div style={{ 
                position: 'absolute', 
                right: '36px', 
                top: '50%', 
                transform: 'translateY(-50%)',
                fontSize: '12px',
                color: '#666'
              }}>
                Searching...
              </div>
            )}
            {showReferenceDropdown && (referenceSearchResults.length > 0 || referenceSearchTerm.trim() === '' || searchingReference) && (
              <div style={{
                position: 'absolute',
                top: '100%',
                left: 0,
                right: 0,
                marginTop: '4px',
                backgroundColor: '#ffffff',
                border: '1px solid #e5e7eb',
                borderRadius: '6px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                zIndex: 9999,
                maxHeight: '200px',
                overflowY: 'auto'
              }}>
                {searchingReference ? (
                  <div style={{
                    padding: '6px 10px',
                    fontSize: '12px',
                    color: '#666',
                    textAlign: 'center'
                  }}>
                    Searching...
                  </div>
                ) : referenceSearchResults.length > 0 ? (
                  referenceSearchResults.map((record) => (
                    <div
                      key={record.id}
                      onClick={() => {
                        setNewValue(record.id);
                        setReferenceSearchTerm(record.name);
                        setShowReferenceDropdown(false);
                      }}
                      style={{
                        padding: '6px 10px',
                        cursor: 'pointer',
                        fontSize: '12px',
                        borderBottom: '1px solid #f3f4f6',
                        color: '#000000',
                        backgroundColor: '#ffffff'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#f9fafb';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                      }}
                    >
                      <div style={{ fontWeight: '500', color: '#000000' }}>{record.name}</div>
                    </div>
                  ))
                ) : (
                  <div style={{
                    padding: '6px 10px',
                    fontSize: '12px',
                    color: '#666',
                    textAlign: 'center'
                  }}>
                    {referenceSearchTerm.trim() ? 'No records found' : 'Start typing to search...'}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    // For other field types, show text input
    return (
      <div className="form-group">
        <label>
          New Value *
          {selectedFieldInfo.required && <span style={{ color: 'red' }}> *</span>}
        </label>
        <input
          type="text"
          value={newValue}
          onChange={(e) => setNewValue(e.target.value)}
          placeholder={`Enter new value for ${selectedFieldInfo.label}`}
          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
        />
      </div>
    );
  };

  const renderCurrentValueInput = () => {
    if (updateMode !== 'specific') return null;
    if (!selectedFieldInfo) return null;

    // If it's a picklist field, show dropdown
    if (selectedFieldInfo.type === 'picklist' || selectedFieldInfo.type === 'multipicklist') {
      return (
        <div className="form-group">
          <label>
            Current Value (to update) *
          </label>
          <select
            value={currentValue}
            onChange={(e) => setCurrentValue(e.target.value)}
            style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
          >
            <option value="">--Select Current Value--</option>
            {picklistValues.map((value, index) => (
              <option key={index} value={value}>{value}</option>
            ))}
          </select>
        </div>
      );
    }

    // If it's a reference field, show searchable input
    if (selectedFieldInfo.type === 'reference' && selectedFieldInfo.referenceTo) {
      return (
        <div className="form-group" style={{ position: 'relative', zIndex: 10000 }} ref={currentValueReferenceSearchRef}>
          <label>
            Current Value (to update) *
          </label>
          <div style={{ position: 'relative' }}>
            <input
              type="text"
              value={currentValueReferenceSearchTerm}
              onChange={(e) => {
                const value = e.target.value;
                setCurrentValueReferenceSearchTerm(value);
                if (!value || value.trim() === '') {
                  setCurrentValue('');
                }
                setShowCurrentValueReferenceDropdown(true);
              }}
              onFocus={() => {
                if (currentValueReferenceSearchTerm.trim() !== '') {
                  setShowCurrentValueReferenceDropdown(true);
                }
              }}
              placeholder={`Search ${selectedFieldInfo.referenceTo}...`}
              style={{ 
                fontSize: '12px', 
                padding: '6px 10px', 
                paddingRight: '36px',
                height: '32px', 
                width: '100%' 
              }}
            />
            <Search 
              size={14} 
              style={{ 
                position: 'absolute', 
                right: '10px', 
                top: '50%', 
                transform: 'translateY(-50%)', 
                color: '#666',
                pointerEvents: 'none'
              }} 
            />
            {searchingCurrentValueReference && (
              <div style={{ 
                position: 'absolute', 
                right: '36px', 
                top: '50%', 
                transform: 'translateY(-50%)',
                fontSize: '12px',
                color: '#666'
              }}>
                Searching...
              </div>
            )}
            {showCurrentValueReferenceDropdown && (currentValueReferenceSearchResults.length > 0 || currentValueReferenceSearchTerm.trim() === '' || searchingCurrentValueReference) && (
              <div style={{
                position: 'absolute',
                top: '100%',
                left: 0,
                right: 0,
                marginTop: '4px',
                backgroundColor: '#ffffff',
                border: '1px solid #e5e7eb',
                borderRadius: '6px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                zIndex: 9999,
                maxHeight: '200px',
                overflowY: 'auto'
              }}>
                {searchingCurrentValueReference ? (
                  <div style={{
                    padding: '6px 10px',
                    fontSize: '12px',
                    color: '#666',
                    textAlign: 'center'
                  }}>
                    Searching...
                  </div>
                ) : currentValueReferenceSearchResults.length > 0 ? (
                  currentValueReferenceSearchResults.map((record) => (
                    <div
                      key={record.id}
                      onClick={() => {
                        setCurrentValue(record.id);
                        setCurrentValueReferenceSearchTerm(record.name);
                        setShowCurrentValueReferenceDropdown(false);
                      }}
                      style={{
                        padding: '6px 10px',
                        cursor: 'pointer',
                        fontSize: '12px',
                        borderBottom: '1px solid #f3f4f6',
                        color: '#000000',
                        backgroundColor: '#ffffff'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#f9fafb';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = '#ffffff';
                      }}
                    >
                      <div style={{ fontWeight: '500', color: '#000000' }}>{record.name}</div>
                    </div>
                  ))
                ) : (
                  <div style={{
                    padding: '6px 10px',
                    fontSize: '12px',
                    color: '#666',
                    textAlign: 'center'
                  }}>
                    {currentValueReferenceSearchTerm.trim() ? 'No records found' : 'Start typing to search...'}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    // For other field types, show text input
    return (
      <div className="form-group">
        <label>
          Current Value (to update) *
        </label>
        <input
          type="text"
          value={currentValue}
          onChange={(e) => setCurrentValue(e.target.value)}
          placeholder={`Enter current value to update`}
          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
        />
      </div>
    );
  };

  const renderMultipleFieldValueInput = (fieldUpdate) => {
    if (!fieldUpdate.fieldInfo) {
      return (
        <input
          type="text"
          value={fieldUpdate.newValue}
          onChange={(e) => updateFieldUpdate(fieldUpdate.id, { newValue: e.target.value })}
          placeholder="Select a field first"
          disabled
          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
        />
      );
    }

    // If it's a picklist field, show dropdown
    if (fieldUpdate.fieldInfo.type === 'picklist' || fieldUpdate.fieldInfo.type === 'multipicklist') {
      return (
        <select
          value={fieldUpdate.newValue}
          onChange={(e) => updateFieldUpdate(fieldUpdate.id, { newValue: e.target.value })}
          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
        >
          <option value="">--Select Value--</option>
          {(fieldUpdate.picklistValues || []).map((value, index) => (
            <option key={index} value={value}>{value}</option>
          ))}
        </select>
      );
    }

    // If it's a reference field, show searchable input
    if (fieldUpdate.fieldInfo.type === 'reference' && fieldUpdate.fieldInfo.referenceTo) {
      return (
        <div style={{ position: 'relative' }}>
          <input
            type="text"
            value={fieldUpdate.referenceSearchTerm || ''}
            onChange={(e) => {
              const value = e.target.value;
              // If user is typing, clear the selected value to allow new search
              updateFieldUpdate(fieldUpdate.id, { 
                referenceSearchTerm: value,
                showReferenceDropdown: true,
                newValue: '' // Clear selected value when user types
              });
            }}
            onFocus={() => {
              if (fieldUpdate.referenceSearchTerm && fieldUpdate.referenceSearchTerm.trim() !== '') {
                updateFieldUpdate(fieldUpdate.id, { showReferenceDropdown: true });
              }
            }}
            placeholder={`Search ${fieldUpdate.fieldInfo.referenceTo}...`}
            style={{ 
              fontSize: '12px', 
              padding: '6px 10px', 
              paddingRight: '36px',
              height: '32px', 
              width: '100%' 
            }}
          />
          <Search 
            size={14} 
            style={{ 
              position: 'absolute', 
              right: '10px', 
              top: '50%', 
              transform: 'translateY(-50%)', 
              color: '#666',
              pointerEvents: 'none'
            }} 
          />
          {fieldUpdate.searchingReference && (
            <div style={{ 
              position: 'absolute', 
              right: '36px', 
              top: '50%', 
              transform: 'translateY(-50%)',
              fontSize: '12px',
              color: '#666'
            }}>
              Searching...
            </div>
          )}
          {fieldUpdate.showReferenceDropdown && (fieldUpdate.referenceSearchResults && fieldUpdate.referenceSearchResults.length > 0 || (fieldUpdate.referenceSearchTerm && fieldUpdate.referenceSearchTerm.trim() === '') || fieldUpdate.searchingReference) && (
            <div style={{
              position: 'absolute',
              top: '100%',
              left: 0,
              right: 0,
              marginTop: '4px',
              backgroundColor: '#ffffff',
              border: '1px solid #e5e7eb',
              borderRadius: '6px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
              zIndex: 9999,
              maxHeight: '200px',
              overflowY: 'auto'
            }}>
              {fieldUpdate.searchingReference ? (
                <div style={{
                  padding: '6px 10px',
                  fontSize: '12px',
                  color: '#666',
                  textAlign: 'center'
                }}>
                  Searching...
                </div>
              ) : fieldUpdate.referenceSearchResults && fieldUpdate.referenceSearchResults.length > 0 ? (
                fieldUpdate.referenceSearchResults.map((record) => (
                  <div
                    key={record.id}
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      updateFieldUpdate(fieldUpdate.id, {
                        newValue: record.id,
                        referenceSearchTerm: record.name,
                        showReferenceDropdown: false,
                        searchingReference: false,
                        referenceSearchResults: [] // Clear results to prevent re-searching
                      });
                    }}
                    style={{
                      padding: '6px 10px',
                      cursor: 'pointer',
                      fontSize: '12px',
                      borderBottom: '1px solid #f3f4f6',
                      color: '#000000',
                      backgroundColor: '#ffffff'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#f9fafb';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = '#ffffff';
                    }}
                  >
                    <div style={{ fontWeight: '500', color: '#000000' }}>{record.name}</div>
                  </div>
                ))
              ) : (
                <div style={{
                  padding: '6px 10px',
                  fontSize: '12px',
                  color: '#666',
                  textAlign: 'center'
                }}>
                  {fieldUpdate.referenceSearchTerm && fieldUpdate.referenceSearchTerm.trim() ? 'No records found' : 'Start typing to search...'}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // For other field types, show text input
    return (
      <input
        type="text"
        value={fieldUpdate.newValue}
        onChange={(e) => updateFieldUpdate(fieldUpdate.id, { newValue: e.target.value })}
        placeholder={`Enter new value for ${fieldUpdate.fieldInfo.label}`}
        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
      />
    );
  };

  const renderMultipleFieldCurrentValueInput = (fieldUpdate) => {
    if (!fieldUpdate.fieldInfo) {
      return (
        <input
          type="text"
          value={fieldUpdate.currentValue}
          onChange={(e) => updateFieldUpdate(fieldUpdate.id, { currentValue: e.target.value })}
          placeholder="Select a field first"
          disabled
          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
        />
      );
    }

    // If it's a picklist field, show dropdown
    if (fieldUpdate.fieldInfo.type === 'picklist' || fieldUpdate.fieldInfo.type === 'multipicklist') {
      return (
        <select
          value={fieldUpdate.currentValue}
          onChange={(e) => updateFieldUpdate(fieldUpdate.id, { currentValue: e.target.value })}
          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
        >
          <option value="">--Select Current Value--</option>
          {(fieldUpdate.picklistValues || []).map((value, index) => (
            <option key={index} value={value}>{value}</option>
          ))}
        </select>
      );
    }

    // If it's a reference field, show searchable input
    if (fieldUpdate.fieldInfo.type === 'reference' && fieldUpdate.fieldInfo.referenceTo) {
      return (
        <div style={{ position: 'relative' }}>
          <input
            type="text"
            value={fieldUpdate.currentValueReferenceSearchTerm || ''}
            onChange={(e) => {
              const value = e.target.value;
              // If user is typing, clear the selected value to allow new search
              updateFieldUpdate(fieldUpdate.id, { 
                currentValueReferenceSearchTerm: value,
                showCurrentValueReferenceDropdown: true,
                currentValue: '' // Clear selected value when user types
              });
            }}
            onFocus={() => {
              if (fieldUpdate.currentValueReferenceSearchTerm && fieldUpdate.currentValueReferenceSearchTerm.trim() !== '') {
                updateFieldUpdate(fieldUpdate.id, { showCurrentValueReferenceDropdown: true });
              }
            }}
            placeholder={`Search ${fieldUpdate.fieldInfo.referenceTo}...`}
            style={{ 
              fontSize: '12px', 
              padding: '6px 10px', 
              paddingRight: '36px',
              height: '32px', 
              width: '100%' 
            }}
          />
          <Search 
            size={14} 
            style={{ 
              position: 'absolute', 
              right: '10px', 
              top: '50%', 
              transform: 'translateY(-50%)', 
              color: '#666',
              pointerEvents: 'none'
            }} 
          />
          {fieldUpdate.searchingCurrentValueReference && (
            <div style={{ 
              position: 'absolute', 
              right: '36px', 
              top: '50%', 
              transform: 'translateY(-50%)',
              fontSize: '12px',
              color: '#666'
            }}>
              Searching...
            </div>
          )}
          {fieldUpdate.showCurrentValueReferenceDropdown && (fieldUpdate.currentValueReferenceSearchResults && fieldUpdate.currentValueReferenceSearchResults.length > 0 || (fieldUpdate.currentValueReferenceSearchTerm && fieldUpdate.currentValueReferenceSearchTerm.trim() === '') || fieldUpdate.searchingCurrentValueReference) && (
            <div style={{
              position: 'absolute',
              top: '100%',
              left: 0,
              right: 0,
              marginTop: '4px',
              backgroundColor: '#ffffff',
              border: '1px solid #e5e7eb',
              borderRadius: '6px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
              zIndex: 9999,
              maxHeight: '200px',
              overflowY: 'auto'
            }}>
              {fieldUpdate.searchingCurrentValueReference ? (
                <div style={{
                  padding: '6px 10px',
                  fontSize: '12px',
                  color: '#666',
                  textAlign: 'center'
                }}>
                  Searching...
                </div>
              ) : fieldUpdate.currentValueReferenceSearchResults && fieldUpdate.currentValueReferenceSearchResults.length > 0 ? (
                fieldUpdate.currentValueReferenceSearchResults.map((record) => (
                  <div
                    key={record.id}
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      updateFieldUpdate(fieldUpdate.id, {
                        currentValue: record.id,
                        currentValueReferenceSearchTerm: record.name,
                        showCurrentValueReferenceDropdown: false,
                        searchingCurrentValueReference: false,
                        currentValueReferenceSearchResults: [] // Clear results to prevent re-searching
                      });
                    }}
                    style={{
                      padding: '6px 10px',
                      cursor: 'pointer',
                      fontSize: '12px',
                      borderBottom: '1px solid #f3f4f6',
                      color: '#000000',
                      backgroundColor: '#ffffff'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#f9fafb';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = '#ffffff';
                    }}
                  >
                    <div style={{ fontWeight: '500', color: '#000000' }}>{record.name}</div>
                  </div>
                ))
              ) : (
                <div style={{
                  padding: '6px 10px',
                  fontSize: '12px',
                  color: '#666',
                  textAlign: 'center'
                }}>
                  {fieldUpdate.currentValueReferenceSearchTerm && fieldUpdate.currentValueReferenceSearchTerm.trim() ? 'No records found' : 'Start typing to search...'}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // For other field types, show text input
    return (
      <input
        type="text"
        value={fieldUpdate.currentValue}
        onChange={(e) => updateFieldUpdate(fieldUpdate.id, { currentValue: e.target.value })}
        placeholder={`Enter current value to update`}
        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%' }}
      />
    );
  };

  return (
    <div className="update-object-fields-layout">
      <Sidebar isOpen={sidebarOpen} toggleSidebar={() => setSidebarOpen(!sidebarOpen)} />
      <div className="update-object-fields-content" style={{ marginLeft: sidebarOpen ? '280px' : '80px' }}>
        <div className="update-object-fields-container">
          <div className="update-object-fields-header">
            <div className="header-content">
              <div className="header-left">
                <button 
                  className="header-menu-toggle"
                  onClick={() => setSidebarOpen(!sidebarOpen)}
                  aria-label="Toggle sidebar"
                >
                  <Menu size={20} />
                </button>
                <div>
                  <h1 className="page-title">Update Object Fields</h1>
                  <p className="page-subtitle">Bulk update fields for Project, Project Objective, or Contributor Project</p>
                </div>
              </div>
              <div className="header-user-profile">
                <div className="user-profile">
                  <div className="user-avatar">
                    {(user?.email || 'U').charAt(0).toUpperCase()}
                  </div>
                  <span className="user-name">{user?.email || 'User'}</span>
                  <button className="logout-btn" onClick={logout} title="Logout">
                    <LogOut size={18} />
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div className="update-object-fields-main">
            {/* Combined Select Object and Filters Section - Single Row */}
            <div className="form-section fade-in">
              <div className="section-content">
                <div style={{ display: 'grid', gridTemplateColumns: 'auto 1fr', gap: '12px', alignItems: 'start' }}>
                  {/* Select Object - Compact */}
                  <div style={{ minWidth: '200px' }}>
                    <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                      Object *
                    </label>
                    <select
                      value={selectedObject}
                      onChange={(e) => {
                        setSelectedObject(e.target.value);
                        setSelectedField('');
                        setNewValue('');
                        setCurrentValue('');
                      }}
                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                    >
                      <option value="">--Select Object--</option>
                      {objectOptions.map((option) => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                      ))}
                    </select>
                  </div>

                  {/* Filters - Compact, only shown when object is selected */}
                  {selectedObject && (
                    <div style={{ flex: 1 }}>
                      <div className="form-grid compact-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '8px' }}>
                      {/* Project Objective: Filter by Project, Project Objective */}
                      {selectedObject.toLowerCase() === 'project objective' && (
                        <>
                          <div className="form-group" style={{ position: 'relative', zIndex: 10001 }} ref={projectSearchRef}>
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Project
                            </label>
                            <div style={{ position: 'relative' }}>
                              <input
                                type="text"
                                value={projectSearchTerm}
                                onChange={(e) => {
                                  const value = e.target.value;
                                  setProjectSearchTerm(value);
                                  if (!value || value.trim() === '') {
                                    setFilters(prev => {
                                      const updated = { ...prev, projectId: '', projectName: '' };
                                      // When project is cleared, refresh project objectives to show all
                                      if (prev.projectId) {
                                        fetchAllProjectObjectives(null);
                                        // Clear project objective selection when project is cleared
                                        if (prev.projectObjectiveId) {
                                          updated.projectObjectiveId = '';
                                          updated.projectObjectiveName = '';
                                          setProjectObjectiveSearchTerm('');
                                        }
                                      }
                                      return updated;
                                    });
                                  }
                                  setShowProjectDropdown(true);
                                }}
                                onFocus={() => {
                                  setShowProjectDropdown(true);
                                }}
                                placeholder="Search or select a project..."
                                style={{ 
                                  fontSize: '12px', 
                                  padding: '6px 10px', 
                                  paddingRight: '36px',
                                  height: '32px', 
                                  width: '100%',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '4px',
                                  backgroundColor: '#fff'
                                }}
                              />
                              <Search 
                                size={14} 
                                style={{ 
                                  position: 'absolute', 
                                  right: '10px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)', 
                                  color: '#666',
                                  pointerEvents: 'none'
                                }} 
                              />
                              {(loadingAllProjects || searchingProjects) && (
                                <div style={{ 
                                  position: 'absolute', 
                                  right: '36px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)',
                                  fontSize: '12px',
                                  color: '#666'
                                }}>
                                  {searchingProjects ? 'Searching...' : 'Loading...'}
                                </div>
                              )}
                              {showProjectDropdown && (filteredProjects.length > 0 || projectSearchTerm.trim() === '' || searchingProjects) && (
                                <div style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#ffffff',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                  zIndex: 10002,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}>
                                  {searchingProjects ? (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      Searching...
                                    </div>
                                  ) : filteredProjects.length > 0 ? (
                                    filteredProjects.map((project) => (
                                      <div
                                        key={project.id}
                                        onClick={() => handleProjectSelect(project)}
                                        style={{
                                          padding: '6px 10px',
                                          cursor: 'pointer',
                                          fontSize: '12px',
                                          borderBottom: '1px solid #f3f4f6',
                                          color: '#000000',
                                          backgroundColor: '#ffffff'
                                        }}
                                        onMouseEnter={(e) => {
                                          e.currentTarget.style.backgroundColor = '#f9fafb';
                                        }}
                                        onMouseLeave={(e) => {
                                          e.currentTarget.style.backgroundColor = '#ffffff';
                                        }}
                                      >
                                        <div style={{ fontWeight: '500', color: '#000000' }}>{project.name}</div>
                                      </div>
                                    ))
                                  ) : (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      {projectSearchTerm.trim() ? 'No projects found' : 'Loading projects...'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="form-group" style={{ position: 'relative', zIndex: 10001 }} ref={projectObjectiveSearchRef}>
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Project Objective
                            </label>
                            <div style={{ position: 'relative' }}>
                              <input
                                type="text"
                                value={projectObjectiveSearchTerm}
                                onChange={(e) => {
                                  const value = e.target.value;
                                  setProjectObjectiveSearchTerm(value);
                                  if (!value || value.trim() === '') {
                                    setFilters(prev => ({ ...prev, projectObjectiveId: '', projectObjectiveName: '' }));
                                  }
                                  setShowProjectObjectiveDropdown(true);
                                }}
                                onFocus={() => {
                                  setShowProjectObjectiveDropdown(true);
                                }}
                                placeholder="Search or select a project objective..."
                                style={{ 
                                  fontSize: '12px', 
                                  padding: '6px 10px', 
                                  paddingRight: '36px',
                                  height: '32px', 
                                  width: '100%',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '4px',
                                  backgroundColor: '#fff'
                                }}
                              />
                              <Search 
                                size={14} 
                                style={{ 
                                  position: 'absolute', 
                                  right: '10px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)', 
                                  color: '#666',
                                  pointerEvents: 'none'
                                }} 
                              />
                              {searchingProjectObjectives && (
                                <div style={{ 
                                  position: 'absolute', 
                                  right: '36px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)',
                                  fontSize: '12px',
                                  color: '#666'
                                }}>
                                  Searching...
                                </div>
                              )}
                              {showProjectObjectiveDropdown && (filteredProjectObjectives.length > 0 || projectObjectiveSearchTerm.trim() === '' || searchingProjectObjectives) && (
                                <div style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#ffffff',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                  zIndex: 10002,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}>
                                  {searchingProjectObjectives ? (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      Searching...
                                    </div>
                                  ) : filteredProjectObjectives.length > 0 ? (
                                    filteredProjectObjectives.map((projectObjective) => (
                                      <div
                                        key={projectObjective.id}
                                        onClick={() => handleProjectObjectiveSelect(projectObjective)}
                                        style={{
                                          padding: '6px 10px',
                                          cursor: 'pointer',
                                          fontSize: '12px',
                                          borderBottom: '1px solid #f3f4f6',
                                          color: '#000000',
                                          backgroundColor: '#ffffff'
                                        }}
                                        onMouseEnter={(e) => {
                                          e.currentTarget.style.backgroundColor = '#f9fafb';
                                        }}
                                        onMouseLeave={(e) => {
                                          e.currentTarget.style.backgroundColor = '#ffffff';
                                        }}
                                      >
                                        <div style={{ fontWeight: '500', color: '#000000' }}>{projectObjective.name}</div>
                                      </div>
                                    ))
                                  ) : (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      {projectObjectiveSearchTerm.trim() ? 'No project objectives found' : 'Loading project objectives...'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        </>
                      )}

                      {/* Contributor Project: Filter by Project, Status, Queue Status */}
                      {selectedObject.toLowerCase() === 'contributor project' && (
                        <>
                          <div className="form-group" style={{ position: 'relative', zIndex: 10001 }} ref={projectSearchRef}>
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Project
                            </label>
                            <div style={{ position: 'relative' }}>
                              <input
                                type="text"
                                value={projectSearchTerm}
                                onChange={(e) => {
                                  const value = e.target.value;
                                  setProjectSearchTerm(value);
                                  if (!value || value.trim() === '') {
                                    setFilters(prev => {
                                      const updated = { ...prev, projectId: '', projectName: '' };
                                      // When project is cleared, refresh project objectives to show all
                                      if (prev.projectId) {
                                        fetchAllProjectObjectives(null);
                                        // Clear project objective selection when project is cleared
                                        if (prev.projectObjectiveId) {
                                          updated.projectObjectiveId = '';
                                          updated.projectObjectiveName = '';
                                          setProjectObjectiveSearchTerm('');
                                        }
                                      }
                                      return updated;
                                    });
                                  }
                                  setShowProjectDropdown(true);
                                }}
                                onFocus={() => {
                                  setShowProjectDropdown(true);
                                }}
                                placeholder="Search or select a project..."
                                style={{ 
                                  fontSize: '12px', 
                                  padding: '6px 10px', 
                                  paddingRight: '36px',
                                  height: '32px', 
                                  width: '100%',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '4px',
                                  backgroundColor: '#fff'
                                }}
                              />
                              <Search 
                                size={14} 
                                style={{ 
                                  position: 'absolute', 
                                  right: '10px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)', 
                                  color: '#666',
                                  pointerEvents: 'none'
                                }} 
                              />
                              {(loadingAllProjects || searchingProjects) && (
                                <div style={{ 
                                  position: 'absolute', 
                                  right: '36px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)',
                                  fontSize: '12px',
                                  color: '#666'
                                }}>
                                  {searchingProjects ? 'Searching...' : 'Loading...'}
                                </div>
                              )}
                              {showProjectDropdown && (filteredProjects.length > 0 || projectSearchTerm.trim() === '' || searchingProjects) && (
                                <div style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#ffffff',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                  zIndex: 10002,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}>
                                  {searchingProjects ? (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      Searching...
                                    </div>
                                  ) : filteredProjects.length > 0 ? (
                                    filteredProjects.map((project) => (
                                      <div
                                        key={project.id}
                                        onClick={() => handleProjectSelect(project)}
                                        style={{
                                          padding: '6px 10px',
                                          cursor: 'pointer',
                                          fontSize: '12px',
                                          borderBottom: '1px solid #f3f4f6',
                                          color: '#000000',
                                          backgroundColor: '#ffffff'
                                        }}
                                        onMouseEnter={(e) => {
                                          e.currentTarget.style.backgroundColor = '#f9fafb';
                                        }}
                                        onMouseLeave={(e) => {
                                          e.currentTarget.style.backgroundColor = '#ffffff';
                                        }}
                                      >
                                        <div style={{ fontWeight: '500', color: '#000000' }}>{project.name}</div>
                                      </div>
                                    ))
                                  ) : (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      {projectSearchTerm.trim() ? 'No projects found' : 'Loading projects...'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="form-group" style={{ position: 'relative', zIndex: 10001 }} ref={projectObjectiveSearchRef}>
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Project Objective
                            </label>
                            <div style={{ position: 'relative' }}>
                              <input
                                type="text"
                                value={projectObjectiveSearchTerm}
                                onChange={(e) => {
                                  const value = e.target.value;
                                  setProjectObjectiveSearchTerm(value);
                                  if (!value || value.trim() === '') {
                                    setFilters(prev => ({ ...prev, projectObjectiveId: '', projectObjectiveName: '' }));
                                  }
                                  setShowProjectObjectiveDropdown(true);
                                }}
                                onFocus={() => {
                                  setShowProjectObjectiveDropdown(true);
                                }}
                                placeholder="Search or select a project objective..."
                                style={{ 
                                  fontSize: '12px', 
                                  padding: '6px 10px', 
                                  paddingRight: '36px',
                                  height: '32px', 
                                  width: '100%',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '4px',
                                  backgroundColor: '#fff'
                                }}
                              />
                              <Search 
                                size={14} 
                                style={{ 
                                  position: 'absolute', 
                                  right: '10px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)', 
                                  color: '#666',
                                  pointerEvents: 'none'
                                }} 
                              />
                              {searchingProjectObjectives && (
                                <div style={{ 
                                  position: 'absolute', 
                                  right: '36px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)',
                                  fontSize: '12px',
                                  color: '#666'
                                }}>
                                  Searching...
                                </div>
                              )}
                              {showProjectObjectiveDropdown && (filteredProjectObjectives.length > 0 || projectObjectiveSearchTerm.trim() === '' || searchingProjectObjectives) && (
                                <div style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#ffffff',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                  zIndex: 10002,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}>
                                  {searchingProjectObjectives ? (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      Searching...
                                    </div>
                                  ) : filteredProjectObjectives.length > 0 ? (
                                    filteredProjectObjectives.map((projectObjective) => (
                                      <div
                                        key={projectObjective.id}
                                        onClick={() => handleProjectObjectiveSelect(projectObjective)}
                                        style={{
                                          padding: '6px 10px',
                                          cursor: 'pointer',
                                          fontSize: '12px',
                                          borderBottom: '1px solid #f3f4f6',
                                          color: '#000000',
                                          backgroundColor: '#ffffff'
                                        }}
                                        onMouseEnter={(e) => {
                                          e.currentTarget.style.backgroundColor = '#f9fafb';
                                        }}
                                        onMouseLeave={(e) => {
                                          e.currentTarget.style.backgroundColor = '#ffffff';
                                        }}
                                      >
                                        <div style={{ fontWeight: '500', color: '#000000' }}>{projectObjective.name}</div>
                                      </div>
                                    ))
                                  ) : (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      {projectObjectiveSearchTerm.trim() ? 'No project objectives found' : 'Loading project objectives...'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="form-group">
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Status
                            </label>
                            <select
                              value={filters.status}
                              onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                            >
                              <option value="">--All Statuses--</option>
                              {(filterOptions.statuses || []).map((status, index) => (
                                <option key={index} value={status}>{status}</option>
                              ))}
                            </select>
                          </div>
                        </>
                      )}

                      {/* Project: Filter by Project, Status, Type */}
                      {selectedObject.toLowerCase() === 'project' && (
                        <>
                          <div className="form-group" style={{ position: 'relative', zIndex: 10001 }} ref={projectSearchRef}>
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Project
                            </label>
                            <div style={{ position: 'relative' }}>
                              <input
                                type="text"
                                value={projectSearchTerm}
                                onChange={(e) => {
                                  const value = e.target.value;
                                  setProjectSearchTerm(value);
                                  if (!value || value.trim() === '') {
                                    setFilters(prev => {
                                      const updated = { ...prev, projectId: '', projectName: '' };
                                      // When project is cleared, refresh project objectives to show all
                                      if (prev.projectId) {
                                        fetchAllProjectObjectives(null);
                                        // Clear project objective selection when project is cleared
                                        if (prev.projectObjectiveId) {
                                          updated.projectObjectiveId = '';
                                          updated.projectObjectiveName = '';
                                          setProjectObjectiveSearchTerm('');
                                        }
                                      }
                                      return updated;
                                    });
                                  }
                                  setShowProjectDropdown(true);
                                }}
                                onFocus={() => {
                                  setShowProjectDropdown(true);
                                }}
                                placeholder="Search or select a project..."
                                style={{ 
                                  fontSize: '12px', 
                                  padding: '6px 10px', 
                                  paddingRight: '36px',
                                  height: '32px', 
                                  width: '100%',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '4px',
                                  backgroundColor: '#fff'
                                }}
                              />
                              <Search 
                                size={14} 
                                style={{ 
                                  position: 'absolute', 
                                  right: '10px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)', 
                                  color: '#666',
                                  pointerEvents: 'none'
                                }} 
                              />
                              {(loadingAllProjects || searchingProjects) && (
                                <div style={{ 
                                  position: 'absolute', 
                                  right: '36px', 
                                  top: '50%', 
                                  transform: 'translateY(-50%)',
                                  fontSize: '12px',
                                  color: '#666'
                                }}>
                                  {searchingProjects ? 'Searching...' : 'Loading...'}
                                </div>
                              )}
                              {showProjectDropdown && (filteredProjects.length > 0 || projectSearchTerm.trim() === '' || searchingProjects) && (
                                <div style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#ffffff',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                  zIndex: 10002,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}>
                                  {searchingProjects ? (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      Searching...
                                    </div>
                                  ) : filteredProjects.length > 0 ? (
                                    filteredProjects.map((project) => (
                                      <div
                                        key={project.id}
                                        onClick={() => handleProjectSelect(project)}
                                        style={{
                                          padding: '6px 10px',
                                          cursor: 'pointer',
                                          fontSize: '12px',
                                          borderBottom: '1px solid #f3f4f6',
                                          color: '#000000',
                                          backgroundColor: '#ffffff'
                                        }}
                                        onMouseEnter={(e) => {
                                          e.currentTarget.style.backgroundColor = '#f9fafb';
                                        }}
                                        onMouseLeave={(e) => {
                                          e.currentTarget.style.backgroundColor = '#ffffff';
                                        }}
                                      >
                                        <div style={{ fontWeight: '500', color: '#000000' }}>{project.name}</div>
                                      </div>
                                    ))
                                  ) : (
                                    <div style={{
                                      padding: '6px 10px',
                                      fontSize: '12px',
                                      color: '#666',
                                      textAlign: 'center'
                                    }}>
                                      {projectSearchTerm.trim() ? 'No projects found' : 'Loading projects...'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="form-group">
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Status
                            </label>
                            <select
                              value={filters.status}
                              onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                            >
                              <option value="">--All Statuses--</option>
                              {(filterOptions.statuses || []).map((status, index) => (
                                <option key={index} value={status}>{status}</option>
                              ))}
                            </select>
                          </div>
                          <div className="form-group">
                            <label style={{ fontSize: '11px', fontWeight: '600', marginBottom: '4px', display: 'block', color: '#374151' }}>
                              Filter by Type
                            </label>
                            <select
                              value={filters.type}
                              onChange={(e) => setFilters(prev => ({ ...prev, type: e.target.value }))}
                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                            >
                              <option value="">--All Types--</option>
                              {(filterOptions.types || []).map((type, index) => (
                                <option key={index} value={type}>{type}</option>
                              ))}
                            </select>
                          </div>
                        </>
                      )}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {selectedObject && (
              <>
                {/* Matching Records Count */}
                {matchingRecordsCount !== null && (
                  <div style={{ 
                    marginTop: '12px',
                    paddingTop: '12px',
                    borderTop: '1px solid #e5e7eb',
                    fontSize: '13px', 
                    color: '#08979C',
                    fontWeight: '500',
                    paddingBottom: '12px',
                    paddingLeft: '12px',
                    paddingRight: '12px',
                    backgroundColor: '#e6fffb',
                    borderRadius: '4px',
                    display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}>
                        {loadingCount ? (
                          <>
                            <Loader size={14} className="spinner" />
                            <span>Counting...</span>
                          </>
                        ) : (
                          <span>
                            {matchingRecordsCount === 0 
                              ? 'No records match the filters' 
                              : `${matchingRecordsCount} record${matchingRecordsCount === 1 ? '' : 's'} match${matchingRecordsCount === 1 ? 'es' : ''} the filters`
                            }
                          </span>
                        )}
                      </div>
                    )}

                {/* Update Configuration Section */}
                <div className="form-section fade-in" style={{ position: 'relative', zIndex: 1 }}>
                  <div className="section-content" style={{ padding: '8px' }}>
                    <h2 style={{ margin: 0, marginBottom: '8px' }}>Update Configuration</h2>
                    
                    {/* Mode Selection - Centered and Compact */}
                    <div style={{ 
                      display: 'flex', 
                      justifyContent: 'center', 
                      alignItems: 'center', 
                      gap: '16px',
                      marginBottom: '8px'
                    }}>
                      <label style={{ 
                        fontSize: '13px', 
                        fontWeight: '500', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}>
                        <input
                          type="radio"
                          name="updateModeType"
                          value="single"
                          checked={updateModeType === 'single'}
                          onChange={(e) => {
                            setUpdateModeType(e.target.value);
                            setMultipleFieldUpdates([{
                              id: Date.now(),
                              fieldName: '',
                              updateMode: 'all',
                              currentValue: '',
                              newValue: '',
                              fieldInfo: null,
                              picklistValues: [],
                              referenceSearchTerm: '',
                              referenceSearchResults: [],
                              searchingReference: false,
                              showReferenceDropdown: false,
                              currentValueReferenceSearchTerm: '',
                              currentValueReferenceSearchResults: [],
                              searchingCurrentValueReference: false,
                              showCurrentValueReferenceDropdown: false
                            }]);
                          }}
                          style={{ marginRight: '4px' }}
                        />
                        Single Field
                      </label>
                      <label style={{ 
                        fontSize: '13px', 
                        fontWeight: '500', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}>
                        <input
                          type="radio"
                          name="updateModeType"
                          value="multiple"
                          checked={updateModeType === 'multiple'}
                          onChange={(e) => {
                            setUpdateModeType(e.target.value);
                            setSelectedField('');
                            setNewValue('');
                            setCurrentValue('');
                          }}
                          style={{ marginRight: '4px' }}
                        />
                        Multiple Fields
                      </label>
                      <label style={{ 
                        fontSize: '13px', 
                        fontWeight: '500', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px'
                      }}>
                        <input
                          type="radio"
                          name="updateModeType"
                          value="mapping"
                          checked={updateModeType === 'mapping'}
                          onChange={(e) => {
                            setUpdateModeType(e.target.value);
                            setSelectedField('');
                            setNewValue('');
                            setCurrentValue('');
                            setSourceObject('');
                            setSourceFields([]);
                            setFieldMappings([{
                              id: Date.now(),
                              targetField: '',
                              sourceField: '',
                              transformation: 'copy',
                              formula: '',
                              concatenateFields: [],
                              separator: ' ',
                              dateFormat: 'YYYY-MM-DD',
                              numberFormat: '0.00'
                            }]);
                          }}
                          style={{ marginRight: '4px' }}
                        />
                        Field Mapping
                      </label>
                    </div>

                    {updateModeType === 'single' && (
                      <div>
                        <div 
                          key={`single-field-grid-${updateMode}`}
                          className="form-grid compact-grid single-field-update-grid" 
                          style={{ 
                            gridTemplateColumns: updateMode === 'specific' ? '1fr 1fr 1fr 1fr' : '1fr 1fr 1fr', 
                            gap: '10px',
                            display: 'grid',
                            width: '100%',
                            minWidth: 0
                          }}
                        >
                          <div className="form-group">
                            <label>
                              Field *
                            </label>
                            {loadingFields ? (
                              <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading fields...</div>
                            ) : (
                              <select
                                value={selectedField}
                                onChange={(e) => {
                                  setSelectedField(e.target.value);
                                  setNewValue('');
                                  setCurrentValue('');
                                }}
                                disabled={!selectedObject || fields.length === 0}
                                style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                              >
                                <option value="">--Select Field--</option>
                                {fields.map((field) => (
                                  <option key={field.name} value={field.name}>
                                    {field.label} ({field.type})
                                  </option>
                                ))}
                              </select>
                            )}
                          </div>

                          <div className="form-group">
                            <label>
                              Update Mode *
                            </label>
                            <select
                              value={updateMode}
                              onChange={(e) => {
                                setUpdateMode(e.target.value);
                                setCurrentValue('');
                              }}
                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                            >
                              <option value="all">Update All Records</option>
                              <option value="specific">Update Only Records with Specific Value</option>
                            </select>
                          </div>

                          {updateMode === 'specific' && (
                            <div className="form-group">
                              <label>
                                Current Value *
                              </label>
                              {selectedField && selectedFieldInfo ? (
                                selectedFieldInfo.type === 'picklist' || selectedFieldInfo.type === 'multipicklist' ? (
                                  <select
                                    value={currentValue}
                                    onChange={(e) => setCurrentValue(e.target.value)}
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  >
                                    <option value="">--Select Current Value--</option>
                                    {picklistValues.map((value, index) => (
                                      <option key={index} value={value}>{value}</option>
                                    ))}
                                  </select>
                                ) : selectedFieldInfo.type === 'reference' && selectedFieldInfo.referenceTo ? (
                                  <div style={{ position: 'relative' }}>
                                    <input
                                      type="text"
                                      value={currentValueReferenceSearchTerm}
                                      onChange={(e) => {
                                        const value = e.target.value;
                                        setCurrentValueReferenceSearchTerm(value);
                                        if (!value || value.trim() === '') {
                                          setCurrentValue('');
                                        }
                                        setShowCurrentValueReferenceDropdown(true);
                                      }}
                                      onFocus={() => {
                                        if (currentValueReferenceSearchTerm.trim() !== '') {
                                          setShowCurrentValueReferenceDropdown(true);
                                        }
                                      }}
                                      placeholder={`Search ${selectedFieldInfo.referenceTo}...`}
                                      style={{ 
                                        fontSize: '12px', 
                                        padding: '6px 10px', 
                                        paddingRight: '36px',
                                        height: '32px', 
                                        width: '100%' 
                                      }}
                                    />
                                    <Search 
                                      size={14} 
                                      style={{ 
                                        position: 'absolute', 
                                        right: '10px', 
                                        top: '50%', 
                                        transform: 'translateY(-50%)', 
                                        color: '#666',
                                        pointerEvents: 'none'
                                      }} 
                                    />
                                    {searchingCurrentValueReference && (
                                      <div style={{ 
                                        position: 'absolute', 
                                        right: '36px', 
                                        top: '50%', 
                                        transform: 'translateY(-50%)',
                                        fontSize: '12px',
                                        color: '#666'
                                      }}>
                                        Searching...
                                      </div>
                                    )}
                                    {showCurrentValueReferenceDropdown && (currentValueReferenceSearchResults.length > 0 || currentValueReferenceSearchTerm.trim() === '' || searchingCurrentValueReference) && (
                                      <div style={{
                                        position: 'absolute',
                                        top: '100%',
                                        left: 0,
                                        right: 0,
                                        marginTop: '4px',
                                        backgroundColor: '#ffffff',
                                        border: '1px solid #e5e7eb',
                                        borderRadius: '6px',
                                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                        zIndex: 10001,
                                        maxHeight: '200px',
                                        overflowY: 'auto'
                                      }}>
                                        {searchingCurrentValueReference ? (
                                          <div style={{
                                            padding: '6px 10px',
                                            fontSize: '12px',
                                            color: '#666',
                                            textAlign: 'center'
                                          }}>
                                            Searching...
                                          </div>
                                        ) : currentValueReferenceSearchResults.length > 0 ? (
                                          currentValueReferenceSearchResults.map((record) => (
                                            <div
                                              key={record.id}
                                              onClick={() => {
                                                setCurrentValue(record.id);
                                                setCurrentValueReferenceSearchTerm(record.name);
                                                setShowCurrentValueReferenceDropdown(false);
                                              }}
                                              style={{
                                                padding: '6px 10px',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                borderBottom: '1px solid #f3f4f6',
                                                color: '#000000',
                                                backgroundColor: '#ffffff'
                                              }}
                                              onMouseEnter={(e) => {
                                                e.currentTarget.style.backgroundColor = '#f9fafb';
                                              }}
                                              onMouseLeave={(e) => {
                                                e.currentTarget.style.backgroundColor = '#ffffff';
                                              }}
                                            >
                                              <div style={{ fontWeight: '500', color: '#000000' }}>{record.name}</div>
                                            </div>
                                          ))
                                        ) : (
                                          <div style={{
                                            padding: '6px 10px',
                                            fontSize: '12px',
                                            color: '#666',
                                            textAlign: 'center'
                                          }}>
                                            {currentValueReferenceSearchTerm.trim() ? 'No records found' : 'Start typing to search...'}
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                ) : (
                                  <input
                                    type="text"
                                    value={currentValue}
                                    onChange={(e) => setCurrentValue(e.target.value)}
                                    placeholder={`Enter current value to update`}
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  />
                                )
                              ) : (
                                <input
                                  type="text"
                                  disabled
                                  placeholder="Select a field first"
                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                />
                              )}
                            </div>
                          )}

                          <div className="form-group">
                            <label>
                              New Value *
                              {selectedFieldInfo && selectedFieldInfo.required && <span style={{ color: 'red' }}> *</span>}
                            </label>
                            {selectedField && selectedFieldInfo ? (
                              selectedFieldInfo.type === 'reference' && selectedFieldInfo.referenceTo ? (
                                <div style={{ position: 'relative' }}>
                                  <input
                                    type="text"
                                    value={referenceSearchTerm}
                                    onChange={(e) => {
                                      const value = e.target.value;
                                      setReferenceSearchTerm(value);
                                      if (!value || value.trim() === '') {
                                        setNewValue('');
                                      }
                                      setShowReferenceDropdown(true);
                                    }}
                                    onFocus={() => {
                                      if (referenceSearchTerm.trim() !== '') {
                                        setShowReferenceDropdown(true);
                                      }
                                    }}
                                    placeholder={`Search ${selectedFieldInfo.referenceTo}...`}
                                    style={{ 
                                      fontSize: '12px', 
                                      padding: '6px 10px', 
                                      paddingRight: '36px',
                                      height: '32px', 
                                      width: '100%' 
                                    }}
                                  />
                                  <Search 
                                    size={14} 
                                    style={{ 
                                      position: 'absolute', 
                                      right: '10px', 
                                      top: '50%', 
                                      transform: 'translateY(-50%)', 
                                      color: '#666',
                                      pointerEvents: 'none'
                                    }} 
                                  />
                                  {searchingReference && (
                                    <div style={{ 
                                      position: 'absolute', 
                                      right: '36px', 
                                      top: '50%', 
                                      transform: 'translateY(-50%)',
                                      fontSize: '12px',
                                      color: '#666'
                                    }}>
                                      Searching...
                                    </div>
                                  )}
                                  {showReferenceDropdown && (referenceSearchResults.length > 0 || referenceSearchTerm.trim() === '' || searchingReference) && (
                                    <div style={{
                                      position: 'absolute',
                                      top: '100%',
                                      left: 0,
                                      right: 0,
                                      marginTop: '4px',
                                      backgroundColor: '#ffffff',
                                      border: '1px solid #e5e7eb',
                                      borderRadius: '6px',
                                      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                                      zIndex: 10001,
                                      maxHeight: '200px',
                                      overflowY: 'auto'
                                    }}>
                                      {searchingReference ? (
                                        <div style={{
                                          padding: '6px 10px',
                                          fontSize: '12px',
                                          color: '#666',
                                          textAlign: 'center'
                                        }}>
                                          Searching...
                                        </div>
                                      ) : referenceSearchResults.length > 0 ? (
                                        referenceSearchResults.map((record) => (
                                          <div
                                            key={record.id}
                                            onClick={() => {
                                              setNewValue(record.id);
                                              setReferenceSearchTerm(record.name);
                                              setShowReferenceDropdown(false);
                                            }}
                                            style={{
                                              padding: '6px 10px',
                                              cursor: 'pointer',
                                              fontSize: '12px',
                                              borderBottom: '1px solid #f3f4f6',
                                              color: '#000000',
                                              backgroundColor: '#ffffff'
                                            }}
                                            onMouseEnter={(e) => {
                                              e.currentTarget.style.backgroundColor = '#f9fafb';
                                            }}
                                            onMouseLeave={(e) => {
                                              e.currentTarget.style.backgroundColor = '#ffffff';
                                            }}
                                          >
                                            <div style={{ fontWeight: '500', color: '#000000' }}>{record.name}</div>
                                          </div>
                                        ))
                                      ) : (
                                        <div style={{
                                          padding: '6px 10px',
                                          fontSize: '12px',
                                          color: '#666',
                                          textAlign: 'center'
                                        }}>
                                          {referenceSearchTerm.trim() ? 'No records found' : 'Start typing to search...'}
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                              ) : selectedFieldInfo.type === 'picklist' || selectedFieldInfo.type === 'multipicklist' ? (
                                <select
                                  value={newValue}
                                  onChange={(e) => setNewValue(e.target.value)}
                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                >
                                  <option value="">--Select Value--</option>
                                  {picklistValues.map((value, index) => (
                                    <option key={index} value={value}>{value}</option>
                                  ))}
                                </select>
                              ) : (
                                <input
                                  type="text"
                                  value={newValue}
                                  onChange={(e) => setNewValue(e.target.value)}
                                  placeholder={`Enter new value for ${selectedFieldInfo.label}`}
                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                />
                              )
                            ) : (
                              <input
                                type="text"
                                disabled
                                placeholder="Select a field first"
                                style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                              />
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    {updateModeType === 'multiple' && (
                      <div>
                        {multipleFieldUpdates.map((fieldUpdate, index) => (
                          <div key={fieldUpdate.id} style={{ 
                            marginBottom: '16px', 
                            padding: '16px', 
                            border: '1px solid #e5e7eb', 
                            borderRadius: '8px',
                            backgroundColor: '#fafafa'
                          }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>Field Update {index + 1}</h3>
                              {multipleFieldUpdates.length > 1 && (
                                <button
                                  type="button"
                                  onClick={() => removeFieldUpdate(fieldUpdate.id)}
                                  style={{
                                    padding: '4px 8px',
                                    fontSize: '11px',
                                    backgroundColor: '#fee2e2',
                                    color: '#dc2626',
                                    border: '1px solid #fecaca',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                  }}
                                >
                                  <Trash2 size={12} />
                                  Remove
                                </button>
                              )}
                            </div>
                            <div 
                              key={`multiple-field-grid-${fieldUpdate.id}-${fieldUpdate.updateMode}`}
                              className="form-grid compact-grid single-field-update-grid" 
                              style={{ 
                                gridTemplateColumns: fieldUpdate.updateMode === 'specific' ? '1fr 1fr 1fr 1fr' : '1fr 1fr 1fr', 
                                gap: '10px',
                                display: 'grid',
                                width: '100%',
                                minWidth: 0,
                                alignItems: 'start'
                              }}
                            >
                              <div className="form-group">
                                <label>
                                  Field *
                                </label>
                                {loadingFields ? (
                                  <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading fields...</div>
                                ) : (
                                  <select
                                    value={fieldUpdate.fieldName}
                                    onChange={(e) => {
                                      const fieldInfo = fields.find(f => f.name === e.target.value);
                                      updateFieldUpdate(fieldUpdate.id, {
                                        fieldName: e.target.value,
                                        fieldInfo: fieldInfo,
                                        newValue: '',
                                        currentValue: '',
                                        picklistValues: fieldInfo && (fieldInfo.type === 'picklist' || fieldInfo.type === 'multipicklist') ? (fieldInfo.picklistValues || []) : [],
                                        referenceSearchTerm: '',
                                        referenceSearchResults: [],
                                        currentValueReferenceSearchTerm: '',
                                        currentValueReferenceSearchResults: []
                                      });
                                    }}
                                    disabled={!selectedObject || fields.length === 0}
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  >
                                    <option value="">--Select Field--</option>
                                    {fields.map((field) => (
                                      <option key={field.name} value={field.name}>
                                        {field.label} ({field.type})
                                      </option>
                                    ))}
                                  </select>
                                )}
                              </div>

                              <div className="form-group">
                                <label>
                                  Update Mode *
                                </label>
                                <select
                                  value={fieldUpdate.updateMode}
                                  onChange={(e) => {
                                    updateFieldUpdate(fieldUpdate.id, {
                                      updateMode: e.target.value,
                                      currentValue: ''
                                    });
                                  }}
                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                >
                                  <option value="all">Update All Records</option>
                                  <option value="specific">Update Only Records with Specific Value</option>
                                </select>
                              </div>

                              {fieldUpdate.updateMode === 'specific' && (
                                <div className="form-group">
                                  <label>
                                    Current Value *
                                  </label>
                                  {renderMultipleFieldCurrentValueInput(fieldUpdate)}
                                </div>
                              )}

                              <div className="form-group">
                                <label>
                                  New Value *
                                </label>
                                {renderMultipleFieldValueInput(fieldUpdate)}
                              </div>
                            </div>
                          </div>
                        ))}
                        <button
                          type="button"
                          onClick={addFieldUpdate}
                          style={{
                            padding: '8px 16px',
                            fontSize: '12px',
                            backgroundColor: '#f0f9ff',
                            color: '#0284c7',
                            border: '1px solid #bae6fd',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            marginTop: '12px'
                          }}
                        >
                          <Plus size={14} />
                          Add Another Field
                        </button>
                      </div>
                    )}

                    {updateModeType === 'mapping' && (
                      <div style={{ marginTop: '8px' }}>
                        {/* Compact Header with Help Icon */}
                        <div style={{ 
                          marginBottom: '8px', 
                          display: 'flex', 
                          alignItems: 'center', 
                          gap: '6px',
                          justifyContent: 'space-between'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: '#002329' }}>
                              Field Mapping
                            </h3>
                            <button
                              type="button"
                              onClick={() => setShowMappingModeHelp(!showMappingModeHelp)}
                              style={{
                                background: 'none',
                                border: '1px solid #d1d5db',
                                borderRadius: '50%',
                                width: '18px',
                                height: '18px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                cursor: 'pointer',
                                color: '#6b7280',
                                fontSize: '11px',
                                padding: 0
                              }}
                              title="Click for help on Field Mapping Mode"
                            >
                              <HelpCircle size={12} />
                            </button>
                          </div>
                        </div>

                        {/* Help Text - Only shown when help icon is clicked */}
                        {showMappingModeHelp && (
                          <div style={{ 
                            marginBottom: '8px', 
                            padding: '8px', 
                            backgroundColor: '#eff6ff', 
                            borderRadius: '6px',
                            border: '1px solid #bfdbfe',
                            fontSize: '11px',
                            color: '#1e40af'
                          }}>
                            <strong>Field Mapping Mode:</strong> In this mode, you map fields from a source object to a target object with optional transformations. 
                            <strong> You do NOT need to enter manual field update details (like "Current Value" or "New Value")</strong> - the system automatically copies and transforms values from source records to target records based on your mappings.
                          </div>
                        )}

                        {/* Source Object and Target Object in Single Row with Different Frames */}
                        <div style={{ 
                          display: 'grid', 
                          gridTemplateColumns: '1fr 1fr', 
                          gap: '12px', 
                          marginBottom: '8px' 
                        }}>
                          {/* Source Object Frame */}
                          <div style={{ 
                            padding: '6px', 
                            backgroundColor: '#f0f9ff', 
                            borderRadius: '6px',
                            border: '1px solid #bae6fd'
                          }}>
                            <label style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '4px',
                              marginBottom: '6px', 
                              fontSize: '11px', 
                              fontWeight: '600',
                              color: '#0284c7'
                            }}>
                              Source Object *
                            </label>
                            <select
                              value={sourceObject}
                              onChange={(e) => {
                                const newSourceObject = e.target.value;
                                setSourceObject(newSourceObject);
                                setSourceFields([]);
                                if (newSourceObject) {
                                  fetchFields(newSourceObject, true);
                                }
                              }}
                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                            >
                              <option value="">--Select Source Object--</option>
                              {objectOptions.map((option) => (
                                <option key={option.value} value={option.value}>
                                  {option.label}
                                </option>
                              ))}
                            </select>
                          </div>

                          {/* Target Object Frame */}
                          <div style={{ 
                            padding: '6px', 
                            backgroundColor: '#ffffff', 
                            borderRadius: '6px',
                            border: '1px solid #e5e7eb'
                          }}>
                            <label style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '4px',
                              marginBottom: '6px', 
                              fontSize: '11px', 
                              fontWeight: '600',
                              color: '#002329'
                            }}>
                              Target Object *
                            </label>
                            <div style={{ 
                              fontSize: '12px', 
                              padding: '6px 10px', 
                              height: '32px', 
                              display: 'flex',
                              alignItems: 'center',
                              color: selectedObject ? '#002329' : '#9ca3af',
                              backgroundColor: '#fff',
                              borderRadius: '4px',
                              border: '1px solid #e5e7eb'
                            }}>
                              {selectedObject || 'Select target object above'}
                            </div>
                          </div>
                        </div>

                        {/* Field Mappings Header with Help and Hybrid View Toggle */}
                        <div style={{ 
                          marginBottom: '8px', 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          paddingBottom: '6px',
                          borderBottom: '1px solid #e5e7eb'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <div style={{ fontSize: '13px', fontWeight: '600', color: '#002329' }}>
                              Field Mappings ({fieldMappings.length})
                            </div>
                            <button
                              type="button"
                              onClick={() => setShowFieldMappingHelpModal(true)}
                              style={{
                                background: 'none',
                                border: '1px solid #d1d5db',
                                borderRadius: '50%',
                                width: '18px',
                                height: '18px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                cursor: 'pointer',
                                color: '#6b7280',
                                fontSize: '11px',
                                padding: 0
                              }}
                              title="Click for help on Field Mappings"
                            >
                              <HelpCircle size={12} />
                            </button>
                          </div>
                          <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer', fontSize: '11px', color: '#374151' }}>
                            <input
                              type="checkbox"
                              checked={useHybridView}
                              onChange={(e) => {
                                setUseHybridView(e.target.checked);
                                if (e.target.checked && fieldMappings.length > 0 && !selectedMappingId) {
                                  setSelectedMappingId(fieldMappings[0].id);
                                }
                              }}
                              style={{ cursor: 'pointer' }}
                            />
                            Hybrid View
                          </label>
                        </div>

                        {useHybridView ? (
                          /* Hybrid Summary + Detail View */
                          <div style={{ 
                            display: 'flex', 
                            gap: '12px', 
                            marginTop: '8px',
                            minHeight: '600px',
                            height: 'calc(100vh - 400px)',
                            maxHeight: '900px'
                          }}>
                            {/* Left Panel: Summary List */}
                            <div style={{ 
                              width: '32%', 
                              border: '1px solid #e5e7eb', 
                              borderRadius: '6px',
                              backgroundColor: '#fafafa',
                              padding: '10px',
                              display: 'flex',
                              flexDirection: 'column',
                              overflowY: 'auto'
                            }}>
                              <div style={{ 
                                marginBottom: '10px', 
                                paddingBottom: '8px', 
                                borderBottom: '2px solid #e5e7eb',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center'
                              }}>
                                <h4 style={{ margin: 0, fontSize: '13px', fontWeight: '600', color: '#002329' }}>
                                  Summary
                                </h4>
                                <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                  <button
                                    type="button"
                                    onClick={() => setShowTemplateModal(true)}
                                    style={{
                                      padding: '6px 10px',
                                      fontSize: '11px',
                                      backgroundColor: '#f9fafb',
                                      color: '#374151',
                                      border: '1px solid #e5e7eb',
                                      borderRadius: '4px',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '4px'
                                    }}
                                    title="Apply transformation template"
                                  >
                                    <Plus size={12} />
                                    Template
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const newMapping = {
                                        id: Date.now(),
                                        targetField: '',
                                        sourceField: '',
                                        transformation: 'copy',
                                        formula: '',
                                        concatenateFields: [],
                                        separator: ' ',
                                        dateFormat: 'YYYY-MM-DD',
                                        numberFormat: '0.00',
                                        valueMappings: [{ from: '', to: '' }],
                                        conditions: [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }],
                                        cases: [{ value: '', targetValue: '' }]
                                      };
                                      setFieldMappings([...fieldMappings, newMapping]);
                                      setSelectedMappingId(newMapping.id);
                                    }}
                                    style={{
                                      padding: '6px 10px',
                                      fontSize: '11px',
                                      backgroundColor: '#f0f9ff',
                                      color: '#0284c7',
                                      border: '1px solid #bae6fd',
                                      borderRadius: '4px',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '4px'
                                    }}
                                  >
                                    <Plus size={12} />
                                    Add
                                  </button>
                                </div>
                              </div>

                              {fieldMappings.length === 0 ? (
                                <div style={{ 
                                  padding: '24px', 
                                  textAlign: 'center', 
                                  color: '#666', 
                                  fontSize: '12px' 
                                }}>
                                  No mappings yet. Click "Add" to create one.
                                </div>
                              ) : (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {fieldMappings.map((mapping, index) => {
                                    const status = getMappingStatus(mapping);
                                    const summary = getMappingSummary(mapping);
                                    const isSelected = selectedMappingId === mapping.id;
                                    
                                    return (
                                      <div
                                        key={mapping.id}
                                        onClick={() => setSelectedMappingId(mapping.id)}
                                        style={{
                                          padding: '10px',
                                          border: `2px solid ${isSelected ? '#08979C' : '#e5e7eb'}`,
                                          borderRadius: '6px',
                                          backgroundColor: isSelected ? '#f0f9ff' : '#fff',
                                          cursor: 'pointer',
                                          transition: 'all 0.2s'
                                        }}
                                      >
                                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                                          <div style={{ marginTop: '2px', flexShrink: 0 }}>
                                            {status === 'valid' && <Check size={16} color="#16a34a" />}
                                            {status === 'incomplete' && <AlertTriangle size={16} color="#f59e0b" />}
                                          </div>
                                          <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ fontSize: '12px', fontWeight: '600', color: '#002329', marginBottom: '4px' }}>
                                              Mapping {index + 1}
                                            </div>
                                            <div style={{ fontSize: '11px', color: '#666', wordBreak: 'break-word', lineHeight: '1.4' }}>
                                              {summary}
                                            </div>
                                          </div>
                                          {isSelected && (
                                            <ChevronRight size={16} color="#08979C" style={{ flexShrink: 0 }} />
                                          )}
                                        </div>
                                        <div style={{ display: 'flex', gap: '4px', marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #e5e7eb' }}>
                                          <button
                                            type="button"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              duplicateMapping(mapping.id);
                                            }}
                                            style={{
                                              padding: '4px 8px',
                                              fontSize: '10px',
                                              backgroundColor: '#f0f9ff',
                                              color: '#0284c7',
                                              border: '1px solid #bae6fd',
                                              borderRadius: '4px',
                                              cursor: 'pointer',
                                              display: 'flex',
                                              alignItems: 'center',
                                              gap: '4px'
                                            }}
                                            title="Duplicate mapping"
                                          >
                                            <Copy size={10} />
                                            Duplicate
                                          </button>
                                          {fieldMappings.length > 1 && (
                                            <button
                                              type="button"
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                setFieldMappings(fieldMappings.filter(m => m.id !== mapping.id));
                                                if (selectedMappingId === mapping.id) {
                                                  setSelectedMappingId(fieldMappings.find(m => m.id !== mapping.id)?.id || null);
                                                }
                                              }}
                                              style={{
                                                padding: '4px 8px',
                                                fontSize: '10px',
                                                backgroundColor: '#fee2e2',
                                                color: '#dc2626',
                                                border: '1px solid #fecaca',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '4px'
                                              }}
                                              title="Delete mapping"
                                            >
                                              <Trash2 size={10} />
                                              Delete
                                            </button>
                                          )}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>

                            {/* Right Panel: Detail Editor */}
                            <div style={{ 
                              width: '68%', 
                              border: '1px solid #e5e7eb', 
                              borderRadius: '6px',
                              backgroundColor: '#fff',
                              padding: '12px',
                              overflowY: 'auto'
                            }}>
                              {selectedMappingId && fieldMappings.find(m => m.id === selectedMappingId) ? (
                                (() => {
                                  const mapping = fieldMappings.find(m => m.id === selectedMappingId);
                                  const index = fieldMappings.findIndex(m => m.id === selectedMappingId);
                                  return (
                                    <div>
                                      <div style={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center', 
                                        marginBottom: '12px',
                                        paddingBottom: '10px',
                                        borderBottom: '2px solid #e5e7eb'
                                      }}>
                                        <h4 style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: '#002329' }}>
                                          Edit Mapping {index + 1}
                                        </h4>
                                        <div style={{ display: 'flex', gap: '8px', fontSize: '11px', alignItems: 'center' }}>
                                          {getMappingStatus(mapping) === 'valid' && (
                                            <span style={{ padding: '4px 8px', backgroundColor: '#d1fae5', color: '#16a34a', borderRadius: '4px', fontWeight: '500' }}>
                                              ✓ Valid
                                            </span>
                                          )}
                                          {getMappingStatus(mapping) === 'incomplete' && (
                                            <span style={{ padding: '4px 8px', backgroundColor: '#fef3c7', color: '#f59e0b', borderRadius: '4px', fontWeight: '500' }}>
                                              ⚠ Incomplete
                                            </span>
                                          )}
                                        </div>
                                      </div>
                                      
                                      {/* Render the full mapping editor - reuse from card view */}
                                      {/* Render the selected mapping editor using the same structure as card view */}
                                      {fieldMappings.filter(m => m.id === selectedMappingId).map((selectedMapping) => {
                                        const actualIndex = fieldMappings.findIndex(m => m.id === selectedMapping.id);
                                        return (
                                          <div key={selectedMapping.id}>
                                            <div className="form-grid compact-grid" style={{ 
                                              gap: '8px', 
                                              gridTemplateColumns: (selectedMapping.transformation === 'formula' || selectedMapping.transformation === 'concatenate' || selectedMapping.transformation === 'valueMap' || selectedMapping.transformation === 'conditional') ? '1fr 1fr' : '1fr 1fr 1fr'
                                            }}>
                                              <div className="form-group">
                                                <label>Target Field *</label>
                                                {loadingFields ? (
                                                  <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                                ) : (
                                                  <select
                                                    value={selectedMapping.targetField}
                                                    onChange={async (e) => {
                                                      const selectedFieldName = e.target.value;
                                                      const selectedField = fields.find(f => f.name === selectedFieldName);
                                                      const updated = fieldMappings.map(m => {
                                                        if (m.id === selectedMapping.id) {
                                                          const newMapping = { ...m, targetField: selectedFieldName };
                                                          if (selectedField && selectedField.type === 'picklist' && m.transformation === 'conditional') {
                                                            fetchTargetPicklistValues(selectedMapping.id, selectedFieldName);
                                                          }
                                                          return newMapping;
                                                        }
                                                        return m;
                                                      });
                                                      setFieldMappings(updated);
                                                    }}
                                                    disabled={!selectedObject || fields.length === 0}
                                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                  >
                                                    <option value="">--Select Target Field--</option>
                                                    {fields.map((field) => (
                                                      <option key={field.name} value={field.name}>
                                                        {field.label} ({field.type})
                                                      </option>
                                                    ))}
                                                  </select>
                                                )}
                                              </div>

                                              <div className="form-group">
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                                  Transformation *
                                                  <button
                                                    type="button"
                                                    onClick={() => setShowTransformationHelpModal(true)}
                                                    style={{
                                                      background: 'none',
                                                      border: '1px solid #0284c7',
                                                      borderRadius: '50%',
                                                      width: '16px',
                                                      height: '16px',
                                                      display: 'flex',
                                                      alignItems: 'center',
                                                      justifyContent: 'center',
                                                      cursor: 'pointer',
                                                      color: '#0284c7',
                                                      fontSize: '10px',
                                                      fontWeight: 'bold',
                                                      padding: 0
                                                    }}
                                                    title="Click for help on transformation types"
                                                  >
                                                    ?
                                                  </button>
                                                </label>
                                                <select
                                                  value={selectedMapping.transformation}
                                                  onChange={async (e) => {
                                                    const newTransformation = e.target.value;
                                                    const updated = fieldMappings.map(m => {
                                                      if (m.id === selectedMapping.id) {
                                                        const baseUpdate = { 
                                                          ...m, 
                                                          transformation: newTransformation
                                                        };
                                                        if (newTransformation === 'formula' || newTransformation === 'concatenate' || newTransformation === 'valueMap' || newTransformation === 'conditional' || newTransformation === 'switch') {
                                                          baseUpdate.sourceField = '';
                                                        }
                                                        if (newTransformation === 'valueMap' && !m.valueMappings) {
                                                          baseUpdate.valueMappings = [{ from: '', to: '' }];
                                                        }
                                                        if (newTransformation === 'conditional') {
                                                          if (!m.conditions || !Array.isArray(m.conditions) || m.conditions.length === 0) {
                                                            baseUpdate.conditions = [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }];
                                                          }
                                                          if (!m.conditionField) {
                                                            baseUpdate.conditionField = '';
                                                            baseUpdate.conditionValue = '';
                                                            baseUpdate.conditionOperator = 'equals';
                                                            baseUpdate.thenValue = '';
                                                            baseUpdate.elseValue = '';
                                                          }
                                                        }
                                                        if (newTransformation === 'textReplace') {
                                                          baseUpdate.findText = '';
                                                          baseUpdate.replaceText = '';
                                                          baseUpdate.replaceMode = 'all';
                                                          baseUpdate.caseSensitive = false;
                                                          baseUpdate.useRegex = false;
                                                        }
                                                        if (newTransformation === 'defaultValue') {
                                                          baseUpdate.defaultValue = '';
                                                          baseUpdate.applyWhen = 'empty';
                                                        }
                                                        if (newTransformation === 'typeConversion') {
                                                          baseUpdate.targetType = 'string';
                                                          baseUpdate.conversionFormat = '';
                                                        }
                                                        if (newTransformation === 'validateFormat') {
                                                          baseUpdate.validationType = 'email';
                                                          baseUpdate.customPattern = '';
                                                          baseUpdate.onInvalid = 'default';
                                                        }
                                                        if (newTransformation === 'removeSpecialChars') {
                                                          baseUpdate.removeMode = 'removeAll';
                                                        }
                                                        if (newTransformation === 'switch') {
                                                          baseUpdate.cases = [{ value: '', targetValue: '' }];
                                                          baseUpdate.switchDefaultValue = '';
                                                        }
                                                        if (newTransformation === 'conditional' && m.targetField) {
                                                          const targetField = fields.find(f => f.name === m.targetField);
                                                          if (targetField && targetField.type === 'picklist') {
                                                            fetchTargetPicklistValues(selectedMapping.id, m.targetField);
                                                          }
                                                        }
                                                        return baseUpdate;
                                                      }
                                                      return m;
                                                    });
                                                    setFieldMappings(updated);
                                                  }}
                                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                >
                                                  <option value="copy">Copy (Direct) - Copy value as-is</option>
                                                  <option value="uppercase">Uppercase - Convert to uppercase</option>
                                                  <option value="lowercase">Lowercase - Convert to lowercase</option>
                                                  <option value="textReplace">Text Replace - Find and replace text</option>
                                                  <option value="concatenate">Concatenate - Combine multiple fields</option>
                                                  <option value="formula">Formula - Calculate using expression</option>
                                                  <option value="dateFormat">Date Format - Format date value</option>
                                                  <option value="numberFormat">Number Format - Format number value</option>
                                                  <option value="valueMap">Value Map - Map specific values (e.g., "Yes" → true)</option>
                                                  <option value="switch">Switch/Case - Map multiple values to different targets</option>
                                                  <option value="conditional">Conditional - If-then-else logic (Enhanced)</option>
                                                  <option value="defaultValue">Default Value - Use default if source is empty</option>
                                                  <option value="typeConversion">Type Conversion - Convert data type</option>
                                                  <option value="validateFormat">Format Validation - Validate format (email, phone, etc.)</option>
                                                  <option value="removeSpecialChars">Remove Special Characters - Clean text</option>
                                                </select>
                                              </div>

                                              {selectedMapping.transformation !== 'formula' && selectedMapping.transformation !== 'concatenate' && selectedMapping.transformation !== 'valueMap' && selectedMapping.transformation !== 'conditional' && (
                                                <div className="form-group">
                                                  <label>Source Field *</label>
                                                  {loadingFields ? (
                                                    <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                                  ) : (
                                                    <select
                                                      value={selectedMapping.sourceField}
                                                      onChange={(e) => {
                                                        const updated = fieldMappings.map(m => 
                                                          m.id === selectedMapping.id ? { ...m, sourceField: e.target.value } : m
                                                        );
                                                        setFieldMappings(updated);
                                                      }}
                                                      disabled={!sourceObject || sourceFields.length === 0}
                                                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                    >
                                                      <option value="">--Select Source Field--</option>
                                                      {sourceFields.map((field) => (
                                                        <option key={field.name} value={field.name}>
                                                          {field.label} ({field.type})
                                                        </option>
                                                      ))}
                                                    </select>
                                                  )}
                                                </div>
                                              )}

                                              {/* Transformation-specific fields - render based on selected transformation type */}
                                              {/* Formula Transformation */}
                                              {selectedMapping.transformation === 'formula' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Formula *</label>
                                                  <input
                                                    type="text"
                                                    value={selectedMapping.formula || ''}
                                                    onChange={(e) => {
                                                      const updated = fieldMappings.map(m => 
                                                        m.id === selectedMapping.id ? { ...m, formula: e.target.value } : m
                                                      );
                                                      setFieldMappings(updated);
                                                    }}
                                                    placeholder="e.g., {Field1} + ' ' + {Field2} or {Amount} * 1.1"
                                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                  />
                                                  <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                                    Use {'{FieldName}'} to reference source fields. Supports basic math operations (+, -, *, /) and string concatenation with +.
                                                  </div>
                                                </div>
                                              )}

                                              {/* Concatenate Transformation */}
                                              {selectedMapping.transformation === 'concatenate' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Source Fields (Select multiple) *</label>
                                                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', marginTop: '4px' }}>
                                                    {sourceFields.map((field) => (
                                                      <label key={field.name} style={{ 
                                                        display: 'flex', 
                                                        alignItems: 'center', 
                                                        gap: '4px',
                                                        fontSize: '12px',
                                                        cursor: 'pointer',
                                                        padding: '4px 8px',
                                                        backgroundColor: (selectedMapping.concatenateFields || []).includes(field.name) ? '#dbeafe' : '#f3f4f6',
                                                        borderRadius: '4px',
                                                        border: `1px solid ${(selectedMapping.concatenateFields || []).includes(field.name) ? '#3b82f6' : '#e5e7eb'}`
                                                      }}>
                                                        <input
                                                          type="checkbox"
                                                          checked={(selectedMapping.concatenateFields || []).includes(field.name)}
                                                          onChange={(e) => {
                                                            const updated = fieldMappings.map(m => {
                                                              if (m.id === selectedMapping.id) {
                                                                const fields = [...(m.concatenateFields || [])];
                                                                if (e.target.checked) {
                                                                  fields.push(field.name);
                                                                } else {
                                                                  const index = fields.indexOf(field.name);
                                                                  if (index > -1) fields.splice(index, 1);
                                                                }
                                                                return { ...m, concatenateFields: fields };
                                                              }
                                                              return m;
                                                            });
                                                            setFieldMappings(updated);
                                                          }}
                                                        />
                                                        {field.label}
                                                      </label>
                                                    ))}
                                                  </div>
                                                  {(selectedMapping.concatenateFields || []).length > 0 && (
                                                    <div style={{ marginTop: '12px' }}>
                                                      <label style={{ fontSize: '12px', display: 'block', marginBottom: '4px', fontWeight: '500' }}>
                                                        Separator *
                                                      </label>
                                                      <input
                                                        type="text"
                                                        value={selectedMapping.separator || ' '}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, separator: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Enter separator (e.g., space, comma, dash)"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', maxWidth: '300px' }}
                                                      />
                                                    </div>
                                                  )}
                                                </div>
                                              )}

                                              {/* Value Map Transformation */}
                                              {selectedMapping.transformation === 'valueMap' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Value Mappings *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '8px' }}>
                                                    Map source values to target values.
                                                  </div>
                                                  {(selectedMapping.valueMappings || [{ from: '', to: '' }]).map((valueMap, mapIndex) => (
                                                    <div key={mapIndex} style={{ 
                                                      display: 'flex', 
                                                      gap: '8px', 
                                                      marginBottom: '8px',
                                                      alignItems: 'center'
                                                    }}>
                                                      <input
                                                        type="text"
                                                        value={valueMap.from}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => {
                                                            if (m.id === selectedMapping.id) {
                                                              const newMappings = [...(m.valueMappings || [{ from: '', to: '' }])];
                                                              newMappings[mapIndex] = { ...newMappings[mapIndex], from: e.target.value };
                                                              return { ...m, valueMappings: newMappings };
                                                            }
                                                            return m;
                                                          });
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Source value"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                                      />
                                                      <span style={{ fontSize: '12px', color: '#666' }}>→</span>
                                                      <input
                                                        type="text"
                                                        value={valueMap.to}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => {
                                                            if (m.id === selectedMapping.id) {
                                                              const newMappings = [...(m.valueMappings || [{ from: '', to: '' }])];
                                                              newMappings[mapIndex] = { ...newMappings[mapIndex], to: e.target.value };
                                                              return { ...m, valueMappings: newMappings };
                                                            }
                                                            return m;
                                                          });
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Target value"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                                      />
                                                      {(selectedMapping.valueMappings || []).length > 1 && (
                                                        <button
                                                          type="button"
                                                          onClick={() => {
                                                            const updated = fieldMappings.map(m => {
                                                              if (m.id === selectedMapping.id) {
                                                                const newMappings = [...(m.valueMappings || [])];
                                                                newMappings.splice(mapIndex, 1);
                                                                return { ...m, valueMappings: newMappings.length > 0 ? newMappings : [{ from: '', to: '' }] };
                                                              }
                                                              return m;
                                                            });
                                                            setFieldMappings(updated);
                                                          }}
                                                          style={{
                                                            padding: '4px 8px',
                                                            fontSize: '11px',
                                                            backgroundColor: '#fee2e2',
                                                            color: '#dc2626',
                                                            border: '1px solid #fecaca',
                                                            borderRadius: '4px',
                                                            cursor: 'pointer'
                                                          }}
                                                        >
                                                          <X size={12} />
                                                        </button>
                                                      )}
                                                    </div>
                                                  ))}
                                                  <button
                                                    type="button"
                                                    onClick={() => {
                                                      const updated = fieldMappings.map(m => {
                                                        if (m.id === selectedMapping.id) {
                                                          return { 
                                                            ...m, 
                                                            valueMappings: [...(m.valueMappings || [{ from: '', to: '' }]), { from: '', to: '' }]
                                                          };
                                                        }
                                                        return m;
                                                      });
                                                      setFieldMappings(updated);
                                                    }}
                                                    style={{
                                                      padding: '6px 12px',
                                                      fontSize: '12px',
                                                      backgroundColor: '#f0f9ff',
                                                      color: '#0284c7',
                                                      border: '1px solid #bae6fd',
                                                      borderRadius: '4px',
                                                      cursor: 'pointer',
                                                      display: 'flex',
                                                      alignItems: 'center',
                                                      gap: '4px'
                                                    }}
                                                  >
                                                    <Plus size={14} />
                                                    Add Mapping
                                                  </button>
                                                </div>
                                              )}

                                              {/* Date Format Transformation */}
                                              {selectedMapping.transformation === 'dateFormat' && (
                                                <div className="form-group">
                                                  <label>Date Format *</label>
                                                  <select
                                                    value={selectedMapping.dateFormat}
                                                    onChange={(e) => {
                                                      const updated = fieldMappings.map(m => 
                                                        m.id === selectedMapping.id ? { ...m, dateFormat: e.target.value } : m
                                                      );
                                                      setFieldMappings(updated);
                                                    }}
                                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                  >
                                                    <option value="YYYY-MM-DD">YYYY-MM-DD (e.g., 2024-01-15)</option>
                                                    <option value="MM/DD/YYYY">MM/DD/YYYY (e.g., 01/15/2024)</option>
                                                    <option value="DD/MM/YYYY">DD/MM/YYYY (e.g., 15/01/2024)</option>
                                                    <option value="YYYY/MM/DD">YYYY/MM/DD (e.g., 2024/01/15)</option>
                                                    <option value="DD-MM-YYYY">DD-MM-YYYY (e.g., 15-01-2024)</option>
                                                  </select>
                                                  <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                                    Select the date format to apply to the source date field value.
                                                  </div>
                                                </div>
                                              )}

                                              {/* Number Format Transformation */}
                                              {selectedMapping.transformation === 'numberFormat' && (
                                                <div className="form-group">
                                                  <label>Number Format *</label>
                                                  <input
                                                    type="text"
                                                    value={selectedMapping.numberFormat}
                                                    onChange={(e) => {
                                                      const updated = fieldMappings.map(m => 
                                                        m.id === selectedMapping.id ? { ...m, numberFormat: e.target.value } : m
                                                      );
                                                      setFieldMappings(updated);
                                                    }}
                                                    placeholder="e.g., 0.00, 0,000.00"
                                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                  />
                                                  <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                                    Specify decimal places: "0.00" for 2 decimals, "0" for whole numbers. Use "0,000.00" for thousands separator.
                                                  </div>
                                                </div>
                                              )}

                                              {/* Conditional Transformation */}
                                              {selectedMapping.transformation === 'conditional' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Conditional Logic * (Enhanced - Multiple Conditions)</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Set target field based on one or more conditions with AND/OR logic. If all/any conditions are met, set target to one value, otherwise set to another.
                                                  </div>
                                                  
                                                  {/* Enhanced Multiple Conditions UI */}
                                                  {(() => {
                                                    const conditions = selectedMapping.conditions && Array.isArray(selectedMapping.conditions) && selectedMapping.conditions.length > 0 
                                                      ? selectedMapping.conditions 
                                                      : (selectedMapping.conditionField ? [{ 
                                                          id: Date.now(), 
                                                          field: selectedMapping.conditionField, 
                                                          operator: selectedMapping.conditionOperator || 'equals', 
                                                          value: selectedMapping.conditionValue || '', 
                                                          logicalOperator: 'AND' 
                                                        }] : [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }]);
                                                    
                                                    return (
                                                      <div>
                                                        {conditions.map((condition, condIndex) => (
                                                          <div key={condition.id || condIndex} style={{ 
                                                            border: '1px solid #e0e0e0', 
                                                            borderRadius: '4px', 
                                                            padding: '12px', 
                                                            marginBottom: '12px',
                                                            backgroundColor: '#fafafa',
                                                            position: 'relative',
                                                            zIndex: 1
                                                          }}>
                                                            {condIndex > 0 && (
                                                              <div style={{ marginBottom: '8px' }}>
                                                                <select
                                                                  value={condition.logicalOperator || 'AND'}
                                                                  onChange={(e) => {
                                                                    const updated = fieldMappings.map(m => {
                                                                      if (m.id === selectedMapping.id) {
                                                                        const newConditions = [...(m.conditions || conditions)];
                                                                        newConditions[condIndex] = { ...newConditions[condIndex], logicalOperator: e.target.value };
                                                                        return { ...m, conditions: newConditions };
                                                                      }
                                                                      return m;
                                                                    });
                                                                    setFieldMappings(updated);
                                                                  }}
                                                                  style={{ 
                                                                    fontSize: '11px', 
                                                                    padding: '4px 8px', 
                                                                    height: '28px',
                                                                    backgroundColor: '#08979C',
                                                                    color: '#fff',
                                                                    border: 'none',
                                                                    borderRadius: '4px',
                                                                    fontWeight: 600
                                                                  }}
                                                                >
                                                                  <option value="AND">AND</option>
                                                                  <option value="OR">OR</option>
                                                                </select>
                                                              </div>
                                                            )}
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', position: 'relative' }}>
                                                              <div className="form-group" style={{ position: 'relative', zIndex: 1 }}>
                                                                <label style={{ fontSize: '11px', marginBottom: '4px' }}>Condition Field *</label>
                                                                {loadingFields ? (
                                                                  <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                                                ) : (
                                                                  <select
                                                                    value={condition.field || ''}
                                                                    onChange={async (e) => {
                                                                      const selectedFieldName = e.target.value;
                                                                      const selectedField = sourceFields.find(f => f.name === selectedFieldName);
                                                                      const updated = fieldMappings.map(m => {
                                                                        if (m.id === selectedMapping.id) {
                                                                          const newConditions = [...(m.conditions || conditions)];
                                                                          newConditions[condIndex] = { ...newConditions[condIndex], field: selectedFieldName, value: '' };
                                                                          // If it's a picklist field, use its picklist values
                                                                          if (selectedField && selectedField.type === 'picklist' && selectedField.picklistValues) {
                                                                            setConditionPicklistValues(prev => ({
                                                                              ...prev,
                                                                              [`${selectedMapping.id}-${condIndex}`]: selectedField.picklistValues || []
                                                                            }));
                                                                          } else if (selectedField && selectedField.type === 'picklist') {
                                                                            // Fetch picklist values if not already loaded
                                                                            fetchConditionPicklistValues(`${selectedMapping.id}-${condIndex}`, selectedFieldName);
                                                                          } else {
                                                                            // Clear picklist values if not a picklist
                                                                            setConditionPicklistValues(prev => {
                                                                              const newState = { ...prev };
                                                                              delete newState[`${selectedMapping.id}-${condIndex}`];
                                                                              return newState;
                                                                            });
                                                                          }
                                                                          return { ...m, conditions: newConditions };
                                                                        }
                                                                        return m;
                                                                      });
                                                                      setFieldMappings(updated);
                                                                    }}
                                                                    disabled={!sourceObject}
                                                                    style={{ 
                                                                      fontSize: '12px', 
                                                                      padding: '6px 10px', 
                                                                      height: '32px', 
                                                                      width: '100%',
                                                                      position: 'relative',
                                                                      zIndex: 10,
                                                                      backgroundColor: !sourceObject ? '#f5f5f5' : '#fff',
                                                                      cursor: !sourceObject ? 'not-allowed' : 'pointer'
                                                                    }}
                                                                    onClick={(e) => {
                                                                      e.stopPropagation();
                                                                    }}
                                                                    onFocus={(e) => {
                                                                      e.stopPropagation();
                                                                    }}
                                                                  >
                                                                    <option value="">--Select Field--</option>
                                                                    {sourceFields.map((field) => (
                                                                      <option key={field.name} value={field.name}>
                                                                        {field.label} ({field.type})
                                                                      </option>
                                                                    ))}
                                                                  </select>
                                                                )}
                                                              </div>

                                                              <div className="form-group">
                                                                <label style={{ fontSize: '11px', marginBottom: '4px' }}>Operator *</label>
                                                                <select
                                                                  value={condition.operator || 'equals'}
                                                                  onChange={(e) => {
                                                                    const updated = fieldMappings.map(m => {
                                                                      if (m.id === selectedMapping.id) {
                                                                        const newConditions = [...(m.conditions || conditions)];
                                                                        newConditions[condIndex] = { ...newConditions[condIndex], operator: e.target.value, value: ['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(e.target.value) ? '' : newConditions[condIndex].value };
                                                                        return { ...m, conditions: newConditions };
                                                                      }
                                                                      return m;
                                                                    });
                                                                    setFieldMappings(updated);
                                                                  }}
                                                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                                >
                                                                  <option value="equals">Equals (=)</option>
                                                                  <option value="notEquals">Not Equals (≠)</option>
                                                                  <option value="contains">Contains</option>
                                                                  <option value="startsWith">Starts With</option>
                                                                  <option value="endsWith">Ends With</option>
                                                                  <option value="greaterThan">Greater Than (&gt;)</option>
                                                                  <option value="lessThan">Less Than (&lt;)</option>
                                                                  <option value="greaterThanOrEqual">Greater Than or Equal (≥)</option>
                                                                  <option value="lessThanOrEqual">Less Than or Equal (≤)</option>
                                                                  <option value="isEmpty">Is Empty</option>
                                                                  <option value="isNotEmpty">Is Not Empty</option>
                                                                  <option value="isNull">Is Null</option>
                                                                  <option value="isNotNull">Is Not Null</option>
                                                                </select>
                                                              </div>

                                                              <div className="form-group" style={{ position: 'relative' }}>
                                                                <label style={{ fontSize: '11px', marginBottom: '4px' }}>
                                                                  {['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(condition.operator) ? 'Value (N/A)' : 'Condition Value *'}
                                                                </label>
                                                                {['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(condition.operator) ? (
                                                                  <input
                                                                    type="text"
                                                                    value=""
                                                                    disabled
                                                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', backgroundColor: '#f5f5f5', color: '#999' }}
                                                                  />
                                                                ) : (() => {
                                                                  const conditionField = sourceFields.find(f => f.name === condition.field);
                                                                  const isPicklist = conditionField && conditionField.type === 'picklist';
                                                                  const picklistValues = conditionPicklistValues[`${selectedMapping.id}-${condIndex}`] || (conditionField && conditionField.picklistValues ? conditionField.picklistValues : []);
                                                                  
                                                                  if (isPicklist && picklistValues.length > 0) {
                                                                    return (
                                                                      <select
                                                                        value={condition.value || ''}
                                                                        onChange={(e) => {
                                                                          const updated = fieldMappings.map(m => {
                                                                            if (m.id === selectedMapping.id) {
                                                                              const newConditions = [...(m.conditions || conditions)];
                                                                              newConditions[condIndex] = { ...newConditions[condIndex], value: e.target.value };
                                                                              return { ...m, conditions: newConditions };
                                                                            }
                                                                            return m;
                                                                          });
                                                                          setFieldMappings(updated);
                                                                        }}
                                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                                      >
                                                                        <option value="">--Select Value--</option>
                                                                        {picklistValues.map((value) => (
                                                                          <option key={value} value={value}>
                                                                            {value}
                                                                          </option>
                                                                        ))}
                                                                      </select>
                                                                    );
                                                                  } else {
                                                                    return (
                                                                      <input
                                                                        type="text"
                                                                        value={condition.value || ''}
                                                                        onChange={(e) => {
                                                                          const updated = fieldMappings.map(m => {
                                                                            if (m.id === selectedMapping.id) {
                                                                              const newConditions = [...(m.conditions || conditions)];
                                                                              newConditions[condIndex] = { ...newConditions[condIndex], value: e.target.value };
                                                                              return { ...m, conditions: newConditions };
                                                                            }
                                                                            return m;
                                                                          });
                                                                          setFieldMappings(updated);
                                                                        }}
                                                                        placeholder="Value to compare"
                                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                                      />
                                                                    );
                                                                  }
                                                                })()}
                                                                {conditions.length > 1 && (
                                                                  <button
                                                                    type="button"
                                                                    onClick={() => {
                                                                      const updated = fieldMappings.map(m => {
                                                                        if (m.id === selectedMapping.id) {
                                                                          const newConditions = [...(m.conditions || conditions)];
                                                                          newConditions.splice(condIndex, 1);
                                                                          return { ...m, conditions: newConditions.length > 0 ? newConditions : [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }] };
                                                                        }
                                                                        return m;
                                                                      });
                                                                      setFieldMappings(updated);
                                                                    }}
                                                                    style={{
                                                                      position: 'absolute',
                                                                      right: '4px',
                                                                      top: '24px',
                                                                      padding: '2px 6px',
                                                                      fontSize: '10px',
                                                                      backgroundColor: '#fee2e2',
                                                                      color: '#dc2626',
                                                                      border: '1px solid #fecaca',
                                                                      borderRadius: '4px',
                                                                      cursor: 'pointer'
                                                                    }}
                                                                  >
                                                                    <X size={10} />
                                                                  </button>
                                                                )}
                                                              </div>
                                                            </div>
                                                          </div>
                                                        ))}
                                                        <button
                                                          type="button"
                                                          onClick={() => {
                                                            const updated = fieldMappings.map(m => {
                                                              if (m.id === selectedMapping.id) {
                                                                const currentConditions = m.conditions && Array.isArray(m.conditions) && m.conditions.length > 0 
                                                                  ? m.conditions 
                                                                  : (m.conditionField ? [{ 
                                                                      id: Date.now(), 
                                                                      field: m.conditionField, 
                                                                      operator: m.conditionOperator || 'equals', 
                                                                      value: m.conditionValue || '', 
                                                                      logicalOperator: 'AND' 
                                                                    }] : [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }]);
                                                                return { 
                                                                  ...m, 
                                                                  conditions: [...currentConditions, { id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }]
                                                                };
                                                              }
                                                              return m;
                                                            });
                                                            setFieldMappings(updated);
                                                          }}
                                                          style={{
                                                            padding: '6px 12px',
                                                            fontSize: '12px',
                                                            backgroundColor: '#f0f9ff',
                                                            color: '#0284c7',
                                                            border: '1px solid #bae6fd',
                                                            borderRadius: '4px',
                                                            cursor: 'pointer',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            gap: '4px',
                                                            marginBottom: '12px'
                                                          }}
                                                        >
                                                          <Plus size={14} />
                                                          Add Condition
                                                        </button>
                                                      </div>
                                                    );
                                                  })()}
                                                  
                                                  {/* Then/Else Value sections */}
                                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginTop: '12px' }}>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Then Value (if condition is true) *</label>
                                                      {(() => {
                                                        const targetField = fields.find(f => f.name === selectedMapping.targetField);
                                                        const isPicklist = targetField && targetField.type === 'picklist';
                                                        const picklistValues = targetPicklistValues[selectedMapping.id] || [];

                                                        if (isPicklist && picklistValues.length > 0) {
                                                          return (
                                                            <select
                                                              value={selectedMapping.thenValue || ''}
                                                              onChange={(e) => {
                                                                const updated = fieldMappings.map(m => 
                                                                  m.id === selectedMapping.id ? { ...m, thenValue: e.target.value } : m
                                                                );
                                                                setFieldMappings(updated);
                                                              }}
                                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                            >
                                                              <option value="">--Select Value--</option>
                                                              {picklistValues.map((value) => (
                                                                <option key={value} value={value}>
                                                                  {value}
                                                                </option>
                                                              ))}
                                                            </select>
                                                          );
                                                        } else {
                                                          return (
                                                            <input
                                                              type="text"
                                                              value={selectedMapping.thenValue || ''}
                                                              onChange={(e) => {
                                                                const updated = fieldMappings.map(m => 
                                                                  m.id === selectedMapping.id ? { ...m, thenValue: e.target.value } : m
                                                                );
                                                                setFieldMappings(updated);
                                                              }}
                                                              placeholder="Value if condition matches"
                                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                            />
                                                          );
                                                        }
                                                      })()}
                                                    </div>

                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Else Value (if condition is false)</label>
                                                      {(() => {
                                                        const targetField = fields.find(f => f.name === selectedMapping.targetField);
                                                        const isPicklist = targetField && targetField.type === 'picklist';
                                                        const picklistValues = targetPicklistValues[selectedMapping.id] || [];

                                                        if (isPicklist && picklistValues.length > 0) {
                                                          return (
                                                            <select
                                                              value={selectedMapping.elseValue || ''}
                                                              onChange={(e) => {
                                                                const updated = fieldMappings.map(m => 
                                                                  m.id === selectedMapping.id ? { ...m, elseValue: e.target.value } : m
                                                                );
                                                                setFieldMappings(updated);
                                                              }}
                                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                            >
                                                              <option value="">--Select Value (Optional)--</option>
                                                              {picklistValues.map((value) => (
                                                                <option key={value} value={value}>
                                                                  {value}
                                                                </option>
                                                              ))}
                                                            </select>
                                                          );
                                                        } else {
                                                          return (
                                                            <input
                                                              type="text"
                                                              value={selectedMapping.elseValue || ''}
                                                              onChange={(e) => {
                                                                const updated = fieldMappings.map(m => 
                                                                  m.id === selectedMapping.id ? { ...m, elseValue: e.target.value } : m
                                                                );
                                                                setFieldMappings(updated);
                                                              }}
                                                              placeholder="Value if condition doesn't match (optional)"
                                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                            />
                                                          );
                                                        }
                                                      })()}
                                                      <div style={{ fontSize: '10px', color: '#999', marginTop: '2px' }}>
                                                        If empty, target field will not be updated when condition is false
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              )}

                                              {/* Text Replace Transformation */}
                                              {selectedMapping.transformation === 'textReplace' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Text Replacement *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Find and replace text in the source field value.
                                                  </div>
                                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Find Text *</label>
                                                      <input
                                                        type="text"
                                                        value={selectedMapping.findText || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, findText: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Text to find"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      />
                                                    </div>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Replace With</label>
                                                      <input
                                                        type="text"
                                                        value={selectedMapping.replaceText || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, replaceText: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Replacement text"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      />
                                                    </div>
                                                  </div>
                                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px' }}>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Replace Mode</label>
                                                      <select
                                                        value={selectedMapping.replaceMode || 'all'}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, replaceMode: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      >
                                                        <option value="all">Replace All</option>
                                                        <option value="first">Replace First</option>
                                                        <option value="last">Replace Last</option>
                                                      </select>
                                                    </div>
                                                    <div className="form-group" style={{ display: 'flex', alignItems: 'center', marginTop: '20px' }}>
                                                      <input
                                                        type="checkbox"
                                                        checked={selectedMapping.caseSensitive || false}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, caseSensitive: e.target.checked } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ marginRight: '6px' }}
                                                      />
                                                      <label style={{ fontSize: '11px', margin: 0 }}>Case Sensitive</label>
                                                    </div>
                                                    <div className="form-group" style={{ display: 'flex', alignItems: 'center', marginTop: '20px' }}>
                                                      <input
                                                        type="checkbox"
                                                        checked={selectedMapping.useRegex || false}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, useRegex: e.target.checked } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ marginRight: '6px' }}
                                                      />
                                                      <label style={{ fontSize: '11px', margin: 0 }}>Use Regex (Advanced)</label>
                                                    </div>
                                                  </div>
                                                </div>
                                              )}

                                              {/* Default Value Transformation */}
                                              {selectedMapping.transformation === 'defaultValue' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Default Value *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Use a default value when the source field is empty, null, or invalid.
                                                  </div>
                                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Default Value *</label>
                                                      <input
                                                        type="text"
                                                        value={selectedMapping.defaultValue || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, defaultValue: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Default value to use"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      />
                                                    </div>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Apply When</label>
                                                      <select
                                                        value={selectedMapping.applyWhen || 'empty'}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, applyWhen: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      >
                                                        <option value="empty">Empty String</option>
                                                        <option value="null">Null Value</option>
                                                        <option value="emptyOrNull">Empty or Null</option>
                                                        <option value="invalid">Invalid/Invalid Type</option>
                                                      </select>
                                                    </div>
                                                  </div>
                                                </div>
                                              )}

                                              {/* Type Conversion Transformation */}
                                              {selectedMapping.transformation === 'typeConversion' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Type Conversion *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Convert the source field value to a different data type.
                                                  </div>
                                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Target Type *</label>
                                                      <select
                                                        value={selectedMapping.targetType || 'string'}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, targetType: e.target.value, conversionFormat: e.target.value === 'date' ? 'YYYY-MM-DD' : '' } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      >
                                                        <option value="string">String</option>
                                                        <option value="number">Number</option>
                                                        <option value="boolean">Boolean</option>
                                                        <option value="date">Date</option>
                                                      </select>
                                                    </div>
                                                    {selectedMapping.targetType === 'date' && (
                                                      <div className="form-group">
                                                        <label style={{ fontSize: '11px', marginBottom: '4px' }}>Date Format (Optional)</label>
                                                        <input
                                                          type="text"
                                                          value={selectedMapping.conversionFormat || 'YYYY-MM-DD'}
                                                          onChange={(e) => {
                                                            const updated = fieldMappings.map(m => 
                                                              m.id === selectedMapping.id ? { ...m, conversionFormat: e.target.value } : m
                                                            );
                                                            setFieldMappings(updated);
                                                          }}
                                                          placeholder="YYYY-MM-DD"
                                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                        />
                                                      </div>
                                                    )}
                                                  </div>
                                                </div>
                                              )}

                                              {/* Format Validation Transformation */}
                                              {selectedMapping.transformation === 'validateFormat' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Format Validation *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Validate the source field value against a format pattern. If invalid, apply the specified action.
                                                  </div>
                                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Validation Type *</label>
                                                      <select
                                                        value={selectedMapping.validationType || 'email'}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, validationType: e.target.value, customPattern: e.target.value !== 'custom' ? '' : m.customPattern } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      >
                                                        <option value="email">Email</option>
                                                        <option value="phone">Phone Number</option>
                                                        <option value="url">URL</option>
                                                        <option value="postalCode">Postal Code</option>
                                                        <option value="custom">Custom Regex</option>
                                                      </select>
                                                    </div>
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>On Invalid</label>
                                                      <select
                                                        value={selectedMapping.onInvalid || 'default'}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, onInvalid: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      >
                                                        <option value="default">Use Default Value</option>
                                                        <option value="skip">Skip Update</option>
                                                        <option value="error">Throw Error</option>
                                                      </select>
                                                    </div>
                                                  </div>
                                                  {selectedMapping.validationType === 'custom' && (
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Custom Regex Pattern *</label>
                                                      <input
                                                        type="text"
                                                        value={selectedMapping.customPattern || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, customPattern: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="e.g., ^[A-Z]{2}\\d{4}$"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      />
                                                      <div style={{ fontSize: '10px', color: '#999', marginTop: '2px' }}>
                                                        Enter a valid regular expression pattern
                                                      </div>
                                                    </div>
                                                  )}
                                                  {selectedMapping.onInvalid === 'default' && (
                                                    <div className="form-group">
                                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Default Value</label>
                                                      <input
                                                        type="text"
                                                        value={selectedMapping.defaultValue || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => 
                                                            m.id === selectedMapping.id ? { ...m, defaultValue: e.target.value } : m
                                                          );
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Default value if validation fails"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      />
                                                    </div>
                                                  )}
                                                </div>
                                              )}

                                              {/* Remove Special Characters Transformation */}
                                              {selectedMapping.transformation === 'removeSpecialChars' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Remove Special Characters *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Clean the source field value by removing special characters based on the selected mode.
                                                  </div>
                                                  <div className="form-group">
                                                    <label style={{ fontSize: '11px', marginBottom: '4px' }}>Remove Mode *</label>
                                                    <select
                                                      value={selectedMapping.removeMode || 'removeAll'}
                                                      onChange={(e) => {
                                                        const updated = fieldMappings.map(m => 
                                                          m.id === selectedMapping.id ? { ...m, removeMode: e.target.value } : m
                                                        );
                                                        setFieldMappings(updated);
                                                      }}
                                                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                    >
                                                      <option value="removeAll">Remove All Special Characters</option>
                                                      <option value="keepOnlyNumbers">Keep Only Numbers</option>
                                                      <option value="keepOnlyLetters">Keep Only Letters</option>
                                                      <option value="keepOnlyAlphanumeric">Keep Only Letters and Numbers</option>
                                                    </select>
                                                  </div>
                                                </div>
                                              )}

                                              {/* Switch/Case Transformation */}
                                              {selectedMapping.transformation === 'switch' && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                  <label>Switch/Case Mapping *</label>
                                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                                    Map multiple source values to different target values. Similar to a switch/case statement.
                                                  </div>
                                                  <div style={{ marginBottom: '12px' }}>
                                                    {(selectedMapping.cases || [{ value: '', targetValue: '' }]).map((caseItem, caseIndex) => (
                                                      <div key={caseIndex} style={{ display: 'flex', gap: '8px', marginBottom: '8px', alignItems: 'center' }}>
                                                        <input
                                                          type="text"
                                                          value={caseItem.value}
                                                          onChange={(e) => {
                                                            const updated = fieldMappings.map(m => {
                                                              if (m.id === selectedMapping.id) {
                                                                const newCases = [...(m.cases || [{ value: '', targetValue: '' }])];
                                                                newCases[caseIndex] = { ...newCases[caseIndex], value: e.target.value };
                                                                return { ...m, cases: newCases };
                                                              }
                                                              return m;
                                                            });
                                                            setFieldMappings(updated);
                                                          }}
                                                          placeholder="Source value"
                                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                                        />
                                                        <span style={{ fontSize: '12px', color: '#666' }}>→</span>
                                                        <input
                                                          type="text"
                                                          value={caseItem.targetValue}
                                                          onChange={(e) => {
                                                            const updated = fieldMappings.map(m => {
                                                              if (m.id === selectedMapping.id) {
                                                                const newCases = [...(m.cases || [{ value: '', targetValue: '' }])];
                                                                newCases[caseIndex] = { ...newCases[caseIndex], targetValue: e.target.value };
                                                                return { ...m, cases: newCases };
                                                              }
                                                              return m;
                                                            });
                                                            setFieldMappings(updated);
                                                          }}
                                                          placeholder="Target value"
                                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                                        />
                                                        {(selectedMapping.cases || []).length > 1 && (
                                                          <button
                                                            type="button"
                                                            onClick={() => {
                                                              const updated = fieldMappings.map(m => {
                                                                if (m.id === selectedMapping.id) {
                                                                  const newCases = [...(m.cases || [])];
                                                                  newCases.splice(caseIndex, 1);
                                                                  return { ...m, cases: newCases.length > 0 ? newCases : [{ value: '', targetValue: '' }] };
                                                                }
                                                                return m;
                                                              });
                                                              setFieldMappings(updated);
                                                            }}
                                                            style={{
                                                              padding: '4px 8px',
                                                              fontSize: '11px',
                                                              backgroundColor: '#fee2e2',
                                                              color: '#dc2626',
                                                              border: '1px solid #fecaca',
                                                              borderRadius: '4px',
                                                              cursor: 'pointer'
                                                            }}
                                                          >
                                                            <X size={12} />
                                                          </button>
                                                        )}
                                                      </div>
                                                    ))}
                                                    <button
                                                      type="button"
                                                      onClick={() => {
                                                        const updated = fieldMappings.map(m => {
                                                          if (m.id === selectedMapping.id) {
                                                            return { 
                                                              ...m, 
                                                              cases: [...(m.cases || [{ value: '', targetValue: '' }]), { value: '', targetValue: '' }]
                                                            };
                                                          }
                                                          return m;
                                                        });
                                                        setFieldMappings(updated);
                                                      }}
                                                      style={{
                                                        padding: '6px 12px',
                                                        fontSize: '12px',
                                                        backgroundColor: '#f0f9ff',
                                                        color: '#0284c7',
                                                        border: '1px solid #bae6fd',
                                                        borderRadius: '4px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '4px'
                                                      }}
                                                    >
                                                      <Plus size={14} />
                                                      Add Case
                                                    </button>
                                                  </div>
                                                  <div className="form-group">
                                                    <label style={{ fontSize: '11px', marginBottom: '4px' }}>Default Value (if no case matches)</label>
                                                    <input
                                                      type="text"
                                                      value={selectedMapping.switchDefaultValue || ''}
                                                      onChange={(e) => {
                                                        const updated = fieldMappings.map(m => 
                                                          m.id === selectedMapping.id ? { ...m, switchDefaultValue: e.target.value } : m
                                                        );
                                                        setFieldMappings(updated);
                                                      }}
                                                      placeholder="Default value (optional)"
                                                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                    />
                                                  </div>
                                                </div>
                                              )}
                                            </div>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  );
                                })()
                              ) : (
                                <div style={{ padding: '24px', textAlign: 'center', color: '#666', fontSize: '12px' }}>
                                  Select a mapping from the list to edit
                                </div>
                              )}
                            </div>
                          </div>
                        ) : (
                          /* Original Card-Based View */
                          <>
                            {fieldMappings.map((mapping, index) => (
                          <div key={mapping.id} style={{ 
                            marginBottom: '16px', 
                            padding: '16px', 
                            border: '1px solid #e5e7eb', 
                            borderRadius: '6px',
                            backgroundColor: '#fafafa'
                          }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <h4 style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>Field Mapping {index + 1}</h4>
                              {fieldMappings.length > 1 && (
                                <button
                                  type="button"
                                  onClick={() => {
                                    setFieldMappings(fieldMappings.filter(m => m.id !== mapping.id));
                                  }}
                                  style={{
                                    padding: '4px 8px',
                                    fontSize: '11px',
                                    backgroundColor: '#fee2e2',
                                    color: '#dc2626',
                                    border: '1px solid #fecaca',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                  }}
                                >
                                  <Trash2 size={12} />
                                  Remove
                                </button>
                              )}
                            </div>

                            <div className="form-grid compact-grid" style={{ 
                              gap: '8px', 
                              gridTemplateColumns: (mapping.transformation === 'formula' || mapping.transformation === 'concatenate' || mapping.transformation === 'valueMap' || mapping.transformation === 'conditional') ? '1fr 1fr' : '1fr 1fr 1fr'
                            }}>
                              <div className="form-group">
                                <label>Target Field *</label>
                                {loadingFields ? (
                                  <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                ) : (
                                  <select
                                    value={mapping.targetField}
                                    onChange={async (e) => {
                                      const selectedFieldName = e.target.value;
                                      const selectedField = fields.find(f => f.name === selectedFieldName);
                                      const updated = fieldMappings.map(m => {
                                        if (m.id === mapping.id) {
                                          const newMapping = { ...m, targetField: selectedFieldName };
                                          // Fetch picklist values if it's a picklist field and transformation is conditional
                                          if (selectedField && selectedField.type === 'picklist' && m.transformation === 'conditional') {
                                            fetchTargetPicklistValues(mapping.id, selectedFieldName);
                                          }
                                          return newMapping;
                                        }
                                        return m;
                                      });
                                      setFieldMappings(updated);
                                    }}
                                    disabled={!selectedObject || fields.length === 0}
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  >
                                    <option value="">--Select Target Field--</option>
                                    {fields.map((field) => (
                                      <option key={field.name} value={field.name}>
                                        {field.label} ({field.type})
                                      </option>
                                    ))}
                                  </select>
                                )}
                              </div>

                              <div className="form-group">
                                <label style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                  Transformation *
                                  <button
                                    type="button"
                                    onClick={() => setShowTransformationHelpModal(true)}
                                    style={{
                                      background: 'none',
                                      border: '1px solid #0284c7',
                                      borderRadius: '50%',
                                      width: '16px',
                                      height: '16px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      cursor: 'pointer',
                                      color: '#0284c7',
                                      fontSize: '10px',
                                      fontWeight: 'bold',
                                      padding: 0
                                    }}
                                    title="Click for help on transformation types"
                                  >
                                    ?
                                  </button>
                                </label>
                                <select
                                  value={mapping.transformation}
                                  onChange={async (e) => {
                                    const newTransformation = e.target.value;
                                    const updated = fieldMappings.map(m => {
                                      if (m.id === mapping.id) {
                                        const baseUpdate = { 
                                          ...m, 
                                          transformation: newTransformation
                                        };
                                        // Clear fields that don't apply to the new transformation
                                        if (newTransformation === 'formula' || newTransformation === 'concatenate' || newTransformation === 'valueMap' || newTransformation === 'conditional' || newTransformation === 'switch') {
                                          baseUpdate.sourceField = '';
                                        }
                                        // Initialize default values for new transformation types
                                        if (newTransformation === 'valueMap' && !m.valueMappings) {
                                          baseUpdate.valueMappings = [{ from: '', to: '' }];
                                        }
                                        if (newTransformation === 'conditional') {
                                          // Initialize for enhanced conditional (multiple conditions)
                                          if (!m.conditions || !Array.isArray(m.conditions) || m.conditions.length === 0) {
                                            baseUpdate.conditions = [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }];
                                          }
                                          // Keep legacy fields for backward compatibility
                                          if (!m.conditionField) {
                                            baseUpdate.conditionField = '';
                                            baseUpdate.conditionValue = '';
                                            baseUpdate.conditionOperator = 'equals';
                                            baseUpdate.thenValue = '';
                                            baseUpdate.elseValue = '';
                                          }
                                        }
                                        if (newTransformation === 'textReplace') {
                                          baseUpdate.findText = '';
                                          baseUpdate.replaceText = '';
                                          baseUpdate.replaceMode = 'all';
                                          baseUpdate.caseSensitive = false;
                                          baseUpdate.useRegex = false;
                                        }
                                        if (newTransformation === 'defaultValue') {
                                          baseUpdate.defaultValue = '';
                                          baseUpdate.applyWhen = 'empty';
                                        }
                                        if (newTransformation === 'typeConversion') {
                                          baseUpdate.targetType = 'string';
                                          baseUpdate.conversionFormat = '';
                                        }
                                        if (newTransformation === 'validateFormat') {
                                          baseUpdate.validationType = 'email';
                                          baseUpdate.customPattern = '';
                                          baseUpdate.onInvalid = 'default';
                                        }
                                        if (newTransformation === 'removeSpecialChars') {
                                          baseUpdate.removeMode = 'removeAll';
                                        }
                                        if (newTransformation === 'switch') {
                                          baseUpdate.cases = [{ value: '', targetValue: '' }];
                                          baseUpdate.switchDefaultValue = '';
                                        }
                                        // If switching to conditional and target field is already selected and it's a picklist, fetch picklist values
                                        if (newTransformation === 'conditional' && m.targetField) {
                                          const targetField = fields.find(f => f.name === m.targetField);
                                          if (targetField && targetField.type === 'picklist') {
                                            fetchTargetPicklistValues(mapping.id, m.targetField);
                                          }
                                        }
                                        return baseUpdate;
                                      }
                                      return m;
                                    });
                                    setFieldMappings(updated);
                                  }}
                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                >
                                  <option value="copy">Copy (Direct) - Copy value as-is</option>
                                  <option value="uppercase">Uppercase - Convert to uppercase</option>
                                  <option value="lowercase">Lowercase - Convert to lowercase</option>
                                  <option value="textReplace">Text Replace - Find and replace text</option>
                                  <option value="concatenate">Concatenate - Combine multiple fields</option>
                                  <option value="formula">Formula - Calculate using expression</option>
                                  <option value="dateFormat">Date Format - Format date value</option>
                                  <option value="numberFormat">Number Format - Format number value</option>
                                  <option value="valueMap">Value Map - Map specific values (e.g., "Yes" → true)</option>
                                  <option value="switch">Switch/Case - Map multiple values to different targets</option>
                                  <option value="conditional">Conditional - If-then-else logic (Enhanced)</option>
                                  <option value="defaultValue">Default Value - Use default if source is empty</option>
                                  <option value="typeConversion">Type Conversion - Convert data type</option>
                                  <option value="validateFormat">Format Validation - Validate format (email, phone, etc.)</option>
                                  <option value="removeSpecialChars">Remove Special Characters - Clean text</option>
                                  </select>
                              </div>

                              {mapping.transformation !== 'formula' && mapping.transformation !== 'concatenate' && mapping.transformation !== 'valueMap' && mapping.transformation !== 'conditional' && (
                                <div className="form-group">
                                  <label>Source Field *</label>
                                  {loadingFields ? (
                                    <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                  ) : (
                                    <select
                                      value={mapping.sourceField}
                                      onChange={(e) => {
                                        const updated = fieldMappings.map(m => 
                                          m.id === mapping.id ? { ...m, sourceField: e.target.value } : m
                                        );
                                        setFieldMappings(updated);
                                      }}
                                      disabled={!sourceObject || sourceFields.length === 0}
                                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                    >
                                      <option value="">--Select Source Field--</option>
                                      {sourceFields.map((field) => (
                                        <option key={field.name} value={field.name}>
                                          {field.label} ({field.type})
                                        </option>
                                      ))}
                                    </select>
                                  )}
                                </div>
                              )}

                              {mapping.transformation === 'concatenate' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Source Fields (Select multiple) *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '6px' }}>
                                    Select one or more source fields to combine into the target field.
                                  </div>
                                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', marginTop: '4px' }}>
                                    {sourceFields.length === 0 ? (
                                      <div style={{ fontSize: '12px', color: '#999', fontStyle: 'italic' }}>
                                        No source fields available. Please select a source object first.
                                      </div>
                                    ) : (
                                      sourceFields.map((field) => (
                                        <label key={field.name} style={{ 
                                          display: 'flex', 
                                          alignItems: 'center', 
                                          gap: '4px',
                                          fontSize: '12px',
                                          cursor: 'pointer',
                                          padding: '4px 8px',
                                          backgroundColor: mapping.concatenateFields.includes(field.name) ? '#dbeafe' : '#f3f4f6',
                                          borderRadius: '4px',
                                          border: `1px solid ${mapping.concatenateFields.includes(field.name) ? '#3b82f6' : '#e5e7eb'}`
                                        }}>
                                          <input
                                            type="checkbox"
                                            checked={mapping.concatenateFields.includes(field.name)}
                                            onChange={(e) => {
                                              const updated = fieldMappings.map(m => {
                                                if (m.id === mapping.id) {
                                                  const fields = [...(m.concatenateFields || [])];
                                                  if (e.target.checked) {
                                                    fields.push(field.name);
                                                  } else {
                                                    const index = fields.indexOf(field.name);
                                                    if (index > -1) fields.splice(index, 1);
                                                  }
                                                  return { ...m, concatenateFields: fields };
                                                }
                                                return m;
                                              });
                                              setFieldMappings(updated);
                                            }}
                                          />
                                          {field.label}
                                        </label>
                                      ))
                                    )}
                                  </div>
                                  {mapping.concatenateFields.length > 0 && (
                                    <div style={{ marginTop: '12px' }}>
                                      <label style={{ fontSize: '12px', display: 'block', marginBottom: '4px', fontWeight: '500' }}>
                                        Separator *
                                      </label>
                                      <input
                                        type="text"
                                        value={mapping.separator}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, separator: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Enter separator (e.g., space, comma, dash)"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', maxWidth: '300px' }}
                                      />
                                      <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                        Character(s) to insert between concatenated fields. Use a space " " for space, "," for comma, etc.
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}

                              {mapping.transformation === 'formula' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Formula *</label>
                                  <input
                                    type="text"
                                    value={mapping.formula}
                                    onChange={(e) => {
                                      const updated = fieldMappings.map(m => 
                                        m.id === mapping.id ? { ...m, formula: e.target.value } : m
                                      );
                                      setFieldMappings(updated);
                                    }}
                                    placeholder="e.g., {Field1} + ' ' + {Field2} or {Amount} * 1.1"
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  />
                                  <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                    Use {'{FieldName}'} to reference source fields. Supports basic math operations (+, -, *, /) and string concatenation with +.
                                    <br />
                                    Examples: {'{Amount}'} * 1.1, {'{FirstName}'} + ' ' + {'{LastName}'}, {'{Quantity}'} * {'{Price}'}
                                  </div>
                                </div>
                              )}

                              {mapping.transformation === 'dateFormat' && (
                                <div className="form-group">
                                  <label>Date Format *</label>
                                  <select
                                    value={mapping.dateFormat}
                                    onChange={(e) => {
                                      const updated = fieldMappings.map(m => 
                                        m.id === mapping.id ? { ...m, dateFormat: e.target.value } : m
                                      );
                                      setFieldMappings(updated);
                                    }}
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  >
                                    <option value="YYYY-MM-DD">YYYY-MM-DD (e.g., 2024-01-15)</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY (e.g., 01/15/2024)</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY (e.g., 15/01/2024)</option>
                                    <option value="YYYY/MM/DD">YYYY/MM/DD (e.g., 2024/01/15)</option>
                                    <option value="DD-MM-YYYY">DD-MM-YYYY (e.g., 15-01-2024)</option>
                                  </select>
                                  <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                    Select the date format to apply to the source date field value.
                                  </div>
                                </div>
                              )}

                              {mapping.transformation === 'numberFormat' && (
                                <div className="form-group">
                                  <label>Number Format *</label>
                                  <input
                                    type="text"
                                    value={mapping.numberFormat}
                                    onChange={(e) => {
                                      const updated = fieldMappings.map(m => 
                                        m.id === mapping.id ? { ...m, numberFormat: e.target.value } : m
                                      );
                                      setFieldMappings(updated);
                                    }}
                                    placeholder="e.g., 0.00, 0,000.00"
                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                  />
                                  <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                    Specify decimal places: "0.00" for 2 decimals, "0" for whole numbers. Use "0,000.00" for thousands separator.
                                  </div>
                                </div>
                              )}

                              {mapping.transformation === 'valueMap' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Value Mappings *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '8px' }}>
                                    Map source values to target values. If source value doesn't match any mapping, the original value is used.
                                  </div>
                                  {(mapping.valueMappings || [{ from: '', to: '' }]).map((valueMap, mapIndex) => (
                                    <div key={mapIndex} style={{ 
                                      display: 'flex', 
                                      gap: '8px', 
                                      marginBottom: '8px',
                                      alignItems: 'center'
                                    }}>
                                      <input
                                        type="text"
                                        value={valueMap.from}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => {
                                            if (m.id === mapping.id) {
                                              const newMappings = [...(m.valueMappings || [{ from: '', to: '' }])];
                                              newMappings[mapIndex] = { ...newMappings[mapIndex], from: e.target.value };
                                              return { ...m, valueMappings: newMappings };
                                            }
                                            return m;
                                          });
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Source value (e.g., Yes)"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                      />
                                      <span style={{ fontSize: '12px', color: '#666' }}>→</span>
                                      <input
                                        type="text"
                                        value={valueMap.to}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => {
                                            if (m.id === mapping.id) {
                                              const newMappings = [...(m.valueMappings || [{ from: '', to: '' }])];
                                              newMappings[mapIndex] = { ...newMappings[mapIndex], to: e.target.value };
                                              return { ...m, valueMappings: newMappings };
                                            }
                                            return m;
                                          });
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Target value (e.g., true)"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                      />
                                      {(mapping.valueMappings || []).length > 1 && (
                                        <button
                                          type="button"
                                          onClick={() => {
                                            const updated = fieldMappings.map(m => {
                                              if (m.id === mapping.id) {
                                                const newMappings = [...(m.valueMappings || [])];
                                                newMappings.splice(mapIndex, 1);
                                                return { ...m, valueMappings: newMappings.length > 0 ? newMappings : [{ from: '', to: '' }] };
                                              }
                                              return m;
                                            });
                                            setFieldMappings(updated);
                                          }}
                                          style={{
                                            padding: '4px 8px',
                                            fontSize: '11px',
                                            backgroundColor: '#fee2e2',
                                            color: '#dc2626',
                                            border: '1px solid #fecaca',
                                            borderRadius: '4px',
                                            cursor: 'pointer'
                                          }}
                                        >
                                          <X size={12} />
                                        </button>
                                      )}
                                    </div>
                                  ))}
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const updated = fieldMappings.map(m => {
                                        if (m.id === mapping.id) {
                                          return { 
                                            ...m, 
                                            valueMappings: [...(m.valueMappings || [{ from: '', to: '' }]), { from: '', to: '' }]
                                          };
                                        }
                                        return m;
                                      });
                                      setFieldMappings(updated);
                                    }}
                                    style={{
                                      padding: '6px 12px',
                                      fontSize: '12px',
                                      backgroundColor: '#f0f9ff',
                                      color: '#0284c7',
                                      border: '1px solid #bae6fd',
                                      borderRadius: '4px',
                                      cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '4px'
                                    }}
                                  >
                                    <Plus size={14} />
                                    Add Mapping
                                  </button>
                                </div>
                              )}

                              {mapping.transformation === 'conditional' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Conditional Logic * (Enhanced - Multiple Conditions)</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Set target field based on one or more conditions with AND/OR logic. If all/any conditions are met, set target to one value, otherwise set to another.
                                  </div>
                                  
                                  {/* Enhanced Multiple Conditions UI */}
                                  {(() => {
                                    const conditions = mapping.conditions && Array.isArray(mapping.conditions) && mapping.conditions.length > 0 
                                      ? mapping.conditions 
                                      : (mapping.conditionField ? [{ 
                                          id: Date.now(), 
                                          field: mapping.conditionField, 
                                          operator: mapping.conditionOperator || 'equals', 
                                          value: mapping.conditionValue || '', 
                                          logicalOperator: 'AND' 
                                        }] : [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }]);
                                    
                                    return (
                                      <div>
                                        {conditions.map((condition, condIndex) => (
                                          <div key={condition.id || condIndex} style={{ 
                                            border: '1px solid #e0e0e0', 
                                            borderRadius: '4px', 
                                            padding: '12px', 
                                            marginBottom: '12px',
                                            backgroundColor: '#fafafa',
                                            position: 'relative',
                                            zIndex: 1
                                          }}>
                                            {condIndex > 0 && (
                                              <div style={{ marginBottom: '8px' }}>
                                                <select
                                                  value={condition.logicalOperator || 'AND'}
                                                  onChange={(e) => {
                                                    const updated = fieldMappings.map(m => {
                                                      if (m.id === mapping.id) {
                                                        const newConditions = [...(m.conditions || conditions)];
                                                        newConditions[condIndex] = { ...newConditions[condIndex], logicalOperator: e.target.value };
                                                        return { ...m, conditions: newConditions };
                                                      }
                                                      return m;
                                                    });
                                                    setFieldMappings(updated);
                                                  }}
                                                  style={{ 
                                                    fontSize: '11px', 
                                                    padding: '4px 8px', 
                                                    height: '28px',
                                                    backgroundColor: '#08979C',
                                                    color: '#fff',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    fontWeight: 600
                                                  }}
                                                >
                                                  <option value="AND">AND</option>
                                                  <option value="OR">OR</option>
                                                </select>
                                              </div>
                                            )}
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', position: 'relative' }}>
                                              <div className="form-group" style={{ position: 'relative', zIndex: 1 }}>
                                                <label style={{ fontSize: '11px', marginBottom: '4px' }}>Condition Field *</label>
                                                {loadingFields ? (
                                                  <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                                ) : (
                                                  <select
                                                    value={condition.field || ''}
                                                    onChange={async (e) => {
                                                      const selectedFieldName = e.target.value;
                                                      const selectedField = sourceFields.find(f => f.name === selectedFieldName);
                                                      const updated = fieldMappings.map(m => {
                                                        if (m.id === mapping.id) {
                                                          const newConditions = [...(m.conditions || conditions)];
                                                          newConditions[condIndex] = { ...newConditions[condIndex], field: selectedFieldName, value: '' };
                                                          // If it's a picklist field, use its picklist values
                                                          if (selectedField && selectedField.type === 'picklist' && selectedField.picklistValues) {
                                                            setConditionPicklistValues(prev => ({
                                                              ...prev,
                                                              [`${mapping.id}-${condIndex}`]: selectedField.picklistValues || []
                                                            }));
                                                          } else if (selectedField && selectedField.type === 'picklist') {
                                                            // Fetch picklist values if not already loaded
                                                            fetchConditionPicklistValues(`${mapping.id}-${condIndex}`, selectedFieldName);
                                                          } else {
                                                            // Clear picklist values if not a picklist
                                                            setConditionPicklistValues(prev => {
                                                              const newState = { ...prev };
                                                              delete newState[`${mapping.id}-${condIndex}`];
                                                              return newState;
                                                            });
                                                          }
                                                          return { ...m, conditions: newConditions };
                                                        }
                                                        return m;
                                                      });
                                                      setFieldMappings(updated);
                                                    }}
                                                    disabled={!sourceObject || sourceFields.length === 0}
                                                    style={{ 
                                                      fontSize: '12px', 
                                                      padding: '6px 10px', 
                                                      height: '32px', 
                                                      width: '100%',
                                                      position: 'relative',
                                                      zIndex: 10,
                                                      backgroundColor: (!sourceObject || sourceFields.length === 0) ? '#f5f5f5' : '#fff',
                                                      cursor: (!sourceObject || sourceFields.length === 0) ? 'not-allowed' : 'pointer'
                                                    }}
                                                    onClick={(e) => {
                                                      // Ensure click events work properly
                                                      e.stopPropagation();
                                                    }}
                                                    onFocus={(e) => {
                                                      // Ensure focus works
                                                      e.stopPropagation();
                                                    }}
                                                  >
                                                    <option value="">--Select Field--</option>
                                                    {sourceFields.map((field) => (
                                                      <option key={field.name} value={field.name}>
                                                        {field.label} ({field.type})
                                                      </option>
                                                    ))}
                                                  </select>
                                                )}
                                              </div>

                                              <div className="form-group">
                                                <label style={{ fontSize: '11px', marginBottom: '4px' }}>Operator *</label>
                                                <select
                                                  value={condition.operator || 'equals'}
                                                  onChange={(e) => {
                                                    const updated = fieldMappings.map(m => {
                                                      if (m.id === mapping.id) {
                                                        const newConditions = [...(m.conditions || conditions)];
                                                        newConditions[condIndex] = { ...newConditions[condIndex], operator: e.target.value, value: ['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(e.target.value) ? '' : newConditions[condIndex].value };
                                                        return { ...m, conditions: newConditions };
                                                      }
                                                      return m;
                                                    });
                                                    setFieldMappings(updated);
                                                  }}
                                                  style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                >
                                                  <option value="equals">Equals (=)</option>
                                                  <option value="notEquals">Not Equals (≠)</option>
                                                  <option value="contains">Contains</option>
                                                  <option value="startsWith">Starts With</option>
                                                  <option value="endsWith">Ends With</option>
                                                  <option value="greaterThan">Greater Than (&gt;)</option>
                                                  <option value="lessThan">Less Than (&lt;)</option>
                                                  <option value="greaterThanOrEqual">Greater Than or Equal (≥)</option>
                                                  <option value="lessThanOrEqual">Less Than or Equal (≤)</option>
                                                  <option value="isEmpty">Is Empty</option>
                                                  <option value="isNotEmpty">Is Not Empty</option>
                                                  <option value="isNull">Is Null</option>
                                                  <option value="isNotNull">Is Not Null</option>
                                                </select>
                                              </div>

                                              <div className="form-group" style={{ position: 'relative' }}>
                                                <label style={{ fontSize: '11px', marginBottom: '4px' }}>
                                                  {['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(condition.operator) ? 'Value (N/A)' : 'Condition Value *'}
                                                </label>
                                                {['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'].includes(condition.operator) ? (
                                                  <input
                                                    type="text"
                                                    value=""
                                                    disabled
                                                    style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', backgroundColor: '#f5f5f5', color: '#999' }}
                                                  />
                                                ) : (() => {
                                                  const conditionField = sourceFields.find(f => f.name === condition.field);
                                                  const isPicklist = conditionField && conditionField.type === 'picklist';
                                                  const picklistValues = conditionPicklistValues[`${mapping.id}-${condIndex}`] || (conditionField && conditionField.picklistValues ? conditionField.picklistValues : []);
                                                  
                                                  if (isPicklist && picklistValues.length > 0) {
                                                    // Show dropdown for picklist
                                                    return (
                                                      <select
                                                        value={condition.value || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => {
                                                            if (m.id === mapping.id) {
                                                              const newConditions = [...(m.conditions || conditions)];
                                                              newConditions[condIndex] = { ...newConditions[condIndex], value: e.target.value };
                                                              return { ...m, conditions: newConditions };
                                                            }
                                                            return m;
                                                          });
                                                          setFieldMappings(updated);
                                                        }}
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      >
                                                        <option value="">--Select Value--</option>
                                                        {picklistValues.map((value) => (
                                                          <option key={value} value={value}>
                                                            {value}
                                                          </option>
                                                        ))}
                                                      </select>
                                                    );
                                                  } else {
                                                    // Show text input for non-picklist fields
                                                    return (
                                                      <input
                                                        type="text"
                                                        value={condition.value || ''}
                                                        onChange={(e) => {
                                                          const updated = fieldMappings.map(m => {
                                                            if (m.id === mapping.id) {
                                                              const newConditions = [...(m.conditions || conditions)];
                                                              newConditions[condIndex] = { ...newConditions[condIndex], value: e.target.value };
                                                              return { ...m, conditions: newConditions };
                                                            }
                                                            return m;
                                                          });
                                                          setFieldMappings(updated);
                                                        }}
                                                        placeholder="Value to compare"
                                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                                      />
                                                    );
                                                  }
                                                })()}
                                                {conditions.length > 1 && (
                                                  <button
                                                    type="button"
                                                    onClick={() => {
                                                      const updated = fieldMappings.map(m => {
                                                        if (m.id === mapping.id) {
                                                          const newConditions = [...(m.conditions || conditions)];
                                                          newConditions.splice(condIndex, 1);
                                                          return { ...m, conditions: newConditions.length > 0 ? newConditions : [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }] };
                                                        }
                                                        return m;
                                                      });
                                                      setFieldMappings(updated);
                                                    }}
                                                    style={{
                                                      position: 'absolute',
                                                      right: '4px',
                                                      top: '24px',
                                                      padding: '2px 6px',
                                                      fontSize: '10px',
                                                      backgroundColor: '#fee2e2',
                                                      color: '#dc2626',
                                                      border: '1px solid #fecaca',
                                                      borderRadius: '4px',
                                                      cursor: 'pointer'
                                                    }}
                                                  >
                                                    <X size={10} />
                                                  </button>
                                                )}
                                              </div>
                                            </div>
                                          </div>
                                        ))}
                                        <button
                                          type="button"
                                          onClick={() => {
                                            const updated = fieldMappings.map(m => {
                                              if (m.id === mapping.id) {
                                                const currentConditions = m.conditions && Array.isArray(m.conditions) && m.conditions.length > 0 
                                                  ? m.conditions 
                                                  : (m.conditionField ? [{ 
                                                      id: Date.now(), 
                                                      field: m.conditionField, 
                                                      operator: m.conditionOperator || 'equals', 
                                                      value: m.conditionValue || '', 
                                                      logicalOperator: 'AND' 
                                                    }] : [{ id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }]);
                                                return { 
                                                  ...m, 
                                                  conditions: [...currentConditions, { id: Date.now(), field: '', operator: 'equals', value: '', logicalOperator: 'AND' }]
                                                };
                                              }
                                              return m;
                                            });
                                            setFieldMappings(updated);
                                          }}
                                          style={{
                                            padding: '6px 12px',
                                            fontSize: '12px',
                                            backgroundColor: '#f0f9ff',
                                            color: '#0284c7',
                                            border: '1px solid #bae6fd',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px',
                                            marginBottom: '12px'
                                          }}
                                        >
                                          <Plus size={14} />
                                          Add Condition
                                        </button>
                                      </div>
                                    );
                                  })()}
                                  
                                  {/* Legacy single condition UI - kept for backward compatibility but hidden if conditions array exists */}
                                  {(!mapping.conditions || !Array.isArray(mapping.conditions) || mapping.conditions.length === 0) && mapping.conditionField && (
                                    <div>
                                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', marginBottom: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Condition Field *</label>
                                      {loadingFields ? (
                                        <div style={{ padding: '6px', fontSize: '12px', color: '#666' }}>Loading...</div>
                                      ) : (
                                        <select
                                          value={mapping.conditionField}
                                          onChange={async (e) => {
                                            const selectedFieldName = e.target.value;
                                            const selectedField = sourceFields.find(f => f.name === selectedFieldName);
                                            const updated = fieldMappings.map(m => {
                                              if (m.id === mapping.id) {
                                                const newMapping = { ...m, conditionField: selectedFieldName, conditionValue: '' };
                                                // Fetch picklist values if it's a picklist field
                                                if (selectedField && selectedField.type === 'picklist') {
                                                  fetchConditionPicklistValues(mapping.id, selectedFieldName);
                                                }
                                                return newMapping;
                                              }
                                              return m;
                                            });
                                            setFieldMappings(updated);
                                          }}
                                          disabled={!sourceObject || sourceFields.length === 0}
                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                        >
                                          <option value="">--Select Field--</option>
                                          {sourceFields.map((field) => (
                                            <option key={field.name} value={field.name}>
                                              {field.label} ({field.type})
                                            </option>
                                          ))}
                                        </select>
                                      )}
                                    </div>

                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Operator *</label>
                                      <select
                                        value={mapping.conditionOperator || 'equals'}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, conditionOperator: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      >
                                        <option value="equals">Equals (=)</option>
                                        <option value="notEquals">Not Equals (≠)</option>
                                        <option value="contains">Contains</option>
                                        <option value="greaterThan">Greater Than (&gt;)</option>
                                        <option value="lessThan">Less Than (&lt;)</option>
                                      </select>
                                    </div>

                                    <div className="form-group" style={{ position: 'relative' }}>
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Condition Value *</label>
                                      {(() => {
                                        const conditionField = sourceFields.find(f => f.name === mapping.conditionField);
                                        const isPicklist = conditionField && conditionField.type === 'picklist';
                                        const isReference = conditionField && conditionField.type === 'reference';
                                        const picklistValues = conditionPicklistValues[mapping.id] || [];
                                        const refSearch = conditionReferenceSearch[mapping.id] || { term: '', results: [], loading: false, show: false };

                                        if (isPicklist && picklistValues.length > 0) {
                                          // Show dropdown for picklist
                                          return (
                                            <select
                                              value={mapping.conditionValue || ''}
                                              onChange={(e) => {
                                                const updated = fieldMappings.map(m => 
                                                  m.id === mapping.id ? { ...m, conditionValue: e.target.value } : m
                                                );
                                                setFieldMappings(updated);
                                              }}
                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                            >
                                              <option value="">--Select Value--</option>
                                              {picklistValues.map((value) => (
                                                <option key={value} value={value}>
                                                  {value}
                                                </option>
                                              ))}
                                            </select>
                                          );
                                        } else if (isReference) {
                                          // Show search input for reference fields
                                          return (
                                            <div style={{ position: 'relative' }}>
                                              <input
                                                type="text"
                                                value={mapping.conditionValue || ''}
                                                onChange={(e) => {
                                                  const value = e.target.value;
                                                  const updated = fieldMappings.map(m => 
                                                    m.id === mapping.id ? { ...m, conditionValue: value } : m
                                                  );
                                                  setFieldMappings(updated);
                                                  
                                                  // Trigger search with debounce
                                                  handleConditionReferenceSearch(mapping.id, mapping.conditionField, value);
                                                }}
                                                onFocus={() => {
                                                  if (mapping.conditionValue) {
                                                    searchConditionReference(mapping.id, mapping.conditionField, mapping.conditionValue);
                                                  }
                                                }}
                                                placeholder="Search and select..."
                                                style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                              />
                                              {refSearch.show && refSearch.results.length > 0 && (
                                                <div style={{
                                                  position: 'absolute',
                                                  top: '100%',
                                                  left: 0,
                                                  right: 0,
                                                  backgroundColor: 'white',
                                                  border: '1px solid #ccc',
                                                  borderRadius: '4px',
                                                  maxHeight: '200px',
                                                  overflowY: 'auto',
                                                  zIndex: 1000,
                                                  boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                                  marginTop: '2px'
                                                }}>
                                                  {refSearch.loading && (
                                                    <div style={{ padding: '8px', textAlign: 'center', fontSize: '12px', color: '#666' }}>
                                                      <Loader size={14} style={{ animation: 'spin 1s linear infinite', display: 'inline-block' }} /> Searching...
                                                    </div>
                                                  )}
                                                  {refSearch.results.map((record) => (
                                                    <div
                                                      key={record.Id}
                                                      onClick={() => {
                                                        const updated = fieldMappings.map(m => 
                                                          m.id === mapping.id ? { ...m, conditionValue: record.Id } : m
                                                        );
                                                        setFieldMappings(updated);
                                                        setConditionReferenceSearch(prev => ({
                                                          ...prev,
                                                          [mapping.id]: { ...prev[mapping.id], show: false }
                                                        }));
                                                      }}
                                                      style={{
                                                        padding: '8px 12px',
                                                        cursor: 'pointer',
                                                        fontSize: '12px',
                                                        borderBottom: '1px solid #f0f0f0'
                                                      }}
                                                      onMouseEnter={(e) => e.target.style.backgroundColor = '#f0f9ff'}
                                                      onMouseLeave={(e) => e.target.style.backgroundColor = 'white'}
                                                    >
                                                      {record.Name || record.Id}
                                                    </div>
                                                  ))}
                                                </div>
                                              )}
                                            </div>
                                          );
                                        } else {
                                          // Regular text input
                                          return (
                                            <input
                                              type="text"
                                              value={mapping.conditionValue || ''}
                                              onChange={(e) => {
                                                const updated = fieldMappings.map(m => 
                                                  m.id === mapping.id ? { ...m, conditionValue: e.target.value } : m
                                                );
                                                setFieldMappings(updated);
                                              }}
                                              placeholder="Value to compare"
                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                            />
                                          );
                                        }
                                      })()}
                                    </div>
                                      </div>
                                    </div>
                                  )}

                                  {/* Then/Else Value sections - shared for both enhanced and legacy conditional */}
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginTop: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Then Value (if condition is true) *</label>
                                      {(() => {
                                        const targetField = fields.find(f => f.name === mapping.targetField);
                                        const isPicklist = targetField && targetField.type === 'picklist';
                                        const picklistValues = targetPicklistValues[mapping.id] || [];

                                        if (isPicklist && picklistValues.length > 0) {
                                          // Show dropdown for picklist
                                          return (
                                            <select
                                              value={mapping.thenValue || ''}
                                              onChange={(e) => {
                                                const updated = fieldMappings.map(m => 
                                                  m.id === mapping.id ? { ...m, thenValue: e.target.value } : m
                                                );
                                                setFieldMappings(updated);
                                              }}
                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                            >
                                              <option value="">--Select Value--</option>
                                              {picklistValues.map((value) => (
                                                <option key={value} value={value}>
                                                  {value}
                                                </option>
                                              ))}
                                            </select>
                                          );
                                        } else {
                                          // Regular text input
                                          return (
                                            <input
                                              type="text"
                                              value={mapping.thenValue || ''}
                                              onChange={(e) => {
                                                const updated = fieldMappings.map(m => 
                                                  m.id === mapping.id ? { ...m, thenValue: e.target.value } : m
                                                );
                                                setFieldMappings(updated);
                                              }}
                                              placeholder="Value if condition matches"
                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                            />
                                          );
                                        }
                                      })()}
                                    </div>

                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Else Value (if condition is false)</label>
                                      {(() => {
                                        const targetField = fields.find(f => f.name === mapping.targetField);
                                        const isPicklist = targetField && targetField.type === 'picklist';
                                        const picklistValues = targetPicklistValues[mapping.id] || [];

                                        if (isPicklist && picklistValues.length > 0) {
                                          // Show dropdown for picklist
                                          return (
                                            <select
                                              value={mapping.elseValue || ''}
                                              onChange={(e) => {
                                                const updated = fieldMappings.map(m => 
                                                  m.id === mapping.id ? { ...m, elseValue: e.target.value } : m
                                                );
                                                setFieldMappings(updated);
                                              }}
                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                            >
                                              <option value="">--Select Value (Optional)--</option>
                                              {picklistValues.map((value) => (
                                                <option key={value} value={value}>
                                                  {value}
                                                </option>
                                              ))}
                                            </select>
                                          );
                                        } else {
                                          // Regular text input
                                          return (
                                            <input
                                              type="text"
                                              value={mapping.elseValue || ''}
                                              onChange={(e) => {
                                                const updated = fieldMappings.map(m => 
                                                  m.id === mapping.id ? { ...m, elseValue: e.target.value } : m
                                                );
                                                setFieldMappings(updated);
                                              }}
                                              placeholder="Value if condition doesn't match (optional)"
                                              style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                            />
                                          );
                                        }
                                      })()}
                                      <div style={{ fontSize: '10px', color: '#999', marginTop: '2px' }}>
                                        If empty, target field will not be updated when condition is false
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Text Replace Transformation */}
                              {mapping.transformation === 'textReplace' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Text Replacement *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Find and replace text in the source field value.
                                  </div>
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Find Text *</label>
                                      <input
                                        type="text"
                                        value={mapping.findText || ''}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, findText: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Text to find"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      />
                                    </div>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Replace With</label>
                                      <input
                                        type="text"
                                        value={mapping.replaceText || ''}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, replaceText: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Replacement text"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      />
                                    </div>
                                  </div>
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Replace Mode</label>
                                      <select
                                        value={mapping.replaceMode || 'all'}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, replaceMode: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      >
                                        <option value="all">Replace All</option>
                                        <option value="first">Replace First</option>
                                        <option value="last">Replace Last</option>
                                      </select>
                                    </div>
                                    <div className="form-group" style={{ display: 'flex', alignItems: 'center', marginTop: '20px' }}>
                                      <input
                                        type="checkbox"
                                        checked={mapping.caseSensitive || false}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, caseSensitive: e.target.checked } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ marginRight: '6px' }}
                                      />
                                      <label style={{ fontSize: '11px', margin: 0 }}>Case Sensitive</label>
                                    </div>
                                    <div className="form-group" style={{ display: 'flex', alignItems: 'center', marginTop: '20px' }}>
                                      <input
                                        type="checkbox"
                                        checked={mapping.useRegex || false}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, useRegex: e.target.checked } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ marginRight: '6px' }}
                                      />
                                      <label style={{ fontSize: '11px', margin: 0 }}>Use Regex (Advanced)</label>
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Default Value Transformation */}
                              {mapping.transformation === 'defaultValue' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Default Value *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Use a default value when the source field is empty, null, or invalid.
                                  </div>
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Default Value *</label>
                                      <input
                                        type="text"
                                        value={mapping.defaultValue || ''}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, defaultValue: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Default value to use"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      />
                                    </div>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Apply When</label>
                                      <select
                                        value={mapping.applyWhen || 'empty'}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, applyWhen: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      >
                                        <option value="empty">Empty String</option>
                                        <option value="null">Null Value</option>
                                        <option value="emptyOrNull">Empty or Null</option>
                                        <option value="invalid">Invalid/Invalid Type</option>
                                      </select>
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Type Conversion Transformation */}
                              {mapping.transformation === 'typeConversion' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Type Conversion *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Convert the source field value to a different data type.
                                  </div>
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Target Type *</label>
                                      <select
                                        value={mapping.targetType || 'string'}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, targetType: e.target.value, conversionFormat: e.target.value === 'date' ? 'YYYY-MM-DD' : '' } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      >
                                        <option value="string">String</option>
                                        <option value="number">Number</option>
                                        <option value="boolean">Boolean</option>
                                        <option value="date">Date</option>
                                      </select>
                                    </div>
                                    {mapping.targetType === 'date' && (
                                      <div className="form-group">
                                        <label style={{ fontSize: '11px', marginBottom: '4px' }}>Date Format (Optional)</label>
                                        <input
                                          type="text"
                                          value={mapping.conversionFormat || 'YYYY-MM-DD'}
                                          onChange={(e) => {
                                            const updated = fieldMappings.map(m => 
                                              m.id === mapping.id ? { ...m, conversionFormat: e.target.value } : m
                                            );
                                            setFieldMappings(updated);
                                          }}
                                          placeholder="YYYY-MM-DD"
                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                        />
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}

                              {/* Format Validation Transformation */}
                              {mapping.transformation === 'validateFormat' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Format Validation *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Validate the source field value against a format pattern. If invalid, apply the specified action.
                                  </div>
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Validation Type *</label>
                                      <select
                                        value={mapping.validationType || 'email'}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, validationType: e.target.value, customPattern: e.target.value !== 'custom' ? '' : m.customPattern } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      >
                                        <option value="email">Email</option>
                                        <option value="phone">Phone Number</option>
                                        <option value="url">URL</option>
                                        <option value="postalCode">Postal Code</option>
                                        <option value="custom">Custom Regex</option>
                                      </select>
                                    </div>
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>On Invalid</label>
                                      <select
                                        value={mapping.onInvalid || 'default'}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, onInvalid: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      >
                                        <option value="default">Use Default Value</option>
                                        <option value="skip">Skip Update</option>
                                        <option value="error">Throw Error</option>
                                      </select>
                                    </div>
                                  </div>
                                  {mapping.validationType === 'custom' && (
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Custom Regex Pattern *</label>
                                      <input
                                        type="text"
                                        value={mapping.customPattern || ''}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, customPattern: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="e.g., ^[A-Z]{2}\\d{4}$"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      />
                                      <div style={{ fontSize: '10px', color: '#999', marginTop: '2px' }}>
                                        Enter a valid regular expression pattern
                                      </div>
                                    </div>
                                  )}
                                  {mapping.onInvalid === 'default' && (
                                    <div className="form-group">
                                      <label style={{ fontSize: '11px', marginBottom: '4px' }}>Default Value</label>
                                      <input
                                        type="text"
                                        value={mapping.defaultValue || ''}
                                        onChange={(e) => {
                                          const updated = fieldMappings.map(m => 
                                            m.id === mapping.id ? { ...m, defaultValue: e.target.value } : m
                                          );
                                          setFieldMappings(updated);
                                        }}
                                        placeholder="Default value if validation fails"
                                        style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                      />
                                    </div>
                                  )}
                                </div>
                              )}

                              {/* Remove Special Characters Transformation */}
                              {mapping.transformation === 'removeSpecialChars' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Remove Special Characters *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Clean the source field value by removing special characters based on the selected mode.
                                  </div>
                                  <div className="form-group">
                                    <label style={{ fontSize: '11px', marginBottom: '4px' }}>Remove Mode *</label>
                                    <select
                                      value={mapping.removeMode || 'removeAll'}
                                      onChange={(e) => {
                                        const updated = fieldMappings.map(m => 
                                          m.id === mapping.id ? { ...m, removeMode: e.target.value } : m
                                        );
                                        setFieldMappings(updated);
                                      }}
                                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                    >
                                      <option value="removeAll">Remove All Special Characters</option>
                                      <option value="keepOnlyNumbers">Keep Only Numbers</option>
                                      <option value="keepOnlyLetters">Keep Only Letters</option>
                                      <option value="keepOnlyAlphanumeric">Keep Only Letters and Numbers</option>
                                    </select>
                                  </div>
                                </div>
                              )}

                              {/* Switch/Case Transformation */}
                              {mapping.transformation === 'switch' && (
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                  <label>Switch/Case Mapping *</label>
                                  <div style={{ fontSize: '11px', color: '#666', marginBottom: '12px' }}>
                                    Map multiple source values to different target values. Similar to a switch/case statement.
                                  </div>
                                  <div style={{ marginBottom: '12px' }}>
                                    {(mapping.cases || [{ value: '', targetValue: '' }]).map((caseItem, caseIndex) => (
                                      <div key={caseIndex} style={{ display: 'flex', gap: '8px', marginBottom: '8px', alignItems: 'center' }}>
                                        <input
                                          type="text"
                                          value={caseItem.value}
                                          onChange={(e) => {
                                            const updated = fieldMappings.map(m => {
                                              if (m.id === mapping.id) {
                                                const newCases = [...(m.cases || [{ value: '', targetValue: '' }])];
                                                newCases[caseIndex] = { ...newCases[caseIndex], value: e.target.value };
                                                return { ...m, cases: newCases };
                                              }
                                              return m;
                                            });
                                            setFieldMappings(updated);
                                          }}
                                          placeholder="Source value"
                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                        />
                                        <span style={{ fontSize: '12px', color: '#666' }}>→</span>
                                        <input
                                          type="text"
                                          value={caseItem.targetValue}
                                          onChange={(e) => {
                                            const updated = fieldMappings.map(m => {
                                              if (m.id === mapping.id) {
                                                const newCases = [...(m.cases || [{ value: '', targetValue: '' }])];
                                                newCases[caseIndex] = { ...newCases[caseIndex], targetValue: e.target.value };
                                                return { ...m, cases: newCases };
                                              }
                                              return m;
                                            });
                                            setFieldMappings(updated);
                                          }}
                                          placeholder="Target value"
                                          style={{ fontSize: '12px', padding: '6px 10px', height: '32px', flex: 1 }}
                                        />
                                        {(mapping.cases || []).length > 1 && (
                                          <button
                                            type="button"
                                            onClick={() => {
                                              const updated = fieldMappings.map(m => {
                                                if (m.id === mapping.id) {
                                                  const newCases = [...(m.cases || [])];
                                                  newCases.splice(caseIndex, 1);
                                                  return { ...m, cases: newCases.length > 0 ? newCases : [{ value: '', targetValue: '' }] };
                                                }
                                                return m;
                                              });
                                              setFieldMappings(updated);
                                            }}
                                            style={{
                                              padding: '4px 8px',
                                              fontSize: '11px',
                                              backgroundColor: '#fee2e2',
                                              color: '#dc2626',
                                              border: '1px solid #fecaca',
                                              borderRadius: '4px',
                                              cursor: 'pointer'
                                            }}
                                          >
                                            <X size={12} />
                                          </button>
                                        )}
                                      </div>
                                    ))}
                                    <button
                                      type="button"
                                      onClick={() => {
                                        const updated = fieldMappings.map(m => {
                                          if (m.id === mapping.id) {
                                            return { 
                                              ...m, 
                                              cases: [...(m.cases || [{ value: '', targetValue: '' }]), { value: '', targetValue: '' }]
                                            };
                                          }
                                          return m;
                                        });
                                        setFieldMappings(updated);
                                      }}
                                      style={{
                                        padding: '6px 12px',
                                        fontSize: '12px',
                                        backgroundColor: '#f0f9ff',
                                        color: '#0284c7',
                                        border: '1px solid #bae6fd',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '4px'
                                      }}
                                    >
                                      <Plus size={14} />
                                      Add Case
                                    </button>
                                  </div>
                                  <div className="form-group">
                                    <label style={{ fontSize: '11px', marginBottom: '4px' }}>Default Value (if no case matches)</label>
                                    <input
                                      type="text"
                                      value={mapping.switchDefaultValue || ''}
                                      onChange={(e) => {
                                        const updated = fieldMappings.map(m => 
                                          m.id === mapping.id ? { ...m, switchDefaultValue: e.target.value } : m
                                        );
                                        setFieldMappings(updated);
                                      }}
                                      placeholder="Default value (optional)"
                                      style={{ fontSize: '12px', padding: '6px 10px', height: '32px', width: '100%', border: '1px solid #d1d5db', borderRadius: '4px', backgroundColor: '#fff' }}
                                    />
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        ))}

                        <button
                          type="button"
                          onClick={() => {
                            setFieldMappings([...fieldMappings, {
                              id: Date.now(),
                              targetField: '',
                              sourceField: '',
                              transformation: 'copy',
                              formula: '',
                              concatenateFields: [],
                              separator: ' ',
                              dateFormat: 'YYYY-MM-DD',
                              numberFormat: '0.00'
                            }]);
                          }}
                          style={{
                            padding: '8px 16px',
                            fontSize: '12px',
                            backgroundColor: '#f0f9ff',
                            color: '#0284c7',
                            border: '1px solid #bae6fd',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            marginTop: '12px'
                          }}
                        >
                          <Plus size={14} />
                          Add Another Mapping
                        </button>
                          </>
                        )}
                      </div>
                    )}

                  {selectedFieldInfo && updateModeType === 'single' && (
                    <div style={{ marginTop: '16px', padding: '12px', background: '#f0f9ff', borderRadius: '6px', fontSize: '12px' }}>
                      <strong>Field Information:</strong>
                      <ul style={{ margin: '8px 0 0 20px', padding: 0 }}>
                        <li>Type: {selectedFieldInfo.type}</li>
                        <li>Label: {selectedFieldInfo.label}</li>
                        <li>Required: {selectedFieldInfo.required ? 'Yes' : 'No'}</li>
                        {selectedFieldInfo.picklistValues && selectedFieldInfo.picklistValues.length > 0 && (
                          <li>Picklist Values: {selectedFieldInfo.picklistValues.length} available</li>
                        )}
                      </ul>
                    </div>
                  )}

                  <div className="setup-actions" style={{ marginTop: '24px', paddingTop: '12px', borderTop: '1px solid #e5e7eb', display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                    <button
                      type="button"
                      onClick={() => {
                        setSelectedObject('');
                        setSelectedField('');
                        setNewValue('');
                        setCurrentValue('');
                        setUpdateMode('all');
                        setFilters({
                          projectId: '',
                          projectObjectiveId: '',
                          status: '',
                          type: ''
                        });
                      }}
                      className="btn-secondary"
                      disabled={updating || loadingPreview}
                      style={{ padding: '6px 12px', fontSize: '12px' }}
                    >
                      Reset
                    </button>
                    {/* Phase 4 & 5: Enhanced Features Buttons */}
                    {updateModeType === 'mapping' && (
                      <>
                        <button
                          type="button"
                          onClick={() => setShowTemplateModal(true)}
                          className="btn-secondary"
                          style={{ padding: '6px 12px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}
                          title="Apply transformation template"
                        >
                          <Plus size={14} />
                          Templates
                        </button>
                        <button
                          type="button"
                          onClick={() => setShowSaveSetModal(true)}
                          className="btn-secondary"
                          disabled={fieldMappings.length === 0 || fieldMappings.every(m => !m.targetField)}
                          style={{ padding: '6px 12px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}
                          title="Save current transformation set"
                        >
                          <Save size={14} />
                          Save Set
                        </button>
                        {savedTransformationSets.length > 0 && (
                          <select
                            onChange={(e) => {
                              if (e.target.value) {
                                const setData = savedTransformationSets.find(s => s.id === parseInt(e.target.value));
                                if (setData) loadTransformationSet(setData);
                                e.target.value = '';
                              }
                            }}
                            style={{ padding: '6px 12px', fontSize: '12px', height: '32px', borderRadius: '4px', border: '1px solid #e0e0e0' }}
                            title="Load saved transformation set"
                          >
                            <option value="">Load Set...</option>
                            {savedTransformationSets.map(set => (
                              <option key={set.id} value={set.id}>{set.name}</option>
                            ))}
                          </select>
                        )}
                        <button
                          type="button"
                          onClick={undo}
                          disabled={historyIndex <= 0}
                          className="btn-secondary"
                          style={{ padding: '6px 12px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}
                          title="Undo"
                        >
                          <ArrowLeft size={14} />
                          Undo
                        </button>
                        <button
                          type="button"
                          onClick={redo}
                          disabled={historyIndex >= transformationHistory.length - 1}
                          className="btn-secondary"
                          style={{ padding: '6px 12px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}
                          title="Redo"
                        >
                          <ArrowRight size={14} />
                          Redo
                        </button>
                      </>
                    )}
                    {/* Batch Processing & Error Handling Settings */}
                    {updateModeType === 'mapping' && (
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        <label style={{ fontSize: '11px', color: '#666' }}>Batch Size:</label>
                        <input
                          type="number"
                          value={batchSize}
                          onChange={(e) => setBatchSize(Math.max(1, Math.min(1000, parseInt(e.target.value) || 200)))}
                          min="1"
                          max="1000"
                          style={{ width: '60px', padding: '4px 6px', fontSize: '11px', height: '24px', borderRadius: '4px', border: '1px solid #e0e0e0' }}
                        />
                        <label style={{ fontSize: '11px', color: '#666', marginLeft: '8px' }}>On Error:</label>
                        <select
                          value={errorHandlingMode}
                          onChange={(e) => setErrorHandlingMode(e.target.value)}
                          style={{ padding: '4px 6px', fontSize: '11px', height: '24px', borderRadius: '4px', border: '1px solid #e0e0e0' }}
                        >
                          <option value="default">Default</option>
                          <option value="skip">Skip</option>
                          <option value="continue">Continue</option>
                          <option value="stop">Stop</option>
                        </select>
                      </div>
                    )}
                    <button
                      type="button"
                      onClick={handlePreview}
                      className="btn-secondary"
                      disabled={loadingPreview || updating || !selectedObject || (
                        updateModeType === 'single' 
                          ? (!selectedField || !newValue || (updateMode === 'specific' && !currentValue))
                          : updateModeType === 'multiple'
                            ? multipleFieldUpdates.every(f => !f.fieldName || !f.newValue || (f.updateMode === 'specific' && !f.currentValue))
                            : !sourceObject || fieldMappings.every(m => {
                              if (!m.targetField) return true;
                              if (m.transformation === 'formula') return !m.formula;
                              if (m.transformation === 'concatenate') return !m.concatenateFields || m.concatenateFields.length === 0;
                              if (m.transformation === 'valueMap') return !m.valueMappings || m.valueMappings.length === 0 || !m.valueMappings.some(vm => vm.from && vm.to);
                              if (m.transformation === 'conditional') {
                                // Check for enhanced multiple conditions
                                if (m.conditions && Array.isArray(m.conditions) && m.conditions.length > 0) {
                                  // Enhanced: validate each condition
                                  const hasInvalidCondition = m.conditions.some(cond => {
                                    if (!cond.field) return true;
                                    // Operators that don't need a value
                                    const noValueOperators = ['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'];
                                    if (!noValueOperators.includes(cond.operator) && (!cond.value || cond.value === '')) return true;
                                    return false;
                                  });
                                  // Check if thenValue and elseValue are set
                                  if (hasInvalidCondition || m.thenValue === undefined || m.thenValue === '' || m.elseValue === undefined || m.elseValue === '') return true;
                                  return false;
                                }
                                // Legacy single condition
                                return !m.conditionField || m.conditionValue === undefined || m.conditionValue === '' || m.thenValue === undefined || m.thenValue === '';
                              }
                              if (m.transformation === 'switch') {
                                return !m.cases || m.cases.length === 0 || !m.cases.some(c => c.value && c.targetValue);
                              }
                              if (m.transformation === 'textReplace') {
                                return !m.findText || m.findText === '';
                              }
                              if (m.transformation === 'defaultValue') {
                                return m.defaultValue === undefined || m.defaultValue === '';
                              }
                              if (m.transformation === 'typeConversion') {
                                return !m.targetType;
                              }
                              if (m.transformation === 'validateFormat') {
                                return !m.validationType;
                              }
                              // Transformations that don't require sourceField
                              if (['formula', 'defaultValue', 'removeSpecialChars'].includes(m.transformation)) {
                                return false; // These are valid without sourceField
                              }
                              return !m.sourceField;
                            })
                      )}
                      style={{ padding: '6px 12px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                      {loadingPreview ? (
                        <>
                          <Loader size={14} style={{ animation: 'spin 1s linear infinite' }} />
                          Previewing...
                        </>
                      ) : (
                        <>
                          <Eye size={14} />
                          Preview
                        </>
                      )}
                    </button>
                    <button
                      type="button"
                      onClick={handleUpdate}
                      className="btn-primary"
                      disabled={updating || loadingPreview || !selectedObject || (
                        updateModeType === 'single' 
                          ? (!selectedField || !newValue || (updateMode === 'specific' && !currentValue))
                          : updateModeType === 'multiple'
                            ? multipleFieldUpdates.every(f => !f.fieldName || !f.newValue || (f.updateMode === 'specific' && !f.currentValue))
                            : !sourceObject || fieldMappings.every(m => {
                              if (!m.targetField) return true;
                              if (m.transformation === 'formula') return !m.formula;
                              if (m.transformation === 'concatenate') return !m.concatenateFields || m.concatenateFields.length === 0;
                              if (m.transformation === 'valueMap') return !m.valueMappings || m.valueMappings.length === 0 || !m.valueMappings.some(vm => vm.from && vm.to);
                              if (m.transformation === 'conditional') {
                                // Check for enhanced multiple conditions
                                if (m.conditions && Array.isArray(m.conditions) && m.conditions.length > 0) {
                                  // Enhanced: validate each condition
                                  const hasInvalidCondition = m.conditions.some(cond => {
                                    if (!cond.field) return true;
                                    // Operators that don't need a value
                                    const noValueOperators = ['isEmpty', 'isNotEmpty', 'isNull', 'isNotNull'];
                                    if (!noValueOperators.includes(cond.operator) && (!cond.value || cond.value === '')) return true;
                                    return false;
                                  });
                                  // Check if thenValue and elseValue are set
                                  if (hasInvalidCondition || m.thenValue === undefined || m.thenValue === '' || m.elseValue === undefined || m.elseValue === '') return true;
                                  return false;
                                }
                                // Legacy single condition
                                return !m.conditionField || m.conditionValue === undefined || m.conditionValue === '' || m.thenValue === undefined || m.thenValue === '';
                              }
                              if (m.transformation === 'switch') {
                                return !m.cases || m.cases.length === 0 || !m.cases.some(c => c.value && c.targetValue);
                              }
                              if (m.transformation === 'textReplace') {
                                return !m.findText || m.findText === '';
                              }
                              if (m.transformation === 'defaultValue') {
                                return m.defaultValue === undefined || m.defaultValue === '';
                              }
                              if (m.transformation === 'typeConversion') {
                                return !m.targetType;
                              }
                              if (m.transformation === 'validateFormat') {
                                return !m.validationType;
                              }
                              // Transformations that don't require sourceField
                              if (['formula', 'defaultValue', 'removeSpecialChars'].includes(m.transformation)) {
                                return false; // These are valid without sourceField
                              }
                              return !m.sourceField;
                            })
                      )}
                      style={{ padding: '6px 12px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}
                    >
                      {updating ? (
                        <>
                          <RefreshCw size={14} style={{ animation: 'spin 1s linear infinite' }} />
                          Updating...
                        </>
                      ) : (
                        <>
                          <Send size={14} />
                          Update Records
                        </>
                      )}
                    </button>
                  </div>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </div>

      {/* Field Mapping Help Modal */}
      {showFieldMappingHelpModal && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px',
            boxSizing: 'border-box'
          }}
          onClick={() => setShowFieldMappingHelpModal(false)}
        >
          <div 
            style={{
              backgroundColor: '#ffffff',
              borderRadius: '8px',
              width: '90%',
              maxWidth: '600px',
              display: 'flex',
              flexDirection: 'column',
              boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
              boxSizing: 'border-box',
              color: '#002329',
              fontFamily: 'Poppins',
              fontSize: '14px'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '16px 20px',
                borderBottom: '1px solid #e5e7eb'
              }}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <Info size={20} color="#0284c7" />
                <h2 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#002329' }}>
                  Field Mappings Help
                </h2>
              </div>
              <button
                onClick={() => setShowFieldMappingHelpModal(false)}
                style={{
                  background: 'transparent',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '4px',
                  display: 'flex',
                  alignItems: 'center',
                  color: '#666',
                  borderRadius: '4px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = 'rgba(0, 0, 0, 0.04)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                }}
              >
                <X size={18} />
              </button>
            </div>

            {/* Modal Body */}
            <div
              style={{
                padding: '20px',
                overflowY: 'auto',
                maxHeight: '60vh'
              }}
            >
              <div style={{ 
                lineHeight: '1.6',
                color: '#002329',
                fontSize: '13px'
              }}>
                <p style={{ marginTop: 0, marginBottom: '12px' }}>
                  <strong>Field Mappings:</strong> Define how fields from the source object are mapped to fields in the target object.
                </p>
                <p style={{ marginTop: 0, marginBottom: '12px' }}>
                  Each mapping can use different transformations to transform the data during the mapping process:
                </p>
                <ul style={{ marginTop: '8px', marginBottom: '12px', paddingLeft: '20px' }}>
                  <li><strong>Copy:</strong> Directly copy the source field value</li>
                  <li><strong>Formula:</strong> Calculate a value using expressions</li>
                  <li><strong>Concatenate:</strong> Combine multiple source fields</li>
                  <li><strong>Value Map:</strong> Map specific values (e.g., "Yes" → true)</li>
                  <li><strong>Conditional:</strong> Apply if-then-else logic</li>
                  <li><strong>Switch/Case:</strong> Map multiple values to different targets</li>
                  <li>And more transformation types...</li>
                </ul>
                <p style={{ marginTop: '12px', marginBottom: 0, fontSize: '12px', color: '#666' }}>
                  <strong>Note:</strong> You do not need to enter manual field update details when using this mode - the system automatically copies and transforms values from source records to target records based on your mappings.
                </p>
              </div>
            </div>

            {/* Modal Footer */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'flex-end',
                padding: '16px 20px',
                borderTop: '1px solid #e5e7eb'
              }}
            >
              <button
                onClick={() => setShowFieldMappingHelpModal(false)}
                style={{
                  padding: '8px 16px',
                  fontSize: '13px',
                  fontWeight: '500',
                  color: '#fff',
                  backgroundColor: '#0284c7',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#0369a1';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#0284c7';
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Confirmation Modal */}
      {showConfirmModal && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
            padding: '20px',
            boxSizing: 'border-box'
          }}
          onClick={() => {
            if (confirmModalData.onCancel) confirmModalData.onCancel();
          }}
        >
          <div 
            style={{
              backgroundColor: '#ffffff',
              borderRadius: '8px',
              width: '90%',
              maxWidth: '500px',
              display: 'flex',
              flexDirection: 'column',
              boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
              boxSizing: 'border-box',
              color: '#002329',
              fontFamily: 'Poppins',
              fontSize: '14px'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '20px',
                borderBottom: '1px solid #e5e7eb'
              }}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <AlertTriangle size={20} color="#f59e0b" />
                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#002329' }}>
                  Confirm Update
                </h2>
              </div>
              <button
                onClick={() => {
                  if (confirmModalData.onCancel) confirmModalData.onCancel();
                }}
                style={{
                  background: 'transparent',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '4px',
                  display: 'flex',
                  alignItems: 'center',
                  color: '#666',
                  borderRadius: '4px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = 'rgba(0, 0, 0, 0.04)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                }}
              >
                <X size={20} />
              </button>
            </div>

            {/* Modal Body */}
            <div
              style={{
                padding: '20px',
                overflowY: 'auto',
                maxHeight: '60vh'
              }}
            >
              <div style={{ 
                whiteSpace: 'pre-line',
                lineHeight: '1.6',
                color: '#002329'
              }}>
                {confirmModalData.message}
              </div>
            </div>

            {/* Modal Footer */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'flex-end',
                gap: '12px',
                padding: '20px',
                borderTop: '1px solid #e5e7eb'
              }}
            >
              <button
                onClick={() => {
                  if (confirmModalData.onCancel) confirmModalData.onCancel();
                }}
                style={{
                  padding: '8px 16px',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#002329',
                  backgroundColor: '#f3f4f6',
                  border: '1px solid #e5e7eb',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#e5e7eb';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#f3f4f6';
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  if (confirmModalData.onConfirm) confirmModalData.onConfirm();
                }}
                style={{
                  padding: '8px 16px',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#ffffff',
                  backgroundColor: '#08979C',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#067a7f';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#08979C';
                }}
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Preview Modal */}
      {showPreviewModal && previewData && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10001,
            padding: '20px',
            boxSizing: 'border-box'
          }}
          onClick={() => setShowPreviewModal(false)}
        >
          <div 
            style={{
              backgroundColor: '#ffffff',
              borderRadius: '8px',
              width: '90%',
              maxWidth: '900px',
              maxHeight: '90vh',
              display: 'flex',
              flexDirection: 'column',
              boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
              boxSizing: 'border-box',
              color: '#002329',
              fontFamily: 'Poppins',
              fontSize: '14px'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '20px',
                borderBottom: '1px solid #e5e7eb'
              }}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <Eye size={20} color="#08979C" />
                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#002329' }}>
                  Preview Update (Dry-Run)
                </h2>
              </div>
              <button
                onClick={() => setShowPreviewModal(false)}
                style={{
                  background: 'transparent',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '4px',
                  display: 'flex',
                  alignItems: 'center',
                  color: '#666',
                  borderRadius: '4px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = 'rgba(0, 0, 0, 0.04)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                }}
              >
                <X size={20} />
              </button>
            </div>

            {/* Modal Body */}
            <div
              style={{
                padding: '20px',
                overflowY: 'auto',
                flex: 1
              }}
            >
              {/* Summary Section */}
              <div style={{ marginBottom: '24px', padding: '16px', backgroundColor: '#f0f9ff', borderRadius: '6px' }}>
                <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#002329' }}>
                  Update Summary
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '13px' }}>
                  <div>
                    <span style={{ color: '#666' }}>Object Type:</span>
                    <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.objectType}</span>
                  </div>
                  <div>
                    <span style={{ color: '#666' }}>Total Records:</span>
                    <span style={{ marginLeft: '8px', fontWeight: '500', color: '#08979C' }}>{previewData.totalCount}</span>
                  </div>
                  {previewData.type === 'single' ? (
                    <>
                      <div>
                        <span style={{ color: '#666' }}>Field:</span>
                        <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.fieldLabel}</span>
                      </div>
                      <div>
                        <span style={{ color: '#666' }}>Sample Records:</span>
                        <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.sampleCount} of {previewData.totalCount}</span>
                      </div>
                    </>
                  ) : previewData.type === 'mapping' ? (
                    <>
                      <div>
                        <span style={{ color: '#666' }}>Source Object:</span>
                        <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.sourceObject}</span>
                      </div>
                      <div>
                        <span style={{ color: '#666' }}>Target Object:</span>
                        <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.targetObject}</span>
                      </div>
                      <div style={{ gridColumn: '1 / -1' }}>
                        <span style={{ color: '#666' }}>Field Mappings:</span>
                        <div style={{ marginTop: '4px' }}>
                          {previewData.mappings && previewData.mappings.map((mapping, idx) => (
                            <span key={idx} style={{ 
                              display: 'inline-block', 
                              marginRight: '8px', 
                              marginBottom: '4px',
                              padding: '4px 8px', 
                              backgroundColor: '#e0f2fe', 
                              borderRadius: '4px',
                              fontSize: '12px',
                              fontWeight: '500'
                            }}>
                              {mapping.targetField} ← {mapping.sourceField} ({mapping.transformation})
                            </span>
                          ))}
                        </div>
                      </div>
                      <div>
                        <span style={{ color: '#666' }}>Sample Records:</span>
                        <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.sampleCount} of {previewData.totalCount}</span>
                      </div>
                    </>
                  ) : (
                    <>
                      <div style={{ gridColumn: '1 / -1' }}>
                        <span style={{ color: '#666' }}>Fields to Update:</span>
                        <div style={{ marginTop: '4px' }}>
                          {previewData.fields.map((field, idx) => (
                            <span key={idx} style={{ 
                              display: 'inline-block', 
                              marginRight: '8px', 
                              marginBottom: '4px',
                              padding: '4px 8px', 
                              backgroundColor: '#e0f2fe', 
                              borderRadius: '4px',
                              fontSize: '12px',
                              fontWeight: '500'
                            }}>
                              {field.fieldLabel}
                            </span>
                          ))}
                        </div>
                      </div>
                      <div>
                        <span style={{ color: '#666' }}>Sample Records:</span>
                        <span style={{ marginLeft: '8px', fontWeight: '500' }}>{previewData.sampleCount} of {previewData.totalCount}</span>
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* Records Preview */}
              {previewData.records && previewData.records.length > 0 ? (
                <div>
                  <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#002329' }}>
                    Sample Records (Before → After)
                  </div>
                  <div style={{ 
                    border: '1px solid #e5e7eb', 
                    borderRadius: '6px', 
                    overflow: 'hidden',
                    maxHeight: '500px',
                    overflowY: 'auto'
                  }}>
                    {previewData.type === 'single' ? (
                      // Single field - use table layout with counts
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                        <thead>
                          <tr style={{ backgroundColor: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>
                            <th style={{ padding: '10px', textAlign: 'left', fontWeight: '600', color: '#002329' }}>Record Name (Sample)</th>
                            <th style={{ padding: '10px', textAlign: 'left', fontWeight: '600', color: '#002329' }}>Current Value</th>
                            <th style={{ padding: '10px', textAlign: 'left', fontWeight: '600', color: '#002329' }}>New Value</th>
                            <th style={{ padding: '10px', textAlign: 'center', fontWeight: '600', color: '#002329' }}>Records Count</th>
                          </tr>
                        </thead>
                        <tbody>
                          {previewData.records.map((record, recordIdx) => (
                            <tr key={record.id || recordIdx} style={{ borderBottom: '1px solid #f3f4f6' }}>
                              <td style={{ padding: '10px', fontWeight: '500', color: '#002329' }}>
                                {record.name}
                              </td>
                              <td style={{ padding: '10px', color: '#666' }}>
                                <span style={{ 
                                  padding: '4px 8px', 
                                  backgroundColor: '#fee2e2', 
                                  borderRadius: '4px',
                                  fontSize: '11px'
                                }}>
                                  {record.currentValue}
                                </span>
                              </td>
                              <td style={{ padding: '10px' }}>
                                <span style={{ 
                                  padding: '4px 8px', 
                                  backgroundColor: '#d1fae5', 
                                  borderRadius: '4px',
                                  fontSize: '11px',
                                  fontWeight: '500',
                                  color: '#065f46'
                                }}>
                                  {record.newValue}
                                </span>
                              </td>
                              <td style={{ padding: '10px', textAlign: 'center' }}>
                                <span style={{ 
                                  padding: '4px 8px', 
                                  backgroundColor: '#e0f2fe', 
                                  borderRadius: '4px',
                                  fontSize: '11px',
                                  fontWeight: '600',
                                  color: '#08979C'
                                }}>
                                  {record.recordCount || 1}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    ) : previewData.type === 'mapping' ? (
                      // Field mapping - use vertical card layout (similar to multiple fields)
                      <div style={{ padding: '12px' }}>
                        {previewData.records.map((record, recordIdx) => (
                          <div 
                            key={record.id || recordIdx} 
                            style={{ 
                              marginBottom: recordIdx < previewData.records.length - 1 ? '16px' : '0',
                              padding: '12px',
                              backgroundColor: '#fafafa',
                              borderRadius: '6px',
                              border: '1px solid #e5e7eb'
                            }}
                          >
                            <div style={{ 
                              fontSize: '13px', 
                              fontWeight: '600', 
                              marginBottom: '12px', 
                              color: '#002329',
                              paddingBottom: '8px',
                              borderBottom: '1px solid #e5e7eb'
                            }}>
                              {record.name} <span style={{ fontSize: '11px', fontWeight: '400', color: '#666' }}>(Sample)</span>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                              {previewData.mappings && previewData.mappings.map((mapping, fieldIdx) => (
                                <div key={fieldIdx} style={{ 
                                  display: 'flex', 
                                  flexDirection: 'column', 
                                  gap: '6px',
                                  padding: '8px',
                                  backgroundColor: '#ffffff',
                                  borderRadius: '4px',
                                  border: '1px solid #f3f4f6'
                                }}>
                                  <div style={{ 
                                    fontSize: '12px', 
                                    fontWeight: '500', 
                                    color: '#002329',
                                    marginBottom: '4px'
                                  }}>
                                    {mapping.targetField} ← {mapping.sourceField} ({mapping.transformation})
                                  </div>
                                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                    <div style={{ flex: 1 }}>
                                      <div style={{ fontSize: '11px', color: '#666', marginBottom: '4px' }}>Current:</div>
                                      <span style={{ 
                                        padding: '4px 8px', 
                                        backgroundColor: '#fee2e2', 
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        display: 'inline-block'
                                      }}>
                                        {record.fields[mapping.targetField]?.currentValue || '--None--'}
                                      </span>
                                    </div>
                                    <div style={{ fontSize: '16px', color: '#08979C', fontWeight: '600' }}>→</div>
                                    <div style={{ flex: 1 }}>
                                      <div style={{ fontSize: '11px', color: '#666', marginBottom: '4px' }}>New:</div>
                                      <span style={{ 
                                        padding: '4px 8px', 
                                        backgroundColor: '#d1fae5', 
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        fontWeight: '500',
                                        color: '#065f46',
                                        display: 'inline-block'
                                      }}>
                                        {record.fields[mapping.targetField]?.newValue || '--None--'}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      // Multiple fields - use vertical card layout with counts
                      <div style={{ padding: '12px' }}>
                        {previewData.records.map((record, recordIdx) => (
                          <div 
                            key={record.id || recordIdx} 
                            style={{ 
                              marginBottom: recordIdx < previewData.records.length - 1 ? '16px' : '0',
                              padding: '12px',
                              backgroundColor: '#fafafa',
                              borderRadius: '6px',
                              border: '1px solid #e5e7eb'
                            }}
                          >
                            <div style={{ 
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center',
                              marginBottom: '12px', 
                              paddingBottom: '8px',
                              borderBottom: '1px solid #e5e7eb'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: '600', 
                                color: '#002329'
                              }}>
                                {record.name} <span style={{ fontSize: '11px', fontWeight: '400', color: '#666' }}>(Sample)</span>
                              </div>
                              <div>
                                <span style={{ 
                                  padding: '4px 10px', 
                                  backgroundColor: '#e0f2fe', 
                                  borderRadius: '4px',
                                  fontSize: '11px',
                                  fontWeight: '600',
                                  color: '#08979C'
                                }}>
                                  {record.recordCount || 1} record{record.recordCount !== 1 ? 's' : ''}
                                </span>
                              </div>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                              {previewData.fields.map((field, fieldIdx) => (
                                <div key={fieldIdx} style={{ 
                                  display: 'flex', 
                                  flexDirection: 'column', 
                                  gap: '6px',
                                  padding: '8px',
                                  backgroundColor: '#ffffff',
                                  borderRadius: '4px',
                                  border: '1px solid #f3f4f6'
                                }}>
                                  <div style={{ 
                                    fontSize: '12px', 
                                    fontWeight: '500', 
                                    color: '#002329',
                                    marginBottom: '4px'
                                  }}>
                                    {field.fieldLabel}
                                  </div>
                                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                    <div style={{ flex: 1 }}>
                                      <div style={{ fontSize: '11px', color: '#666', marginBottom: '4px' }}>Current:</div>
                                      <span style={{ 
                                        padding: '4px 8px', 
                                        backgroundColor: '#fee2e2', 
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        display: 'inline-block'
                                      }}>
                                        {record.fields[field.fieldName]?.currentValue || '--None--'}
                                      </span>
                                    </div>
                                    <div style={{ fontSize: '16px', color: '#08979C', fontWeight: '600' }}>→</div>
                                    <div style={{ flex: 1 }}>
                                      <div style={{ fontSize: '11px', color: '#666', marginBottom: '4px' }}>New:</div>
                                      <span style={{ 
                                        padding: '4px 8px', 
                                        backgroundColor: '#d1fae5', 
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        fontWeight: '500',
                                        color: '#065f46',
                                        display: 'inline-block'
                                      }}>
                                        {record.fields[field.fieldName]?.newValue || '--None--'}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  {previewData.totalCount > previewData.sampleCount && (
                    <div style={{ marginTop: '12px', fontSize: '12px', color: '#666', fontStyle: 'italic' }}>
                      {previewData.isApproximate ? (
                        <>
                          Showing grouped samples from {previewData.sampleCount} of {previewData.totalCount} records. 
                          Counts shown are approximate based on the sample. All {previewData.totalCount} records will be updated.
                        </>
                      ) : (
                        <>
                          Showing grouped samples. All {previewData.totalCount} records will be updated.
                        </>
                      )}
                    </div>
                  )}
                  {previewData.totalCount <= previewData.sampleCount && previewData.totalCount > 0 && (
                    <div style={{ marginTop: '12px', fontSize: '12px', color: '#666', fontStyle: 'italic' }}>
                      Showing all {previewData.totalCount} records grouped by current value(s).
                    </div>
                  )}
                </div>
              ) : (
                <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>
                  <div style={{ fontSize: '14px', marginBottom: '8px' }}>No records found matching the criteria</div>
                  <div style={{ fontSize: '12px' }}>Please adjust your filters or update mode</div>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div
              style={{
                display: 'flex',
                justifyContent: 'flex-end',
                gap: '12px',
                padding: '20px',
                borderTop: '1px solid #e5e7eb'
              }}
            >
              <button
                onClick={() => setShowPreviewModal(false)}
                style={{
                  padding: '8px 16px',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#002329',
                  backgroundColor: '#f3f4f6',
                  border: '1px solid #e5e7eb',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#e5e7eb';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#f3f4f6';
                }}
              >
                Close
              </button>
              <button
                onClick={() => {
                  setShowPreviewModal(false);
                  handleUpdate();
                }}
                style={{
                  padding: '8px 16px',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#ffffff',
                  backgroundColor: '#08979C',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 0.2s',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#067a7f';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#08979C';
                }}
                disabled={updating}
              >
                <Send size={14} />
                Proceed with Update
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Template Modal */}
      {showTemplateModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }}>
          <div style={{
            backgroundColor: '#fff',
            padding: '24px',
            borderRadius: '8px',
            width: '90%',
            maxWidth: '600px',
            maxHeight: '80vh',
            overflow: 'auto'
          }}>
            <h2 style={{ marginBottom: '16px', fontSize: '18px', fontWeight: 600 }}>Transformation Templates</h2>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              {transformationTemplates.map(template => (
                <div key={template.id} style={{
                  padding: '12px',
                  border: '1px solid #e0e0e0',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f5f5f5'}
                onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#fff'}
                onClick={() => applyTemplate(template)}>
                  <div style={{ fontWeight: 600, marginBottom: '4px' }}>{template.name}</div>
                  <div style={{ fontSize: '12px', color: '#666' }}>{template.description}</div>
                </div>
              ))}
            </div>
            <button
              onClick={() => setShowTemplateModal(false)}
              style={{
                marginTop: '16px',
                padding: '8px 16px',
                backgroundColor: '#f5f5f5',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer'
              }}
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Save Set Modal */}
      {showSaveSetModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }}>
          <div style={{
            backgroundColor: '#fff',
            padding: '24px',
            borderRadius: '8px',
            width: '90%',
            maxWidth: '400px'
          }}>
            <h2 style={{ marginBottom: '16px', fontSize: '18px', fontWeight: 600 }}>Save Transformation Set</h2>
            <input
              type="text"
              value={savedSetName}
              onChange={(e) => setSavedSetName(e.target.value)}
              placeholder="Enter set name"
              style={{
                width: '100%',
                padding: '8px',
                border: '1px solid #e0e0e0',
                borderRadius: '4px',
                marginBottom: '16px'
              }}
              onKeyPress={(e) => {
                if (e.key === 'Enter') {
                  saveTransformationSet();
                }
              }}
            />
            <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
              <button
                onClick={() => {
                  setShowSaveSetModal(false);
                  setSavedSetName('');
                }}
                style={{
                  padding: '8px 16px',
                  backgroundColor: '#f5f5f5',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer'
                }}
              >
                Cancel
              </button>
              <button
                onClick={saveTransformationSet}
                style={{
                  padding: '8px 16px',
                  backgroundColor: '#08979C',
                  color: '#fff',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer'
                }}
              >
                Save
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Load Set Modal */}
      {showLoadSetModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }}>
          <div style={{
            backgroundColor: '#fff',
            padding: '24px',
            borderRadius: '8px',
            width: '90%',
            maxWidth: '600px',
            maxHeight: '80vh',
            overflow: 'auto'
          }}>
            <h2 style={{ 
              marginBottom: '20px', 
              fontSize: '18px', 
              fontWeight: 600,
              color: '#002329',
              fontFamily: 'Poppins'
            }}>
              Load Transformation Set
            </h2>
            
            {savedTransformationSets.length === 0 ? (
              <div style={{
                padding: '40px',
                textAlign: 'center',
                color: '#666',
                fontSize: '14px',
                fontFamily: 'Poppins'
              }}>
                No saved transformation sets found.
              </div>
            ) : (
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '12px',
                marginBottom: '20px'
              }}>
                {savedTransformationSets.map(set => (
                  <div
                    key={set.id}
                    onClick={() => {
                      loadTransformationSet(set.id);
                      setShowLoadSetModal(false);
                    }}
                    style={{
                      padding: '16px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '6px',
                      backgroundColor: '#f9fafb',
                      cursor: 'pointer',
                      transition: 'all 0.2s',
                      fontFamily: 'Poppins'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#f3f4f6';
                      e.currentTarget.style.borderColor = '#08979C';
                      e.currentTarget.style.boxShadow = '0 2px 4px rgba(8, 151, 156, 0.1)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = '#f9fafb';
                      e.currentTarget.style.borderColor = '#e5e7eb';
                      e.currentTarget.style.boxShadow = 'none';
                    }}
                  >
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'flex-start',
                      marginBottom: '8px'
                    }}>
                      <div style={{ flex: 1 }}>
                        <div style={{
                          fontWeight: 600,
                          fontSize: '14px',
                          color: '#002329',
                          marginBottom: '4px'
                        }}>
                          {set.name}
                        </div>
                        <div style={{
                          fontSize: '12px',
                          color: '#666',
                          marginBottom: '4px'
                        }}>
                          {set.mappings?.length || 0} mapping{set.mappings?.length !== 1 ? 's' : ''}
                        </div>
                        {set.sourceObject && set.targetObject && (
                          <div style={{
                            fontSize: '11px',
                            color: '#999',
                            marginTop: '4px'
                          }}>
                            Source: {set.sourceObject} → Target: {set.targetObject}
                          </div>
                        )}
                        {set.createdAt && (
                          <div style={{
                            fontSize: '11px',
                            color: '#999',
                            marginTop: '2px'
                          }}>
                            Created: {new Date(set.createdAt).toLocaleDateString()}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
              <button
                onClick={() => {
                  setShowLoadSetModal(false);
                }}
                style={{
                  padding: '8px 16px',
                  backgroundColor: '#f5f5f5',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontFamily: 'Poppins',
                  fontWeight: 500
                }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Transformation Help Modal */}
      {showTransformationHelpModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }}>
          <div style={{
            backgroundColor: '#fff',
            padding: '24px',
            borderRadius: '8px',
            width: '90%',
            maxWidth: '800px',
            maxHeight: '85vh',
            overflow: 'auto',
            fontFamily: 'Poppins'
          }}>
            <h2 style={{ marginBottom: '20px', fontSize: '20px', fontWeight: 600, color: '#002329' }}>
              Transformation Types Guide
            </h2>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {[
                { name: 'Copy (Direct)', desc: 'Directly copies the source field value to the target field without any modification.', example: 'Source: "John" → Target: "John"' },
                { name: 'Uppercase', desc: 'Converts all text to uppercase letters.', example: 'Source: "john doe" → Target: "JOHN DOE"' },
                { name: 'Lowercase', desc: 'Converts all text to lowercase letters.', example: 'Source: "JOHN DOE" → Target: "john doe"' },
                { name: 'Text Replace', desc: 'Finds and replaces specific text patterns. Supports case-sensitive and regex mode.', example: 'Source: "john@old.com", Find: "old", Replace: "new" → Target: "john@new.com"' },
                { name: 'Concatenate', desc: 'Combines multiple source fields into one target field with a separator.', example: 'Fields: "John", "Doe", Separator: " " → Target: "John Doe"' },
                { name: 'Formula', desc: 'Calculates values using expressions with field references like {FieldName}.', example: 'Formula: "{Amount} * 1.1" → Adds 10% to Amount' },
                { name: 'Date Format', desc: 'Formats date values to a specific format (YYYY-MM-DD, MM/DD/YYYY, etc.).', example: 'Source: "2024-01-15" → Target: "15/01/2024"' },
                { name: 'Number Format', desc: 'Formats numbers with specified decimals and separators.', example: 'Source: "1234.5" → Target: "1,234.50" (2 decimals)' },
                { name: 'Value Map', desc: 'Maps specific input values to different output values.', example: 'Map: "Yes"→true, "No"→false. Source: "Yes" → Target: true' },
                { name: 'Switch/Case', desc: 'Maps multiple input values to different outputs with a default fallback.', example: 'Cases: "High"→"P1", "Medium"→"P2", Default: "P3"' },
                { name: 'Conditional', desc: 'Applies if-then-else logic with multiple conditions (AND/OR). Supports operators like equals, contains, isEmpty, startsWith, etc.', example: 'If Status = "Active" AND Amount > 1000, Then: "Premium", Else: "Standard"' },
                { name: 'Default Value', desc: 'Uses a default value when the source field is empty or null.', example: 'Source: "" (empty), Default: "N/A" → Target: "N/A"' },
                { name: 'Type Conversion', desc: 'Converts data from one type to another (string, number, boolean, date).', example: 'Source: "123" (text) → Target: 123 (number)' },
                { name: 'Format Validation', desc: 'Validates data against specific formats (email, phone, URL, etc.). Can use default value or skip on invalid.', example: 'Validates: "john@example.com" (valid email) → passes; "invalid" → uses default' },
                { name: 'Remove Special Characters', desc: 'Cleans text by removing special characters, keeping only letters/numbers, or specific patterns.', example: 'Source: "Phone: (123) 456-7890" → Target: "1234567890"' }
              ].map((transform, idx) => (
                <div key={idx} style={{
                  padding: '14px',
                  backgroundColor: '#f9fafb',
                  borderLeft: '4px solid #08979C',
                  borderRadius: '4px'
                }}>
                  <h3 style={{ 
                    fontSize: '14px', 
                    fontWeight: 600, 
                    color: '#002329', 
                    marginBottom: '6px' 
                  }}>
                    {transform.name}
                  </h3>
                  <p style={{ 
                    fontSize: '12px', 
                    color: '#4b5563', 
                    marginBottom: '6px', 
                    lineHeight: '1.5' 
                  }}>
                    {transform.desc}
                  </p>
                  <div style={{ 
                    fontSize: '11px', 
                    color: '#059669', 
                    backgroundColor: '#d1fae5', 
                    padding: '6px 8px', 
                    borderRadius: '3px',
                    fontFamily: 'monospace'
                  }}>
                    <strong>Example:</strong> {transform.example}
                  </div>
                </div>
              ))}
            </div>
            
            <div style={{ marginTop: '20px', display: 'flex', justifyContent: 'flex-end' }}>
              <button
                onClick={() => setShowTransformationHelpModal(false)}
                style={{
                  padding: '10px 20px',
                  backgroundColor: '#08979C',
                  color: '#fff',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: 500
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default UpdateObjectFields;

